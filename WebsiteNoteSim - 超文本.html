<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebsiteNoteSim - 现代文本</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        :root {
            --bg-color: #1a1f25;
            --text-color: #ffffff;
            --secondary-bg: rgba(255,255,255,0.1);
            --border-color: rgba(255,255,255,0.2); /* 深色模式下的默认边框颜色 */
            --line-number-color: rgba(255,255,255,0.3);
            --line-number-bg: rgba(0,0,0,0.15);
            --line-number-border: rgba(255,255,255,0.1);
            --line-number-active: #4aa3ff;
            --search-bg: rgba(255,255,255,0.1);
            --search-border: rgba(255,255,255,0.2);
            --search-highlight: rgba(255,235,59,0.3);
            --text-secondary: rgba(255,255,255,0.6);
            --save-green: #28a7464f; /* 新增 --save-green 变量 */
            /* 添加滚动条颜色变量 */
            --scrollbar-track: rgba(255,255,255,0.05);
            --scrollbar-thumb: rgba(255,255,255,0.2);
            --scrollbar-thumb-hover: rgba(255,255,255,0.3);
        }

        [data-theme="light"] {
            --bg-color: #f8f9fa;
            --text-color: #2d3436;
            --secondary-bg: rgba(0,0,0,0.04);
            --border-color: rgba(0,0,0,0.12); /* 浅色模式下的默认边框颜色 */
            /* 新增浅色模式专用颜色 */
            --accent-blue: #3c3b3b;
            --hover-bg: rgba(25, 113, 194, 0.08);
            --active-bg: rgba(25, 113, 194, 0.15);
            --line-number-color: rgba(0,0,0,0.3);
            --line-number-bg: rgba(0,0,0,0.05);
            --line-number-border: rgba(0,0,0,0.1);
            --line-number-active: #1971c2;
            --search-bg: rgba(0,0,0,0.05);
            --search-highlight: rgba(255,235,59,0.5);
            --text-secondary: rgba(0,0,0,0.6);
            --scrollbar-track: rgba(0,0,0,0.05);
            --scrollbar-thumb: rgba(0,0,0,0.2);
            --scrollbar-thumb-hover: rgba(0,0,0,0.3);
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, var(--bg-color) 0%, var(--bg-color) 100%);
            padding: 20px;
            color: var(--text-color);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            height: calc(100vh - 40px);
            display: flex;
            flex-direction: row;
            border-radius: 20px;
            gap: 15px;
        }

        .menu-bar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px 15px 0 0;
            padding: 15px;
            display: flex;
            gap: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: none;
            justify-content: space-between;
        }

        .menu-item {
            color: #fff;
            text-decoration: none;
            font-size: 14px;
            padding: 5px 10px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .editor-container {
            flex: 1;
            background: var(--secondary-bg);
            backdrop-filter: blur(10px);
            border-radius: 0 0 15px 15px;
            padding: 20px 30px;
            border: 1px solid var(--border-color);
            position: relative;
            --editor-font-size: 16px;
            --editor-font-family: system-ui;
            /* 添加底部内边距为编码栏留出空间 */
            padding-bottom: 50px; 
        }

        #editor {
            width: 100%;
            height: 100%;
            background: transparent;
            border: none;
            color: #fff;
            font-size: var(--editor-font-size) !important;
            font-family: var(--editor-font-family), monospace !important;
            line-height: 1.7;
            resize: none;
            outline: none;
            padding: 0 15px;
        }

        #editor::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .status-bar {
            position: absolute;
            bottom: 20px;
            right: 20px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            background: rgba(0, 0, 0, 0.2);
            padding: 5px 10px;
            border-radius: 8px;
            display: none;
        }

        .button {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        @media (max-width: 768px) {
            .container {
                height: calc(100vh - 20px);
                border-radius: 15px;
                display: flex; /* 确保container是flex容器 */
            }

            .menu-bar {
                flex-wrap: wrap;
            }

            .sidebar {
                width: 180px;
                display: none; /* 默认隐藏左侧边栏 */
            }

            .toolbar {
                display: none; /* 默认隐藏右侧工具栏 */
                transition: all 0.3s ease; /* 添加过渡效果 */
                opacity: 0; /* 初始透明度为0 */
                width: 220px; /* 确保宽度 */
            }

            /* 展开状态下显示并恢复透明度 */
            .container.toolbar-expanded .toolbar {
                display: flex;
                opacity: 1;
            }

            #globalUserInfo {
                top: 10px;
                left: 10px;
                transform: scale(0.8);
                transform-origin: left top;
            }

            .container {
                margin-top: 60px !important;
            }

            /* 新增展开状态的样式 */
            .container.sidebar-expanded .sidebar {
                display: block;
            }

            .container.toolbar-expanded .toolbar {
                display: flex;
            }

            /* 手机模式下，未展开边栏时显示toggle bar */
            .container:not(.sidebar-expanded) #sidebarToggleBar {
                display: block;
            }

            .container:not(.toolbar-expanded) #toolbarToggleBar {
                display: block;
            }

            /* 手机模式下，editor区域占据剩余空间 */
            .editor-container {
                flex: 1;
            }

            /* 调整展开条的位置 */
            #sidebarToggleBar {
                position: absolute;
                left: 0;
                top: 50%;
                transform: translateY(-50%);
                z-index: 2; /* 确保在editor之上 */
                width: 6px; /* 设置宽度 */
                padding: 5px 0; /* 调整padding */
                text-align: center; /* 文本居中 */
                border-radius: 5px 0 0 5px; /* 调整圆角 */
                font-size: 12px; /* 调整字体大小 */
            }

            #toolbarToggleBar {
                position: absolute;
                right: 0;
                top: 50%;
                transform: translateY(-50%);
                z-index: 2; /* 确保在editor之上 */
                width: 6px; /* 设置宽度 */
                padding: 5px 0; /* 调整padding */
                text-align: center; /* 文本居中 */
                border-radius: 0 5px 5px 0; /* 调整圆角 */
                font-size: 12px; /* 调整字体大小 */
            }
        }

        /* 新增左侧边栏样式 */
        .sidebar {
            width: 200px;
            background: rgba(0, 0, 0, 0.2);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px;
            overflow-y: auto;
            border-radius: 15px 0 0 15px;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            color: rgba(255, 255, 255, 0.8);
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .file-item.active {
            background: rgba(74, 144, 226, 0.3);
            color: #fff;
        }

        /* 新增格式选择弹窗样式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.1) !important;
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            padding: 25px;
            border-radius: 15px;
            width: 300px;
        }

        .format-option {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .format-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .logout-button {
            background: rgba(255, 75, 75, 0.2);
            border-color: rgba(255, 75, 75, 0.3);
        }

        .logout-button:hover {
            background: rgba(255, 75, 75, 0.3);
        }

        /* 新增错误提示样式 */
        .error-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff4757;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            display: none;
            z-index: 1000;
        }

        /* 新增开关样式 */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255,255,255,0.2);
            transition: .4s;
            border-radius: 12px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #4CAF50;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .toggle-label {
            color: white;
            font-size: 14px;
            margin-right: 10px;
        }

        /* 在原有开关样式下新增 */
        .ide-toggle {
            margin-left: 15px;
        }

        /* 新增右侧工具栏样式 */
        .toolbar {
            width: 220px;
            background: rgba(0, 0, 0, 0.2);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 0 15px 15px 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: calc(100vh - 40px);
            overflow-y: auto;
        }

        .toolbar-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
        }

        .toolbar-title {
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* 新增右键菜单样式 */
        .context-menu {
            position: absolute;
            background: rgba(255,255,255,0.1) !important;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            backdrop-filter: blur(20px) saturate(180%);
        }

        .menu-item {
            color: rgba(255,255,255,0.8);
            padding: 8px 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .menu-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .menu-divider {
            border-top: 1px solid rgba(255,255,255,0.1);
            margin: 4px 0;
        }

        /* 在工具栏添加主题切换 */
        .toolbar-section:last-child {
            text-align: right;
        }

        .theme-select {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            cursor: pointer;
        }

        .user-info {
            transition: all 0.3s ease;
            padding: 5px 10px;
            border-radius: 8px;
        }

        .user-info:hover {
            background: rgba(255,255,255,0.1);
        }

        #avatarPath {
            margin-top: 8px;
            border-radius: 6px;
            font-size: 13px;
        }

        .file-item.folder {
            color: #4aa3ff;
            font-weight: 500;
        }

        .file-item.folder:hover {
            background: rgba(74, 163, 255, 0.1);
        }

        /* 浅色模式覆盖样式 */
        [data-theme="light"] {
            .sidebar {
                background: rgba(255,255,255,0.7);
                border-right-color: rgba(0,0,0,0.08);
            }

            .file-item:hover {
                background: var(--hover-bg);
            }

            .file-item.active {
                background: var(--active-bg);
                color: var(--accent-blue);
            }

            .button {
                background: rgba(255,255,255,0.9);
                color: var(--text-color);
                border-color: var(--border-color);
            }

            .button:hover {
                background: rgba(255,255,255,0.95);
            }

            .modal-content,
            .context-menu,
            .search-panel {
                background: rgba(255,255,255,0.9) !important;
                border-color: rgba(0,0,0,0.08);
            }

            .menu-item {
                color: var(--text-color);
            }

            .menu-item:hover {
                background: var(--hover-bg);
            }

            .toggle-slider {
                background-color: rgba(0,0,0,0.1);
            }

            .file-item.folder {
                color: var(--accent-blue);
            }

            .error-toast {
                background: #ff6b6b;
                color: white;
            }

            #editor {
                color: var(--text-color);
            }

            #editor::placeholder {
                color: rgba(45, 52, 54, 0.4);
            }

            #lineNumbers {
                color: rgba(0,0,0,0.3);
            }
        }

        #lineNumbers div {
            position: relative;
            padding-right: 10px;
            transition: color 0.2s ease;
        }

        #lineNumbers div::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 2px;
            height: 60%;
            background: var(--line-number-border);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        #lineNumbers div:hover {
            color: var(--line-number-active);
        }

        #lineNumbers div.active-line {
            color: var(--line-number-active);
            font-weight: 500;
        }

        #lineNumbers div.active-line::after {
            opacity: 1;
        }

        .highlight {
            background: var(--search-highlight);
            border: 1px solid rgba(255,235,59,0.5);
            border-radius: 3px;
        }

        .current-highlight {
            background: rgba(255,235,59,0.6);
            border-color: rgba(255,235,59,0.8);
        }

        /* 新增可拖动搜索面板样式 */
        .search-panel {
            position: fixed;
            top: 100px;
            left: 100px;
            min-width: 400px;
            width: max-content;
            background: rgba(255,255,255,0.1) !important;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            z-index: 1000;
            cursor: move;
            user-select: none;
            backdrop-filter: blur(20px) saturate(180%);
        }

        .search-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .search-panel-content {
            min-width: 380px;
        }

        .search-panel-close {
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.2s ease;
        }

        .search-panel-close:hover {
            background: rgba(255,255,255,0.1);
        }

        /* 新增字体控制样式 */
        .font-control {
            width: 100%;
            padding: 6px 8px;
            border-radius: 6px;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            font-size: 13px;
            cursor: pointer;
        }

        /* 浅色模式适配 */
        [data-theme="light"] .font-control {
            background: rgba(255,255,255,0.9);
            border-color: var(--border-color);
        }

        .modal-content::-webkit-scrollbar {
            width: 8px;
            background: var(--secondary-bg);
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: var(--accent-blue);
            border-radius: 4px;
        }

        .button.danger {
            background: #dc3545;
            border-color: #dc3545;
        }

        .button.danger:hover {
            background: #bb2d3b;
        }

        /* 新增统一弹窗模糊效果 */
        .context-menu,
        .search-panel,
        #fileContextMenu {
            backdrop-filter: blur(20px) saturate(180%);
            background: rgba(255,255,255,0.1) !important;
            border: 1px solid rgba(255,255,255,0.15);
        }

        /* 浅色模式适配 */
        [data-theme="light"] {
            .modal-content,
            .context-menu,
            .search-panel {
                background: rgba(255,255,255,0.9) !important;
                border-color: rgba(0,0,0,0.08);
            }
        }

        /* 左下角按钮通用样式 */
        .bottom-left-button_color {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 10px 15px;
            border-radius: 8px;
            /* background-image: linear-gradient(to right, #ff5733, #ffcc33, #aaff33, #33ff57, #33ccff, #5733ff, #cc33ff); !* 原有彩色渐变 *! */
            background-image: linear-gradient(to right,
                rgba(255, 88, 51, 0.664),    /* 半透明红色 */
                rgba(255, 204, 51, 0.664),   /* 半透明橙色 */
                rgba(170, 255, 51, 0.664),   /* 半透明黄色 */
                rgba(51, 255, 88, 0.664),    /* 半透明绿色 */
                rgba(51, 204, 255, 0.664),   /* 半透明青色 */
                rgba(88, 51, 255, 0.664),    /* 半透明蓝色 */
                rgba(204, 51, 255, 0.664)    /* 半透明紫色 */
            );
            color: var(--text-color);
            /* border: none; !*  移除 border 属性，注释掉 *! */
            border: 1px solid rgb(255, 255, 255); /* 修改边框颜色为白色 */
            cursor: pointer;
            transition: background-color 0.2s ease;
            z-index: 1000;
            background-size: 200% 100%;
            animation: gradientAnimation 5s linear infinite;
            opacity: 0.7; /* 设置整体透明度为 0.8 (可以调整) */
            backdrop-filter: blur(50px); /*  可以添加轻微的模糊效果，增强半透明感 */
        }

        .bottom-left-button_color:hover {
            filter: brightness(1.1);
            opacity: 1; /* 鼠标悬停时恢复不透明 */
        }

        @keyframes gradientAnimation {
            0% {
                background-position: 0% 50%;
            }
            100% {
                background-position: 100% 50%;
            }
        }

        .save-btn {
            background: var(--save-green); /* 使用 --save-green 变量 */
            border-color: var(--save-green); /* 使用 --save-green 变量 */
            color: white;
        }

        /* 新增导入按钮样式 */
        .import-btn {
            background: rgba(74, 144, 226, 0.3);
            border-color: rgba(74, 144, 226, 0.4);
        }
        .import-btn:hover {
            background: rgba(74, 144, 226, 0.4);
        }

        .new-btn {
            background: rgba(255, 193, 7, 0.3); /* 黄色背景 */
            border-color: rgba(255, 193, 7, 0.5); /* 黄色边框 */
        }
        
        .new-btn:hover {
            background: rgba(255, 193, 7, 0.5); /* 悬停时更深的黄色 */
        }

        /* 信息卡片样式 */
.file-info-card {
    position: absolute;
    right: 15px;
    top: 400px;
    width: 220px;
    background: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 15px;
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    z-index: 2;
}

.card-header {
    font-weight: 600;
    margin-bottom: 12px;
    color: var(--text-color);
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 8px;
}

.info-item {
    display: flex;
    justify-content: space-between;
    margin: 8px 0;
    font-size: 14px;
}

.info-item label {
    color: var(--text-secondary);
    margin-right: 10px;
}

.info-item span {
    color: var(--text-color);
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* 完整信息窗口样式 */
.info-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-top: 20px;
}

.info-grid .info-row {
    display: flex;
    justify-content: space-between;
    padding: 8px;
    background: rgba(255,255,255,0.05);
    border-radius: 6px;
}

[data-theme="light"] .info-grid .info-row {
    background: rgba(0,0,0,0.03);
}

/* 新增编码栏样式 */
.encoding-bar {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 30px;
    background: rgba(0, 0, 0, 0.2);
    border-top: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    padding: 0 15px;
    font-size: 12px;
    color: var(--text-secondary);
    gap: 20px;
}

.encoding-item {
        display: flex;
        align-items: center;
                        gap: 8px;
}

.encoding-select {
    background: transparent;
    border: none;
                              color: var(--text-color);
                            font-size: 12px;
    padding: 2px 5px;
    border-radius: 4px;
    cursor: pointer;
}

.encoding-select:hover {
                background: rgba(255,255,255,0.1);
    }

    /* 新增视频背景样式 */
    #bgVideo {
        object-fit: cover;
    }

    /* 调整现有背景样式 */
    body {
        background-blend-mode: multiply;
        transition: background 0.3s ease;
    }

    /* 全局滚动条样式 */
    ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
        background-color: transparent;
    }

    ::-webkit-scrollbar-track {
        background: var(--scrollbar-track);
    border-radius: 8px;
        margin: 4px;
    }

    ::-webkit-scrollbar-thumb {
        background: var(--scrollbar-thumb);
    border-radius: 8px;
        border: 2px solid transparent;
        background-clip: content-box;
        transition: all 0.3s ease;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--scrollbar-thumb-hover);
        transform: scale(1.1);
    }

    ::-webkit-scrollbar-corner {
        background: transparent;
    }

    /* 编辑器区域特殊滚动条 */
    .editor-container ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }

    .editor-container ::-webkit-scrollbar-thumb {
        background: linear-gradient(45deg, 
            rgba(74,163,255,0.6),
            rgba(170,255,51,0.6),
            rgba(255,193,7,0.6)
        );
        border-radius: 3px;
    }

    /* 侧边栏滚动条美化 */
    .sidebar ::-webkit-scrollbar {
        width: 6px;
    }

    .sidebar ::-webkit-scrollbar-thumb {
        background: var(--line-number-active);
    }

#sideToolbar2 {
    position: fixed;
    left: 180px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    flex-direction: column;
    gap: 10px;
    background: rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(10px);
    padding: 10px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 9999;
}

#sideToolbar {
    top: 60%; /* 原为50% */
}


</style>
</head>
<body>
<!-- 在body开头添加垂直按钮栏 -->
<div id="sideToolbar" style="
    position: fixed;
    left: 10px;
    top: 0;
    transform: translateY(-50%);
    display: flex;
    flex-direction: column;
    gap: 10px;
    background: rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(10px);
    padding: 10px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 2;">

    <button class="tool-button" style="
                background-image: linear-gradient(to right,
                rgba(255, 88, 51, 0.1),
                rgba(255, 204, 51, 0.1),
                rgba(170, 255, 51, 0.1),
                rgba(51, 255, 88, 0.1),
                rgba(51, 204, 255, 0.1),
                rgba(88, 51, 255, 0.1),
                rgba(204, 51, 255, 0.1)
            );
            color: var(--text-color);
        " onclick="showAIPanel()" title="AI助手">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
            <path d="M22 21c-2.5 2.5-5 2.5-7.5 0-2.5 2.5-5 2.5-7.5 0"></path>
        </svg>
    </button>

    <!-- 代码片段库按钮 -->
    <button class="tool-button" onclick="showSnippetsModal()" title="代码片段库">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
                </svg>
            </button>
    
    <!-- Markdown预览按钮 -->
    <button class="tool-button" onclick="showMarkdownPreview()" title="Markdown预览">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <line x1="10" y1="9" x2="8" y2="9"></line>
                </svg>
            </button>
    
    <!-- 文件统计按钮 -->
    <button class="tool-button" onclick="showFileStats()" title="文件统计">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 20V10M12 20V4M6 20v-6"></path>
                </svg>
            </button>
            <div id="sideToolbar">
                <!-- 新增Unicode按钮 -->
                <button class="tool-button" onclick="showUnicodePanel()" title="Unicode查看器">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M7 8a5 5 0 1 0 10 0A5 5 0 0 0 7 8z"></path>
                        <path d="M17 14.7A7 7 0 0 0 7 14.7M7 14.7l5 5.3m-5-5.3l5 5.3"></path>
                    </svg>
                </button>
            </div>

            <!-- 在sideToolbar中添加插件按钮 -->
<button class="tool-button" id="pluginBtn" title="插件中心">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
        <circle cx="12" cy="7" r="4"></circle>
    </svg>
</button>

<!-- 插件加载状态提示 -->
<div id="pluginStatus" class="status-bar" style="display:none; left:20px;"></div>

<!-- 插件菜单容器 -->
<div id="pluginMenu" class="plugin-menu">
    <div class="plugin-header">
        <h4>已加载插件</h4>
        <button class="reload-btn" title="重新扫描">
            <svg width="16" height="16" viewBox="0 0 24 24"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
        </button>
    </div>
    <div id="pluginList" class="plugin-list"></div>
</div>

<div id="sideToolbar">
    <!-- 原有按钮保持不变 -->
    <button class="tool-button" onclick="showDevToolsAuth()" title="DevTools++">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 1 0 1.4l-5.4 5.4a5 5 0 0 1-7.1-7.1l5.4-5.4a1 1 0 0 1 1.4 0l1.6 1.6a1 1 0 0 0 1.4 0l3.2-3.2a3.5 3.5 0 0 1 4.9 4.9l-3.2 3.2a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 1 0 1.4L14 15.6a5 5 0 0 1-7.1-7.1l1.6-1.6"></path>
        </svg>
    </button>
</div>

<button class="tool-button" onclick="toggleHexPreview()" title="Hex/Dec/Bin 预览">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M2 12h2M12 2v2M20 12h2M12 20v2M5.6 5.6l1.4 1.4M18.4 5.6l-1.4 1.4M5.6 18.4l1.4-1.4M18.4 18.4l-1.4-1.4"/>
        <circle cx="12" cy="12" r="2"/>
    </svg>
</button>

<button class="tool-button" onclick="toggleFutureNotepad()" title="FutureNotePad">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
    </svg>
</button>
<div id="sideToolbar2">
        <!-- 新增格式按钮 -->
        <button class="tool-button" title="粗体" onclick="formatSelection('bold')">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6zM6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"/>
            </svg>
        </button>
        
        <button class="tool-button" title="斜体" onclick="formatSelection('italic')">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M19 4h-9M14 19H5M15 4L9 20"/>
            </svg>
        </button>
        
        <button class="tool-button" title="下划线" onclick="formatSelection('underline')">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M6 3v7a6 6 0 0 0 6 6 6 6 0 0 0 6-6V3M4 21h16"/>
            </svg>
        </button>
        
        <button class="tool-button" title="删除线" onclick="formatSelection('strikethrough')">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M16 12H8M21 12H3M10 7l-3 5h10l-3-5"/>
            </svg>
        </button>
        
        <button class="tool-button" title="标题1" onclick="applyHeading(1)">
            <span style="font-weight: 700;font-size: 18px">H1</span>
        </button>
        
        <button class="tool-button" title="标题2" onclick="applyHeading(2)">
            <span style="font-weight: 600;font-size: 16px">H2</span>
        </button>
        
        <button class="tool-button" title="标题3" onclick="applyHeading(3)">
            <span style="font-weight: 500;font-size: 14px">H3</span>
        </button>
    </div>

<style>
    /* DevTools 样式 */
.dev-tools-panel {
    position: fixed;
    top: 50px;
    left: 50px;
    right: 50px;
    bottom: 50px;
    background: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    display: none;
    flex-direction: column;
    z-index: 2000;
    box-shadow: 0 12px 24px rgba(0,0,0,0.2);
    backdrop-filter: blur(8px); /*  可以添加轻微的模糊效果，增强半透明感 */
}

.dev-tools-header {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    border-bottom: 1px solid var(--border-color);
}

.dev-tools-tabs {
    display: flex;
    gap: 10px;
}

.tab-btn {
    padding: 6px 12px;
    border-radius: 4px;
    background: var(--secondary-bg);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    cursor: pointer;
}

.tab-btn.active {
    background: rgba(74, 144, 226, 0.3);
}

.dev-tools-body {
    display: flex;
    flex: 1;
    overflow: hidden;
}

.dev-tools-sidebar {
    width: 300px;
    border-right: 1px solid var(--border-color);
    padding: 10px;
    overflow-y: auto;
}

.dev-tools-main {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
}

.element-tree {
    margin-top: 10px;
}

.element-node {
    padding: 4px;
    cursor: pointer;
    border-radius: 4px;
}

.element-node:hover {
    background: rgba(255, 255, 255, 0.233);
}

.css-properties {
    display: grid;
    grid-template-columns: 1fr 2fr auto;
    gap: 8px;
    align-items: center;
}

.css-property {
    display: contents;
}

.css-property input {
    background: var(--secondary-bg);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    padding: 4px;
    border-radius: 4px;
}

.inspect-highlight {
    outline: 2px solid #ff4444;
    transition: outline 0.2s;
}

.command-input {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
}

.command-input input {
    flex: 1;
    padding: 6px;
    border-radius: 4px;
    border: 1px solid var(--border-color);
    background: var(--secondary-bg);
    color: var(--text-color);
}

    /* 用户添加的标题样式 */
.user-heading {
    margin: 1em 0;
    padding: 0.5em 1em;
    background: rgba(74, 144, 226, 0.1);
    border-left: 4px solid #4a90e2;
}

.user-heading h1 {
    font-size: 2em;
    font-weight: 700;
}

.user-heading h2 {
    font-size: 1.5em;
    font-weight: 600;
}

.user-heading h3 {
    font-size: 1.2em;
    font-weight: 500;
}

/* 浅色主题适配 */
[data-theme="light"] .user-heading {
    background: rgba(74, 144, 226, 0.05);
    border-left-color: #1971c2;
}

/* 进制预览面板 */
.hex-preview-panel {
    position: fixed;
    top: 150px;
    left: 100px;
    min-width: 320px;
    background: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    z-index: 1000;
    backdrop-filter: blur(20px);
    cursor: move;
    user-select: none;
}

.hex-preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-color);
}

.hex-view {
    font-family: monospace;
    white-space: pre-wrap;
    max-height: 300px;
    overflow-y: auto;
    background: rgba(0,0,0,0.1);
    padding: 10px;
    border-radius: 6px;
}

.hex-row {
    display: flex;
    gap: 20px;
    margin-bottom: 8px;
}

.hex-label {
    color: var(--text-secondary);
    min-width: 60px;
}

.hex-value {
    color: var(--text-color);
    word-break: break-all;
}

/* 插件菜单样式 */
.plugin-menu {
    position: fixed;
    left: 60px;
    top: 50%;
    transform: translateY(-50%);
    background: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
    width: 200px;
    max-height: 70vh;
    display: none;
}

.plugin-item {
    padding: 8px;
    margin: 4px 0;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
}

.plugin-item:hover {
    background: rgba(74, 144, 226, 0.1);
}

.plugin-icon {
    width: 20px;
    height: 20px;
    margin-right: 8px;
}

.reload-btn {
    background: none;
    border: none;
    padding: 4px;
}
</style>

<script>
// 插件系统核心逻辑
class PluginSystem {
    constructor() {
        this.dirHandle = null;
        this.plugins = new Map();
        this.init();
    }

    async init() {
        // 尝试读取保存的目录权限
        const handle = await this.getPersistedDir();
        if (handle) {
            this.dirHandle = handle;
            this.scanPlugins();
        }
        
        // 绑定事件
        document.getElementById('pluginBtn').addEventListener('click', () => 
            this.toggleMenu());
        document.querySelector('.reload-btn').addEventListener('click', () => 
            this.scanPlugins());
    }

    async requestPermission() {
        try {
            this.dirHandle = await window.showDirectoryPicker({
                mode: 'read',
                startIn: 'documents'
            });
            
            // 验证是否获得读取权限
            if (await this.dirHandle.queryPermission({ mode: 'read' }) === 'granted') {
                this.persistDirHandle();
                this.scanPlugins();
            }
        } catch (error) {
            this.showStatus('用户取消了权限请求', 'error');
        }
    }

    async getPersistedDir() {
        // 检查存储的ID是否存在
        const id = localStorage.getItem('pluginDirId');
        if (!id) return null;

        try {
            return await navigator.storage.getDirectory(id);
        } catch {
            localStorage.removeItem('pluginDirId');
            return null;
        }
    }

    async persistDirHandle() {
        // 存储目录引用
        if (this.dirHandle && 'id' in this.dirHandle) {
            localStorage.setItem('pluginDirId', this.dirHandle.id);
        }
    }

    async scanPlugins() {
        if (!this.dirHandle) {
            this.showStatus('请先选择插件目录', 'warning');
            return this.requestPermission();
        }

        this.showStatus('扫描插件中...');
        
        try {
            const plugins = [];
            for await (const entry of this.dirHandle.values()) {
                if (entry.kind === 'file' && entry.name.endsWith('.html')) {
                    const file = await entry.getFile();
                    const content = await this.validatePlugin(await file.text());
                    if (content) {
                        plugins.push({
                            name: entry.name,
                            content,
                            lastModified: file.lastModified
                        });
                    }
                }
            }
            
            this.updatePluginList(plugins);
            this.showStatus(`找到 ${plugins.length} 个插件`, 'success');
        } catch (error) {
            this.showStatus('扫描失败: ' + error.message, 'error');
        }
    }

    async validatePlugin(content) {
        // 基本安全验证
        const dangerousTags = ['script', 'iframe', 'link'];
        const sanitized = new DOMParser().parseFromString(content, 'text/html');
        
        dangerousTags.forEach(tag => {
            sanitized.querySelectorAll(tag).forEach(el => el.remove());
        });

        // 移除所有事件处理器
        sanitized.body.querySelectorAll('*').forEach(el => {
            el.getAttributeNames().forEach(attr => {
                if (attr.startsWith('on')) el.removeAttribute(attr);
            });
        });

        return sanitized.body.innerHTML;
    }

    updatePluginList(plugins) {
        const container = document.getElementById('pluginList');
        container.innerHTML = '';
        
        plugins.forEach(plugin => {
            const div = document.createElement('div');
            div.className = 'plugin-item';
            div.innerHTML = `
                <svg class="plugin-icon" viewBox="0 0 24 24">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <path d="M14 2v6h6"/>
                </svg>
                <span>${plugin.name.replace('.html', '')}</span>
            `;
            
            div.addEventListener('click', () => 
                this.loadPlugin(plugin.content));
            container.appendChild(div);
        });
    }

    loadPlugin(content) {
        const win = window.open('', '_blank');
        win.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>插件视图</title>
                <meta charset="UTF-8">
                <style>
                    body { margin: 0; padding: 10px; }
                    ${this.getSafetyCSS()}
                </style>
            </head>
            <body>${content}</body>
            </html>
        `);
    }

    getSafetyCSS() {
        return `
            script, iframe, link {
                display: none !important;
            }
            * {
                user-select: none;
                -webkit-user-drag: none;
            }
        `;
    }

    toggleMenu() {
        const menu = document.getElementById('pluginMenu');
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }

    showStatus(message, type = 'info') {
        const status = document.getElementById('pluginStatus');
        status.textContent = message;
        status.className = `status-bar ${type}`;
        status.style.display = 'block';
        setTimeout(() => status.style.display = 'none', 3000);
    }
}

// 初始化插件系统
window.plugins = new PluginSystem();
</script>
    <!-- 在sideToolbar内添加按钮 -->
<div id="sideToolbar">
    <!-- 原有按钮保持不变 -->
    <button class="tool-button" onclick="showFileInfoModal()" title="完整信息">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
    </button>

    <!-- 新增信息窗口模态框 -->
    <div class="modal-overlay" id="fileInfoModal">
        <div class="modal-content" style="width: 500px;">
            <h3>完整文件信息</h3>
            <div class="info-grid" id="fileInfoContent"></div>
        </div>
    </div>
</div>    
        </div>
<!-- 添加按钮样式 -->
<style>
#unicodeGrid {
    display: grid;
    grid-template-columns: repeat(16, 1fr);
    gap: 1px;
    max-height: 60vh;
    overflow-y: auto;
    background: var(--border-color);
    padding: 2px;
    border-radius: 8px;
}

#unicodeGrid div {
    background: var(--secondary-bg);
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 14px;
}

#unicodeGrid div:hover {
    background: rgba(74, 144, 226, 0.3);
    transform: scale(1.2);
    z-index: 1;
}

    .tool-button {
        width: 36px;
        height: 36px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: var(--text-color);
        display: flex;
        align-items: center;
        justify-content: center;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
    .tool-button:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
    }
    
    .tool-button:active {
        transform: translateY(0);
    }
    
    /* 响应式调整 */
    @media (max-width: 768px) {
        #sideToolbar {
            top: auto;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            flex-direction: row;
            padding: 8px;
        }
    }
    
    /* 深色/浅色模式适配 */
    [data-theme="light"] .tool-button {
        background: rgba(0, 0, 0, 0.05);
        border-color: rgba(0, 0, 0, 0.1);
    }
    
    [data-theme="light"] .tool-button:hover {
        background: rgba(0, 0, 0, 0.1);
    }

    /* 添加新样式 */
.conversion-warning {
    color: #ff6b6b;
    font-size: 12px;
    margin-top: 8px;
    display: none;
}

.number-input {
    width: 100%;
    padding: 6px;
    border-radius: 4px;
    border: 1px solid var(--border-color);
    background: var(--secondary-bg);
    color: var(--text-color);
    margin-bottom: 8px;
}


</style>

<script>
    // 修改DOMContentLoaded事件处理函数
    // 删除原来添加到菜单栏的代码，不再向菜单栏添加这些按钮
    document.addEventListener('DOMContentLoaded', function() {
        // 原来向菜单栏添加按钮的代码被删除
        
        // 只保留初始化绘图工具的代码
        initDrawingTools();
        
        // 确保侧边工具栏在移动设备上正确显示
        window.addEventListener('resize', adjustSideToolbar);
        adjustSideToolbar();
    });
    
    // 添加调整侧边工具栏的函数
    function adjustSideToolbar() {
        const toolbar = document.getElementById('sideToolbar');
        if (!toolbar) return;
        
        if (window.innerWidth <= 768) {
            toolbar.style.top = 'auto';
            toolbar.style.bottom = '20px';
            toolbar.style.left = '50%';
            toolbar.style.transform = 'translateX(-50%)';
            toolbar.style.flexDirection = 'row';
        } else {
            toolbar.style.top = '50%';
            toolbar.style.bottom = 'auto';
            toolbar.style.left = '10px';
            toolbar.style.transform = 'translateY(-50%)';
            toolbar.style.flexDirection = 'column';
        }
    }
    
    // 在文档加载后自动调用，以确保工具栏正确显示
    document.addEventListener('DOMContentLoaded', adjustSideToolbar);
</script>

<!-- 新增固定定位的用户信息 -->
<div id="globalUserInfo" style="position: fixed; top: 20px; left: 20px; z-index: 1000; display: flex; align-items: center; gap: 10px;">
    <img id="userAvatar" src="./default-avatar.png"
         style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--border-color);">
    <span id="username" style="color: var(--text-color); font-size: 16px; font-weight: 500; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">LowHBV</span>
</div>

<!-- 修改后的新建文件弹窗 -->
<div class="modal-overlay" id="newFileModal">
    <div class="modal-content" style="width: 400px;">
        <h3 style="color: #fff; margin-bottom: 20px;">新建文件</h3>

        <!-- 文件名输入 -->
        <div style="margin-bottom: 20px;">
            <input type="text" id="newFileName"
                   style="width: 100%; padding: 8px; border-radius: 6px; 
                          border: 1px solid rgba(255,255,255,0.2); 
                          background: rgba(0,0,0,0.3); color: white;"
                   placeholder="输入文件名（无需扩展名）">
        </div>

        <!-- 密码输入 -->
        <div style="margin: 10px 0;">
            <input type="password" id="filePassword"
                style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--secondary-bg); color: var(--text-color);"
                placeholder="文件密码（可选）">
        </div>

        <!-- 新增设置区域 -->
        <div class="toolbar-section" style="margin-bottom: 15px;">
            <!-- 编码选择 -->
            <div class="toolbar-title">文本编码</div>
            <select class="font-control" id="newFileEncoding">
                <option value="UTF-8">UTF-8</option>
                <option value="GBK">GBK</option>
                <option value="BIG5">BIG5</option>
                <option value="ISO-8859-1">ISO-8859-1</option>
            </select>

            <!-- 行尾符选择 -->
            <div class="toolbar-title" style="margin-top: 10px;">行尾符</div>
            <select class="font-control" id="newFileLineEnding">
                <option value="CRLF">Windows (CRLF)</option>
                <option value="LF">Unix (LF)</option>
            </select>

            <!-- 加密选项 -->
            <div style="margin-top: 15px;">
                <label style="color: var(--text-color);">
                    <input type="checkbox" id="newFileEncrypt" 
                           style="margin-right: 8px;"
                           onchange="toggleEncryptField()">
                    启用加密
                </label>
            </div>

            <!-- 密码输入（默认隐藏） -->
            <div id="newFilePasswordField" style="display: none; margin-top: 10px;">
                <input type="password" id="newFilePassword"
                       style="width: 100%; padding: 8px; border-radius: 6px;
                              border: 1px solid var(--border-color);
                              background: var(--secondary-bg);
                              color: var(--text-color);"
                       placeholder="输入加密密码">
            </div>
        </div>

        <!-- 格式选择 -->
        <div class="toolbar-section" style="margin-bottom: 20px;">
            <div class="toolbar-title">选择格式</div>
            <!-- 新增自定义格式输入 -->
            <div style="margin: 10px 0;">
                <input type="text" id="customFormat"
                       style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white;"
                       placeholder="或输入自定义格式（如：js）">
            </div>
            <!-- 原有格式选项保持不变 -->
            <div class="format-option" data-format="txt">
                <span style="color: #fff;">文本文件 (.txt)</span>
            </div>
            <div class="format-option" data-format="html">
                <span style="color: #fff;">HTML 文件 (.html)</span>
            </div>
            <div class="format-option" data-format="md">
                <span style="color: #fff;">Markdown 文件 (.md)</span>
            </div>
            <div class="format-option" data-format="jpg">
                <span style="color: #fff;">绘图文件 (.jpg)</span>
            </div>
        </div>

        <div style="display: flex; gap: 10px;">
            <button class="button" onclick="createCustomFile()" style="flex:1;">创建</button>
            <button class="button" onclick="closeNewFileModal()" style="flex:1;">取消</button>
        </div>
    </div>
</div>

<script>
// 新增函数：切换密码输入框显示
function toggleEncryptField() {
    const encryptCheckbox = document.getElementById('newFileEncrypt');
    const passwordField = document.getElementById('newFilePasswordField');
    passwordField.style.display = encryptCheckbox.checked ? 'block' : 'none';
}

// 修改后的创建文件函数
async function createCustomFile() {
    const fileNameInput = document.getElementById('newFileName').value.trim();
    if (!fileNameInput) {
        showError('文件名不能为空');
        return;
    }

    // 获取所有新参数
    const encoding = document.getElementById('newFileEncoding').value;
    const lineEnding = document.getElementById('newFileLineEnding').value;
    const encrypt = document.getElementById('newFileEncrypt').checked;
    const password = encrypt ? document.getElementById('newFilePassword').value : '';

    // 处理自定义格式
    let finalFormat = selectedFormat;
    if(document.getElementById('customFormat').value.trim()) {
        finalFormat = document.getElementById('customFormat').value
            .replace(/[^a-z0-9]/gi, '')
            .toLowerCase();
    }

    // 自动添加扩展名
    let finalName = fileNameInput;
    if (!finalName.endsWith(`.${finalFormat}`)) {
        finalName += `.${finalFormat}`;
    }

    // 密码验证
    if (encrypt && !password) {
        showError('启用加密必须输入密码');
        return;
    }

    // 创建文件对象
    const newFile = {
        id: Date.now().toString(),
        name: finalName,
        content: "",
        format: finalFormat,
        encoding: encoding,
        lineEnding: lineEnding,
        history: [],
        passwordHash: encrypt ? await hashPassword(password) : null,
        security: {
            encrypted: encrypt,
            lastModified: new Date().toISOString()
        }
    };

    files.push(newFile);
    currentFile = newFile;
    localStorage.setItem('editorFiles', JSON.stringify(files));
    
    // 应用行尾符设置
    editor.value = editor.value.replace(/\n/g, lineEnding === 'CRLF' ? '\r\n' : '\n');
    
    initFileList();
    showStatus('已创建新文件');
    closeNewFileModal();
    logAction('CREATE', finalName);
}

// 在保存文件时处理编码和行尾符
function saveFile() {
    if (!currentFile) return;

    // 转换行尾符
    let content = editor.value;
    content = content.replace(/\r?\n/g, currentFile.lineEnding === 'CRLF' ? '\r\n' : '\n');

    // 编码转换（示例：UTF-8到其他编码）
    if (currentFile.encoding !== 'UTF-8') {
        const encoder = new TextEncoder(currentFile.encoding, { NONSTANDARD_allowLegacyEncoding: true });
        const decoder = new TextDecoder();
        const buffer = encoder.encode(content);
        content = decoder.decode(buffer, { stream: false });
    }

    currentFile.content = content;
    localStorage.setItem('editorFiles', JSON.stringify(files));
    showStatus('已保存');
}
</script>

<style>
/* 新增样式 */
.toolbar-section .toolbar-title {
    margin: 10px 0 5px;
    font-size: 13px;
    color: var(--text-secondary);
}

#newFilePasswordField {
    transition: all 0.3s ease;
}

.font-control {
    margin-bottom: 8px;
}
</style>

<!-- 新增导出菜单弹窗 -->
<div class="modal-overlay" id="exportModal">
    <div class="modal-content" style="width: 400px;">
        <h3 style="color: #fff; margin-bottom: 20px;">导出文件设置</h3>

        <!-- 文件名输入 -->
        <div style="margin-bottom: 20px;">
            <input type="text" id="exportFileName"
                   style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white;"
                   placeholder="输入文件名">
        </div>

        <!-- 格式选择 -->
        <div class="toolbar-section" style="margin-bottom: 20px;">
            <div class="toolbar-title">选择格式</div>
            <div class="format-option" data-format="current">
                <span style="color: #fff;">当前格式 (.${currentFile?.format})</span>
            </div>
            <div class="format-option" data-format="txt">
                <span style="color: #fff;">文本文件 (.txt)</span>
            </div>
            <div class="format-option" data-format="html">
                <span style="color: #fff;">HTML 文件 (.html)</span>
            </div>
            <div class="format-option" data-format="md">
                <span style="color: #fff;">Markdown 文件 (.md)</span>
            </div>
        </div>

        <div style="display: flex; gap: 10px;">
            <button class="button" onclick="handleExport()" style="flex:1;">导出</button>
            <button class="button" onclick="closeExportModal()" style="flex:1;">取消</button>
        </div>
    </div>
</div>

<!-- 新增新建文件夹弹窗 -->
<div class="modal-overlay" id="newFolderModal">
    <div class="modal-content" style="width: 400px;">
        <h3 style="color: var(--text-color); margin-bottom: 20px;">新建文件夹</h3>
        <div style="margin-bottom: 20px;">
            <input type="text" id="folderNameInput"
                   style="width: 100%; padding: 8px; border-radius: 6px;
                              border: 1px solid var(--border-color);
                              background: var(--secondary-bg);
                              color: var(--text-color);"
                   placeholder="输入文件夹名称"
                   onkeypress="if(event.keyCode === 13) confirmCreateFolder()">
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="button" onclick="confirmCreateFolder()" style="flex:1;">创建</button>
            <button class="button" onclick="closeNewFolderModal()" style="flex:1;">取消</button>
        </div>
    </div>
</div>

<!-- 修改导入模态框，添加"导入到列表"选项 -->
<div class="modal-overlay" id="importModal">
    <div class="modal-content" style="width: 400px;">
        <h3 style="color: var(--text-color); margin-bottom: 20px;">导入文件</h3>
        
        <div style="margin-bottom: 20px;">
            <!-- 隐藏原始文件输入 -->
            <input type="file" id="fileInput" style="display: none;">
            
            <!-- 添加自定义文件选择按钮和文件名显示区域 -->
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="button custom-file-button" onclick="triggerFileInput()" style="
                        background: linear-gradient(to right, rgba(74, 144, 226, 0.3), rgba(74, 144, 226, 0.4));
                        border: 1px solid rgba(74, 144, 226, 0.5);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                        transition: all 0.2s ease;
                        padding: 8px 15px;
                    ">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        选择文件
                    </button>
                    <span id="selectedFileName" style="
                        color: var(--text-secondary); 
                        font-size: 14px;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        white-space: nowrap;
                        flex: 1;
                    ">未选择文件</span>
                </div>
                
                <!-- 添加文件拖放区域 -->
                <div id="dropArea" style="
                    border: 2px dashed var(--border-color);
                    border-radius: 8px;
                    padding: 20px;
                    text-align: center;
                    color: var(--text-secondary);
                    transition: all 0.2s ease;
                    background: var(--secondary-bg);
                ">
                    <div style="font-size: 14px;">或将文件拖放到此处</div>
                </div>
            </div>
        </div>
        
        <div style="margin-bottom: 20px;">
            <div style="font-weight: 500; margin-bottom: 8px; color: var(--text-color);">导入方式：</div>
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <input type="radio" id="replaceContent" name="importMode" value="replace" checked 
                       style="margin-right: 8px;">
                <label for="replaceContent" style="color: var(--text-color);">替换当前内容</label>
            </div>
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <input type="radio" id="appendContent" name="importMode" value="append"
                       style="margin-right: 8px;">
                <label for="appendContent" style="color: var(--text-color);">追加到当前内容</label>
            </div>
            <!-- 新增导入到列表选项 -->
            <div style="display: flex; align-items: center;">
                <input type="radio" id="importToList" name="importMode" value="toList"
                       style="margin-right: 8px;">
                <label for="importToList" style="color: var(--text-color);">导入到文件列表</label>
            </div>
        </div>
        
        <div style="display: flex; gap: 10px;">
            <button class="button" onclick="processImport()" style="flex:1;">导入</button>
            <button class="button" onclick="closeImportModal()" style="flex:1;">取消</button>
        </div>
    </div>
</div>

<div class="container" style="margin-top: 80px;">
    <!-- 左侧边栏 -->
    <div class="sidebar">
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button class="button" onclick="showNewFileModal()" style="flex:1;">新建文件</button>
            <button class="button" onclick="createNewFolder()" style="flex:1;">新建文件夹</button>
        </div>
        <div class="file-list" id="fileList"></div>
    </div>

    <!-- 左侧边栏展开条 -->
    <div class="sidebar-toggle-bar" id="sidebarToggleBar" onclick="toggleSidebar()"
         style="display: none; cursor: pointer; padding: 10px; background: rgba(0, 0, 0, 0.2); border-radius: 10px 0 0 10px; color: white;">
        &gt;
    </div>

    <!-- 主编辑器区域 -->
    <div style="flex: 1; display: flex; flex-direction: column;">
        <div class="menu-bar">
            <div style="display: flex; gap: 20px; align-items: center;">
                <!-- 新增导入按钮 -->
                <button class="button import-btn" onclick="importFile()">导入</button>
                <button class="button new-btn" onclick="exportFile()" id="modal-overlay" class="export-file">导出</button>
                <button class="button save-btn" onclick="saveFile()" id="saveBtn">保存</button>
                <button class="button" onclick="toggleSidebar()" id="sidebarToggleButton">折叠左侧</button>
                <button class="button" onclick="toggleToolbar()" id="toolbarToggleButton">折叠右侧</button>
                <button class="button" onclick="showAuditLog()" style="margin-left: auto;">审计日志</button>
            </div>
            <button class="button logout-button" onclick="logout()">退出登录</button>
        </div>
        <div class="editor-container">
            <!-- 在编辑器容器底部添加编码栏 -->
            <div class="encoding-bar">
                <div class="encoding-item">
                    编码:
                    <select class="encoding-select" id="fileEncoding">
                        <option value="UTF-8" selected>UTF-8</option>
                        <option value="GBK">GBK</option>
                        <option value="BIG5">BIG5</option>
                        <option value="ISO-8859-1">Western (ISO-8859-1)</option>
                    </select>
                </div>
                <div class="encoding-item">
                    行尾:
                    <select class="encoding-select" id="lineEnding">
                        <option value="CRLF">Windows (CRLF)</option>
                        <option value="LF">Unix (LF)</option>
                    </select>
                </div>
            </div>
            
            <!-- 原有行号容器和编辑器保持不变 -->
            <div id="lineNumbers" style="
                    position: absolute;
                    left: 0;
                    top: 0;
                    bottom: 0;
                    width: 45px;
                    padding: 20px 0;
                    font-size: var(--editor-font-size);
                    line-height: 1.7;
                    color: var(--line-number-color);
                    text-align: center;
                    user-select: none;
                    display: none;
                    background: var(--line-number-bg);
                    border-right: 1px solid var(--line-number-border);
                    z-index: 1;
                    overflow: hidden;
                "></div>
            <textarea id="editor" placeholder="开始输入..." style="padding-left: 50px !important;"></textarea>
            <!-- Canvas for drawing -->
            <canvas id="htyCanvas" style="display: none; width: 100%; height: 100%; background-color: white;"></canvas>
            <div class="status-bar" id="status">已保存</div>
        </div>
    </div>

    <!-- 右侧工具栏 -->
    <div class="toolbar">
        <div class="toolbar-section">
            <div class="toolbar-title">编辑设置</div>
            <!-- 自动保存开关 -->
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span class="toggle-label">自动保存</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="autoSaveToggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <!-- IDE模式开关 -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                <span class="toggle-label">IDE模式</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="ideModeToggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="toolbar-section">
                <div class="toolbar-title">编程语言</div>
                <select class="font-control" id="languageSelect">
                    <option value="code-plaintext">plaintext</option>
                    <option value="code-javascript">JavaScript</option>
                    <option value="code-python">Python</option>
                    <option value="code-css">CSS</option>
                    <option value="code-html">HTML</option>
                </select>
            </div>
            <!-- 新增行号显示开关 -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                <span class="toggle-label">显示行号</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="lineNumberToggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <!-- 新增拼写检查开关 -->
            <label class="toggle-switch" style="margin-top: 15px;">
                <input type="checkbox" id="spellCheckToggle" onchange="toggleSpellCheck()">
                <span class="toggle-slider"></span>
                <span style="color: var(--text-color); margin-left: 8px;">拼写检查</span>
            </label>
            <!-- 新增画笔颜色选择 -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                <span class="toggle-label">画笔颜色</span>
                <input type="color" id="penColorPicker" value="#000000" style="width: 40px; height: 25px; background: var(--secondary-bg); border: 1px solid var(--border-color);"/>
            </div>
        </div>
        <!-- 在工具栏添加Unicode工具 -->
<div class="toolbar-section">
    <div class="toolbar-title">Unicode工具</div>
    <button class="button" onclick="showUnicodePanel()">Unicode查看器</button>
    <button class="button" onclick="convertToUnicode()" style="margin-top:5px;">转为Unicode</button>
    <button class="button" onclick="convertFromUnicode()" style="margin-top:5px;">解析Unicode</button>
</div>
    <!-- 在原有的Unicode工具区块中添加以下代码 -->
<div class="toolbar-section">
    <div class="toolbar-title">进制转换工具</div>
    <div style="display: flex; gap: 8px; margin-bottom: 10px;">
        <select id="conversionType" class="font-control" style="flex:1;">
            <option value="hex">HEX</option>
            <option value="dec">DEC</option>
            <option value="oct">OCT</option>
            <option value="bin">BIN</option>
        </select>
    </div>
    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
        <button class="button" onclick="convertToNumber()" style="flex:1;">转为进制</button>
        <button class="button" onclick="parseFromNumber()" style="flex:1;">解析进制</button>
    </div>
</div>
  
  <!-- 添加Unicode面板 -->
  <div class="modal-overlay" id="unicodeModal">
    <div class="modal-content" style="width: 600px;">
      <h3>Unicode字符查看器</h3>
      <div id="unicodeGrid" style="display: grid; grid-template-columns: repeat(16, 1fr); gap: 2px; margin: 10px 0;"></div>
      <div style="border-top: 1px solid var(--border-color); padding-top: 10px;">
        当前选中字符：<span id="selectedChar"></span>
        Unicode编码：<span id="selectedCode"></span>
      </div>
    </div>
  </div>
  
  <script>
  function showUnicodePanel() {
    const grid = document.getElementById('unicodeGrid');
    grid.innerHTML = '';
    for (let i = 0; i < 256; i++) {
      const char = String.fromCharCode(i);
      const div = document.createElement('div');
      div.style.textAlign = 'center';
      div.style.padding = '2px';
      div.style.border = '1px solid var(--border-color)';
      div.textContent = char;
      div.title = `U+${i.toString(16).padStart(4, '0')}`;
      div.onclick = () => {
        document.getElementById('selectedChar').textContent = char;
        document.getElementById('selectedCode').textContent = `U+${i.toString(16).padStart(4, '0').toUpperCase()}`;
      }
      grid.appendChild(div);
    }
    document.getElementById('unicodeModal').style.display = 'flex';
  }
  
  function convertToUnicode() {
    const text = window.getSelection().toString() || editor.value;
    const converted = text.split('').map(c => 
      '\\u' + c.charCodeAt(0).toString(16).padStart(4, '0')
    ).join('');
    editor.value = editor.value.replace(text, converted);
  }
  
  function convertFromUnicode() {
    const text = window.getSelection().toString() || editor.value;
    const converted = text.replace(/\\u([\dA-Fa-f]{4})/g, (_, code) => 
      String.fromCharCode(parseInt(code, 16))
    );
    editor.value = editor.value.replace(text, converted);
  }
  </script>
        <div class="toolbar-section">
            <div class="toolbar-title">文本设置</div>
            <!-- 新增字号选择 -->
            <div style="margin-bottom: 10px;">
                <select class="font-control" id="fontSizeSelect" onchange="updateFontSize(this.value)">
                    <option value="14">14px</option>
                    <option value="16">16px</option>
                    <option value="18">18px</option>
                    <option value="20">20px</option>
                </select>
            </div>

            <!-- 新增字体选择 -->
            <div>
                <select class="font-control" id="fontFamilySelect" onchange="updateFontFamily(this.value)">
                    <option value="system-ui">系统默认</option>
                    <option value="Consolas">Consolas</option>
                    <option value="Monaco">Monaco</option>
                    <option value="'Courier New'">Courier New</option>
                </select>
            </div>
        </div>
        <div class="toolbar-section">
            <div class="toolbar-title">文件操作</div>
            <button class="button" onclick="handleFileOpen()">打开本地文件</button>
            <button class="button" onclick="handleFileSave()" style="margin-top:10px;">保存到本地</button>
        </div>
        <div class="toolbar-section">
            <div class="toolbar-title">界面主题</div>
            <select class="theme-select" onchange="toggleTheme(this.value)">
                <option value="dark">深色模式</option>
                <option value="light">浅色模式</option>
            </select>
        </div>
        <div class="toolbar-section">
            <div class="toolbar-title">用户设置</div>
            <!-- 新增背景设置 -->
            <div style="margin-bottom: 10px;">
                <input type="file" id="bgFileInput" accept="image/*,video/*" 
                       style="display: none;">
                <button class="button" onclick="document.getElementById('bgFileInput').click()"
                        style="width: 100%; margin-bottom: 8px;">
                    选择背景
                </button>
                <div id="bgFileName" style="font-size: 12px; color: var(--text-secondary); 
                          overflow: hidden; text-overflow: ellipsis;"></div>
            </div>
            
            <!-- 背景设置开关 -->
            <div style="display: flex; align-items: center; justify-content: space-between; margin: 10px 0;">
                <span class="toggle-label">启用背景</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="bgToggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <!-- 新增用户名输入 -->
            <input type="text" id="userNameInput"
                   style="width: 100%; padding: 6px; background: var(--secondary-bg);
                              border: 1px solid var(--border-color); color: var(--text-color);"
                   placeholder="输入用户名">
            <button class="button" onclick="saveUserName()" style="margin-top: 10px;">保存用户</button>
            <!-- 原有头像设置保持不变 -->
            <input type="text" id="avatarPath"
                   style="width: 100%; padding: 6px; background: var(--secondary-bg);
                              border: 1px solid var(--border-color); color: var(--text-color);"
                   placeholder="头像URL">
            <button class="button" onclick="updateAvatar()" style="margin-top: 10px;">更新头像</button>
            <button class="button import-btn" onclick="importPhoto()" style="margin-top: 10px;">头像选择</button>
        </div>
        <div class="toolbar-section">
            <div class="toolbar-title">搜索功能</div>
            <!-- 改为开关形式 -->
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <span class="toggle-label">搜索面板</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="searchPanelToggle" onchange="toggleSearchPanel()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
<!-- 右侧信息卡片 -->
<div class="file-info-card">
    <div class="card-header">文件概览</div>
        <div class="card-content">
            <div class="info-item">
                    <label>名称：</label>
                    <span id="cardFileName">-</span>
            </div>
                <div class="info-item">
                    <label>类型：</label>
                    <span id="cardFileType">-</span>
            </div>
                <div class="info-item">
                    <label>大小：</label>
                    <span id="cardFileSize">-</span>
            </div>
                <div class="info-item">
                    <label>修改：</label>
                    <span id="cardFileModified">-</span>
            </div>
        </div>
    </div>
</div>

    <!-- 右侧工具栏展开条 -->
    <div class="toolbar-toggle-bar" id="toolbarToggleBar" onclick="toggleToolbar()"
         style="display: none; cursor: pointer; padding: 10px; background: rgba(0, 0, 0, 0.2); border-radius: 0 10px 10px 0; color: white;">
        &lt;
    </div>
</div>

<!-- 在body内添加错误提示 -->
<div class="error-toast" id="errorToast"></div>

<!-- 在body底部添加右键菜单 -->
<div class="context-menu" id="fileContextMenu">
    <div class="menu-item" onclick="showNewFileModal()">新建文件</div>
    <div class="menu-item" onclick="createNewFolder()">新建文件夹</div>
    <div class="menu-divider"></div>
    <div class="menu-item" onclick="renameFile()">重命名</div>
    <div class="menu-divider"></div>
    <div class="menu-item" onclick="deleteFile()">删除</div>
    <div class="menu-item" onclick="exportFile()">导出为...</div>
</div>

<!-- 添加审计日志密码输入模态框 -->
<div class="modal-overlay" id="auditPasswordModal">
    <div class="modal-content" style="width: 400px;">
        <h3 style="color: var(--text-color); margin-bottom: 20px;">审计日志访问验证</h3>
        
        <div style="margin-bottom: 25px;">
            <label for="auditPassword" style="display: block; margin-bottom: 8px; color: var(--text-color); font-size: 14px;">
                请输入管理员密码:
            </label>
            <div style="position: relative;">
                <input type="password" id="auditPassword" 
                       style="width: 100%; padding: 10px 40px 10px 15px; 
                              border-radius: 8px;
                              border: 1px solid var(--border-color);
                              background: var(--secondary-bg);
                              color: var(--text-color);
                              font-size: 16px;"
                       onkeypress="if(event.keyCode === 13) verifyAuditPassword()">
                <button id="togglePasswordBtn" type="button" 
                        style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
                               background: none; border: none; color: var(--text-secondary); cursor: pointer;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                </button>
            </div>
            <div id="passwordError" style="color: #ff5757; font-size: 14px; margin-top: 8px; display: none;">
                密码不正确，请重试
    </div>
</div>

        <div style="display: flex; gap: 10px;">
            <button class="button" onclick="verifyAuditPassword()" style="flex:1; background: rgba(74, 144, 226, 0.3);">
                确认
            </button>
            <button class="button" onclick="closeAuditPasswordModal()" style="flex:1;">
                取消
            </button>
                    </div>
                    </div>
                </div>

<!-- 美化审计日志模态框 -->
<div class="modal-overlay" id="auditLogModal">
    <div class="modal-content" style="width: 80vw; height: 80vh; display: flex; flex-direction: column;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color);">
            <div style="display: flex; align-items: center; gap: 15px;">
                <h3 style="color: var(--text-color); margin: 0;">审计日志</h3>
                <span style="color: var(--text-secondary); font-size: 14px; background: var(--secondary-bg); padding: 5px 10px; border-radius: 20px;">
                    共 <span id="logCount" style="font-weight: 600; color: var(--text-color);"></span> 条记录
                        </span>
        </div>
            <div style="display: flex; gap: 15px;">
                <button class="button" onclick="exportAuditLogs()" style="background: rgba(255, 193, 7, 0.3); border-color: rgba(255, 193, 7, 0.5);">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 5px;">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    导出日志
                </button>
                <button class="button danger" onclick="handleClearLogs()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 5px;">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    清除日志
                </button>
                </div>
            </div>
        
        <!-- 添加筛选工具栏 -->
        <div style="display: flex; gap: 15px; margin-bottom: 15px; align-items: center;">
            <div style="position: relative; flex: 1;">
                <input type="text" id="logSearchInput" placeholder="搜索日志..." 
                       style="width: 100%; padding: 8px 10px 8px 35px; 
                              border-radius: 6px;
                              border: 1px solid var(--border-color);
                              background: var(--secondary-bg);
                              color: var(--text-color);">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                     style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-secondary);">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
        </div>
            
            <select id="logTypeFilter" style="padding: 8px 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--secondary-bg); color: var(--text-color);">
                <option value="all">所有操作</option>
                <option value="CREATE">创建</option>
                <option value="OPEN">打开</option>
                <option value="EDIT">编辑</option>
                <option value="DELETE">删除</option>
                <option value="IMPORT">导入</option>
            </select>
            
            <button id="dateFilterBtn" class="button" style="display: flex; align-items: center; gap: 5px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                日期筛选
            </button>
        </div>
        
        <div id="auditLogList" style="flex: 1; overflow-y: auto; padding-right: 10px; margin-bottom: 15px;">
            <!-- 日志内容将通过JavaScript填充 -->
        </div>
        
        <button class="button" onclick="closeAuditModal()" style="align-self: flex-end;">关闭</button>
    </div>
</div>

<!-- 在body末尾添加搜索面板 -->
<div class="search-panel" id="searchPanel" style="display: none;">
    <div class="search-panel-header">
        <div>文本搜索</div>
        <div class="search-panel-close" onclick="toggleSearchPanel()">×</div>
    </div>
    <div class="search-panel-content">
        <div style="position: relative; margin-bottom: 15px;">
            <input type="text" id="searchInput"
                   style="width: 100%;
                              padding: 8px 40px 8px 15px;
                              background: var(--search-bg);
                              border: 1px solid var(--search-border);
                              color: var(--text-color);
                              font-size: 14px;
                              border-radius: 8px;"
                   placeholder="输入搜索内容...">
            <div id="searchMatches"
                 style="position: absolute;
                            right: 15px;
                            top: 50%;
                            transform: translateY(-50%);
                            font-size: 12px;
                            color: var(--text-secondary);">
                0/0
            </div>
        </div>

        <div style="display: flex; gap: 15px; margin-top: 10px;">
            <div style="display: flex; align-items: center;">
                <span class="toggle-label">区分大小写</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="caseSensitiveToggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <button class="button" onclick="findNext()" style="padding: 6px 12px;">下一个</button>
            <button class="button" onclick="findPrev()" style="padding: 6px 12px;">上一个</button>
        </div>
    </div>
</div>

<!-- 添加代码片段库模态框 -->
<div class="modal-overlay" id="snippetsModal">
    <div class="modal-content" style="width: 600px; max-height: 80vh; display: flex; flex-direction: column;">
        <h3 style="color: var(--text-color); margin-bottom: 20px;">代码片段库</h3>
        
        <div style="display: flex; gap: 20px; margin-bottom: 20px;">
            <div style="flex: 1;">
                <input type="text" id="snippetName" placeholder="片段名称" 
                       style="width: 100%; padding: 8px; border-radius: 6px; 
                              border: 1px solid var(--border-color);
                              background: var(--secondary-bg);
                              color: var(--text-color); margin-bottom: 10px;">
                <textarea id="snippetContent" placeholder="输入代码片段内容..." 
                          style="width: 100%; height: 120px; padding: 8px; border-radius: 6px;
                                 border: 1px solid var(--border-color);
                                 background: var(--secondary-bg);
                                 color: var(--text-color); resize: vertical;"></textarea>
                <button class="button" onclick="saveSnippet()" style="margin-top: 10px; width: 100%;">保存片段</button>
            </div>
            
            <div style="flex: 1; max-height: 250px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 6px; padding: 10px;">
                <div id="snippetsList" style="min-height: 200px;">
                    <!-- 代码片段列表将在这里动态生成 -->
                </div>
            </div>
        </div>
        
        <button class="button" onclick="closeSnippetsModal()" style="align-self: flex-end;">关闭</button>
    </div>
</div>

<!-- 添加Markdown预览模态框 -->
<div class="modal-overlay" id="markdownPreviewModal">
    <div class="modal-content" style="width: 80vw; height: 80vh; display: flex; flex-direction: column;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="color: var(--text-color); margin: 0;">Markdown 预览</h3>
            <div>
                <button class="button" onclick="togglePreviewMode()" id="previewModeBtn">分屏模式</button>
                <button class="button" onclick="toggleFullscreen()" id="fullscreenBtn">全屏模式</button>
                <button class="button" onclick="closeMarkdownPreview()" style="margin-left: 10px;">关闭</button>
            </div>
        </div>
        
        <div id="markdownContainer" style="display: flex; gap: 20px; flex: 1; height: calc(100% - 60px);">
            <div id="mdEditor" style="flex: 1; display: block; height: 100%;">
                <textarea id="mdEditorArea" 
                          style="width: 100%; height: 100%; padding: 15px; border-radius: 8px;
                                 border: 1px solid var(--border-color);
                                 background: var(--secondary-bg);
                                 color: var(--text-color); resize: none;"></textarea>
            </div>
            <div id="mdPreview" style="flex: 1; height: 100%; overflow-y: auto; padding: 15px; border-radius: 8px;
                                       border: 1px solid var(--border-color);
                                       background: var(--secondary-bg);">
                <!-- Markdown预览内容将在这里显示 -->
            </div>
        </div>
    </div>
</div>

<!-- 添加文件统计模态框 -->
<div class="modal-overlay" id="fileStatsModal">
    <div class="modal-content" style="width: 400px;">
        <h3 style="color: var(--text-color); margin-bottom: 20px; text-align: center;">文件统计</h3>
        
        <div style="margin-bottom: 25px;">
            <div class="stat-item" style="display: flex; justify-content: space-between; padding: 10px; margin-bottom: 8px; background: var(--secondary-bg); border-radius: 6px;">
                <span>字符数:</span>
                <span id="charCount" style="font-weight: 500;"></span>
            </div>
            <div class="stat-item" style="display: flex; justify-content: space-between; padding: 10px; margin-bottom: 8px; background: var(--secondary-bg); border-radius: 6px;">
                <span>单词数:</span>
                <span id="wordCount" style="font-weight: 500;"></span>
            </div>
            <div class="stat-item" style="display: flex; justify-content: space-between; padding: 10px; margin-bottom: 8px; background: var(--secondary-bg); border-radius: 6px;">
                <span>行数:</span>
                <span id="lineCount" style="font-weight: 500;"></span>
            </div>
            <div class="stat-item" style="display: flex; justify-content: space-between; padding: 10px; background: var(--secondary-bg); border-radius: 6px;">
                <span>文件大小:</span>
                <span id="fileSize" style="font-weight: 500;"></span>
            </div>
        </div>
        
        <button class="button" onclick="closeFileStatsModal()" style="width: 100%;">关闭</button>
    </div>
</div>

<!--     Ai Chat      -->
<div class="modal-overlay" id="aiDialog" style="display:none;">
    <div class="modal-content" style="width: 600px; max-height: 80vh; display: flex; flex-direction: column;">
        <div class="ai-header">
            <h3>AI 助手</h3>
            <div class="ai-controls">
                <button class="button" onclick="newAIChat()">新建对话</button>
                <button class="button" onclick="toggleAISettings()">设置</button>
                <button class="button" onclick="closeAIPanel()">×</button>
            </div>
        </div>
        
        <div id="aiChatContainer" class="ai-chat-container">
            <div id="aiHistory" class="ai-history"></div>
            <div class="ai-input-area">
                <textarea id="aiInput" placeholder="输入您的问题..." 
                         class="ai-input" rows="3"></textarea>
                <button class="button ai-send-btn" onclick="sendAIRequest()">发送</button>
            </div>
        </div>

        <!-- AI设置面板 -->
        <div id="aiSettings" class="ai-settings" style="display:none;">
            <div class="setting-item">
                <label>API 密钥：</label>
                <input type="password" id="apiKey" class="setting-input">
            </div>
            <div class="setting-item">
                <label>API 端口：</label>
                <input type="text" id="apiEndpoint" 
                       value="https://api.example.com/v1/chat/completions"
                       class="setting-input">
            </div>
            <div class="setting-item">
                <label>模型选择：</label>
                <select id="aiModel" class="setting-input">
                    <option value="gpt-3.5">GPT-3.5</option>
                    <option value="gpt-4">GPT-4</option>
                    <option value="claude-3">Claude 3</option>
                </select>
            </div>
        </div>
    </div>
</div>

<style>
/* AI对话框样式 */
.ai-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 15px;
}

.ai-chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.ai-history {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    background: var(--secondary-bg);
    border-radius: 8px;
    min-height: 300px;
}

.ai-message {
    margin: 10px 0;
    padding: 12px;
    border-radius: 8px;
    max-width: 80%;
}

.user-message {
    background: rgba(74, 144, 226, 0.2);
    margin-left: auto;
}

.ai-response {
    background: rgba(255, 255, 255, 0.1);
    margin-right: auto;
}

.ai-input-area {
    display: flex;
    gap: 10px;
    position: relative;
}

.ai-input {
    flex: 1;
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--secondary-bg);
    color: var(--text-color);
    resize: none;
}

.ai-send-btn {
    align-self: flex-end;
    padding: 8px 20px;
}

.ai-settings {
    padding: 15px;
    background: var(--secondary-bg);
    border-radius: 8px;
    margin-top: 15px;
}

.setting-item {
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.setting-input {
    flex: 1;
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--secondary-bg);
    color: var(--text-color);
}

[data-theme="light"] .ai-message {
    background: rgba(0, 0, 0, 0.05);
}
</style>

<script>
// AI对话管理
let currentChat = [];
const MAX_HISTORY = 20;

function showAIPanel() {
    document.getElementById('aiDialog').style.display = 'flex';
    loadChatHistory();
}

function closeAIPanel() {
    document.getElementById('aiDialog').style.display = 'none';
}

function newAIChat() {
    currentChat = [];
    updateChatDisplay();
}

function toggleAISettings() {
    const settings = document.getElementById('aiSettings');
    settings.style.display = settings.style.display === 'none' ? 'block' : 'none';
}

async function sendAIRequest() {
    const input = document.getElementById('aiInput');
    const message = input.value.trim();
    if (!message) return;

    // 添加到聊天记录
    addMessage('user', message);
    input.value = '';
    
    try {
        const response = await fetchAIResponse(message);
        addMessage('assistant', response);
        saveChatHistory();
    } catch (error) {
        addMessage('system', `错误：${error.message}`);
    }
}

async function fetchAIResponse(prompt) {
    const apiKey = document.getElementById('apiKey').value;
    const endpoint = document.getElementById('apiEndpoint').value;
    const model = document.getElementById('aiModel').value;

    if (!apiKey) throw new Error('请先配置API密钥');

    const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
            model: model,
            messages: [
                ...currentChat,
                { role: "user", content: prompt }
            ]
        })
    });

    if (!response.ok) throw new Error(`API请求失败：${response.status}`);

    const data = await response.json();
    return data.choices[0].message.content;
}

function addMessage(role, content) {
    currentChat.push({ role, content });
    if (currentChat.length > MAX_HISTORY) currentChat.shift();
    
    const historyDiv = document.getElementById('aiHistory');
    const messageDiv = document.createElement('div');
    messageDiv.className = `ai-message ${role}-message`;
    messageDiv.textContent = `${role === 'user' ? '您：' : 'AI：'} ${content}`;
    historyDiv.appendChild(messageDiv);
    historyDiv.scrollTop = historyDiv.scrollHeight;
}

function saveChatHistory() {
    localStorage.setItem('aiChatHistory', JSON.stringify(currentChat));
}

function loadChatHistory() {
    const history = localStorage.getItem('aiChatHistory');
    if (history) {
        currentChat = JSON.parse(history);
        updateChatDisplay();
    }
}

function updateChatDisplay() {
    const historyDiv = document.getElementById('aiHistory');
    historyDiv.innerHTML = '';
    currentChat.forEach(msg => addMessage(msg.role, msg.content));
}
</script>
<!--      AI Chat     -->


<!--  NotePad窗口  -->
<div id="futureNotepadOverlay" class="window-overlay">
    <div class="future-notepad">
        <div class="titlebar">
            <div class="window-controls">
                <button class="control-btn close" onclick="toggleFutureNotepad()"></button>
                <button class="control-btn minimize"></button>
                <button class="control-btn maximize"></button>
            </div>
            <span class="window-title">Untitled - Future Notepad</span>
            <div style="width: 60px"></div>
        </div>
        <textarea id="futureEditor" class="editor" placeholder="Start typing..."></textarea>
        <div class="fn-status-bar">
            <span>UTF-8</span>
            <span>Ln 1, Col 1</span>
        </div>
    </div>
</div>
<style>
/* 未来记事本窗口样式 */
.window-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    backdrop-filter: blur(5px);
}

.future-notepad {
    width: 800px;
    height: 600px;
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(12px);
    border-radius: 15px;
    border: 1px solid rgba(255,255,255,0.2);
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    overflow: hidden;
    position: relative;
}

.future-notepad .titlebar {
    padding: 12px 20px;
    background: rgba(255,255,255,0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    cursor: move;
}

.window-controls {
    display: flex;
    gap: 10px;
}

.control-btn {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    transition: transform 0.2s;
}

.control-btn:hover {
    transform: scale(1.1);
}

.close { background: #ff5f57; }
.minimize { background: #febc2e; }
.maximize { background: #28c940; }

#futureEditor {
    width: 100%;
    height: calc(100% - 40px);
    padding: 20px;
    background: transparent;
    color: var(--text-color);
    font-size: 16px;
    line-height: 1.5;
    resize: none;
    border: none;
    outline: none;
}

.fn-status-bar {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 8px 20px;
    background: rgba(0,0,0,0.1);
    color: var(--text-secondary);
    font-size: 12px;
    display: flex;
    justify-content: space-between;
}

/* 浅色主题适配 */
[data-theme="light"] .future-notepad {
    background: rgba(255,255,255,0.9);
    border: 1px solid rgba(0,0,0,0.1);
}

[data-theme="light"] #futureEditor {
    color: var(--text-color);
}

[data-theme="light"] .status-bar {
    background: rgba(255,255,255,0.9);
}

/* 新增Code模式样式 */
.source-editor {
    width: 100%;
    height: 100%;
    font-family: 'Fira Code', monospace;
    tab-size: 2;
    padding: 10px;
    background: var(--bg-color);
    color: #abb2bf;
    border: none;
    outline: none;
    overflow: auto;
}

.code-toolbar {
    padding: 8px;
    background: var(--secondary-bg);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    gap: 10px;
}

.status-indicator {
    margin-left: auto;
    color: var(--text-secondary);
    font-size: 12px;
}

/* 简单语法高亮 */
.source-editor {
    white-space: pre-wrap;
}

.source-editor tag {
    color: #e06c75;
}

.source-editor attr {
    color: #d19a66;
}

.source-editor value {
    color: #98c379;
}

.source-editor comment {
    color: #5c6370;
    font-style: italic;
}
</style>
<!-- DevTools 密码验证 -->
<div class="modal-overlay" id="devToolsAuthModal">
    <div class="modal-content" style="width: 300px;">
        <h3 style="color: var(--text-color); margin-bottom: 20px;">开发者工具验证</h3>
        <input type="password" id="devToolsPassword" 
               class="number-input"
               placeholder="输入开发者密码"
               onkeypress="if(event.keyCode === 13) verifyDevToolsPassword()">
        <div id="devToolsAuthError" class="error-toast" style="display:none; position:static;"></div>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="button" onclick="verifyDevToolsPassword()">验证</button>
            <button class="button" onclick="closeDevToolsAuth()">取消</button>
        </div>
    </div>
</div>

<!-- DevTools 主面板 -->
<div id="devToolsPanel" class="dev-tools-panel">
    <div class="dev-tools-header">
        <div class="dev-tools-tabs">
            <button class="tab-btn active" data-tab="elements">元素检查器</button>
            <button class="tab-btn" data-tab="console">控制台</button>
            <button class="tab-btn" data-tab="code">Code</button>
        </div>
        <button class="control-btn close" onclick="toggleDevTools()"></button>
    </div>
    
    <div class="dev-tools-body">
        <div class="dev-tools-sidebar">
            <div class="command-input">
                <input type="text" id="devToolsCommand" 
                       placeholder="输入指令 (例：select #editor)">
                <button class="button" onclick="executeDevToolsCommand()">执行</button>
            </div>
            <div id="elementTree" class="element-tree"></div>
        </div>
        <div class="dev-tools-main" data-tab-content="code" style="display:none;">
            <div class="code-toolbar">
                <button class="tab-btn" onclick="refreshSourceCode()">刷新</button>
                <button class="tab-btn" onclick="formatCode()">格式化</button>
                <span class="status-indicator" id="codeStatus"></span>
            </div>
            <div id="sourceEditor" class="source-editor"></div>
        </div>
        <div class="dev-tools-main">
            <div class="styles-editor">
                <div class="styles-header">
                    <span>样式编辑器</span>
                    <button class="button" id="inspectModeBtn" onclick="toggleInspectMode()">检查模式</button>
                </div>
                <div id="cssProperties" class="css-properties"></div>
            </div>
        </div>
    </div>
</div>
</body>
<!-- 添加新的工具栏按钮到菜单栏 -->
<script>
    // 新增Code模式逻辑
let currentSourceCode = '';
let isCodeMode = false;
let codeEditor = null;

// 初始化代码编辑器
function initCodeEditor() {
    codeEditor = document.getElementById('sourceEditor');
    codeEditor.contentEditable = true;
    
    codeEditor.addEventListener('input', () => {
        applyCodeChanges();
        highlightSyntax();
    });
}

// 获取页面源代码
function getPageSource() {
    const original = document.documentElement.outerHTML;
    return formatHTML(original);
}

// 格式化HTML代码
function formatHTML(html) {
    const tab = '  ';
    let result = '';
    let indent= '';

    html.split(/>\s*</).forEach(element => {
        if (element.match(/^\/\w/)) {
            indent = indent.substring(tab.length);
        }
        
        result += indent + '<' + element + '>\r\n';
        
        if (element.match(/^<?\w[^>]*[^\/]$/) && !element.startsWith("!--")) {
            indent += tab;
        }
    });
    
    return result.substring(1, result.length-3);
}

// 高亮语法
function highlightSyntax() {
    const code = codeEditor.innerHTML;
    const highlighted = code
        .replace(/&lt;!--[\s\S]*?--&gt;/g, '<comment>$&</comment>')
        .replace(/&lt;(\/?[\w-]+)/g, '&lt;<tag>$1</tag>')
        .replace(/(\s[\w-]+)=/g, '<attr>$1</attr>=')
        .replace(/=(".*?"|'.*?')/g, '=<value>$1</value>');
    
    codeEditor.innerHTML = highlighted;
}

// 应用代码修改
function applyCodeChanges() {
    const status = document.getElementById('codeStatus');
    try {
        const parser = new DOMParser();
        const newDoc = parser.parseFromString(codeEditor.textContent, 'text/html');
        
        // 验证文档结构
        if (newDoc.documentElement.tagName !== 'HTML') {
            throw new Error('无效的HTML结构');
        }
        
        // 替换当前文档
        document.replaceChild(
            document.importNode(newDoc.documentElement, true),
            document.documentElement
        );
        
        status.textContent = '✓ 已应用更改';
        status.style.color = '#98c379';
        
        // 重新初始化编辑器
        setTimeout(() => {
            currentSourceCode = getPageSource();
            codeEditor.textContent = currentSourceCode;
            highlightSyntax();
        }, 100);
        
    } catch (e) {
        status.textContent = '✗ 错误: ' + e.message;
        status.style.color = '#e06c75';
    }
}

// 刷新源代码
function refreshSourceCode() {
    currentSourceCode = getPageSource();
    codeEditor.textContent = currentSourceCode;
    highlightSyntax();
}

// 初始化标签切换
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const tab = this.dataset.tab;
        
        document.querySelectorAll('.tab-btn').forEach(b => 
            b.classList.toggle('active', b === this));
            
        document.querySelectorAll('[data-tab-content]').forEach(content => 
            content.style.display = content.dataset.tabContent === tab ? 'block' : 'none');
        
        if (tab === 'code' && !isCodeMode) {
            isCodeMode = true;
            initCodeEditor();
            refreshSourceCode();
        }
    });
});
    // 通用格式处理
function formatSelection(type) {
    const editor = document.getElementById('editor');
    const selection = window.getSelection();
    
    if (!selection.rangeCount) {
        showError('请先选择要格式化的文本');
        return;
    }

    const range = selection.getRangeAt(0);
    const selectedText = range.toString();
    
    // 创建对应标签
    const tagMap = {
        bold: ['<strong>', '</strong>'],
        italic: ['<em>', '</em>'],
        underline: ['<u>', '</u>'],
        strikethrough: ['<s>', '</s>']
    };

    if (tagMap[type]) {
        const newNode = document.createElement('div');
        newNode.innerHTML = `${tagMap[type][0]}${selectedText}${tagMap[type][1]}`;
        range.deleteContents();
        range.insertNode(newNode.firstChild);
    }

    // 保持选区
    const newRange = document.createRange();
    newRange.selectNodeContents(editor);
    selection.removeAllRanges();
    selection.addRange(newRange);
}

// 标题处理
function applyHeading(level) {
    const selection = window.getSelection();
    if (!selection.rangeCount) {
        showError('请先选择要设置为标题的文本');
        return;
    }

    const range = selection.getRangeAt(0);
    const selectedText = range.toString().trim();
    
    // 创建标题元素
    const heading = document.createElement(`h${level}`);
    heading.textContent = selectedText;
    
    // 替换内容
    range.deleteContents();
    range.insertNode(heading);
    
    // 添加样式类
    heading.className = 'user-heading';
    
    // 保持选区
    const newRange = document.createRange();
    newRange.selectNodeContents(heading);
    selection.removeAllRanges();
    selection.addRange(newRange);

const existingTags = getExistingTags(range);
    const wrapTags = tagMap[type];
    
    let newContent = selectedText;
    if (existingTags[type]) {
        // 移除已有标签
        newContent = selectedText
            .replace(new RegExp(`^${wrapTags[0]}`), '')
            .replace(new RegExp(`${wrapTags[1]}$`), '');
    } else {
        // 添加新标签
        newContent = wrapTags[0] + newContent + wrapTags[1];
    }

    // 创建新节点
    const newNode = document.createElement('div');
    newNode.innerHTML = newContent;
    
    // 替换内容
    range.deleteContents();
    range.insertNode(newNode.firstChild);

    // 检查现有标签的函数
    function getExistingTags(range) {
        const container = range.commonAncestorContainer;
        return {
            bold: container.parentNode.closest('strong,b'),
            italic: container.parentNode.closest('em,i'),
            underline: container.parentNode.closest('u'),
            strikethrough: container.parentNode.closest('s,del')
        };
    }
}

// 实时更新按钮状态
document.addEventListener('selectionchange', () => {
    const buttons = document.querySelectorAll('#sideToolbar2 .tool-button');
    const selection = window.getSelection();
    
    buttons.forEach(btn => {
        const type = btn.getAttribute('onclick')?.match(/formatSelection\('(.*?)'\)/)?.[1];
        if (!type) return;

        const isActive = checkFormatActive(type);
        btn.style.background = isActive ? 'rgba(74, 144, 226, 0.3)' : '';
    });
});

function checkFormatActive(type) {
    const selection = window.getSelection();
    if (!selection.rangeCount) return false;
    
    const range = selection.getRangeAt(0);
    const container = range.commonAncestorContainer;
    
    const tagMap = {
        bold: ['strong', 'b'],
        italic: ['em', 'i'],
        underline: ['u'],
        strikethrough: ['s', 'del']
    };
    
    return tagMap[type].some(tag => 
        container.parentNode.closest(tag)
    );
}


    // 在body加载完成后执行
    document.addEventListener('DOMContentLoaded', function() {
        // 找到菜单栏的第一个div
        const menuBarItems = document.querySelector('.menu-bar > div');
        
        if (menuBarItems) {
        }
        
        // 初始化绘图工具栏
        initDrawingTools();
    });
    
    // 代码片段库相关函数
    let snippets = JSON.parse(localStorage.getItem('editorSnippets')) || [];
    
    function showSnippetsModal() {
        document.getElementById('snippetsModal').style.display = 'flex';
        refreshSnippetsList();
    }
    
    function closeSnippetsModal() {
        document.getElementById('snippetsModal').style.display = 'none';
    }
    
    function saveSnippet() {
        const name = document.getElementById('snippetName').value.trim();
        const content = document.getElementById('snippetContent').value;
        
        if (!name) {
            showError('请输入片段名称');
            return;
        }
        
        // 检查是否已存在同名片段
        const existingIndex = snippets.findIndex(s => s.name === name);
        if (existingIndex >= 0) {
            if (confirm(`已存在名为"${name}"的片段，是否覆盖？`)) {
                snippets[existingIndex].content = content;
            } else {
                return;
            }
        } else {
            snippets.push({ name, content, created: new Date().toISOString() });
        }
        
        localStorage.setItem('editorSnippets', JSON.stringify(snippets));
        document.getElementById('snippetName').value = '';
        document.getElementById('snippetContent').value = '';
        refreshSnippetsList();
        showStatus('代码片段已保存');
    }
    
    function refreshSnippetsList() {
        const list = document.getElementById('snippetsList');
        
        if (snippets.length === 0) {
            list.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">暂无保存的代码片段</div>';
            return;
        }
        
        list.innerHTML = snippets.map(snippet => `
            <div class="snippet-item" style="padding: 10px; margin-bottom: 8px; background: rgba(255,255,255,0.05); border-radius: 6px; position: relative;">
                <div style="font-weight: 500; margin-bottom: 5px; color: var(--text-color);">${snippet.name}</div>
                <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">
                    ${new Date(snippet.created).toLocaleString()}
                </div>
                <div style="position: absolute; top: 10px; right: 10px;">
                    <button onclick="insertSnippet('${snippet.name}')" style="background: none; border: none; cursor: pointer; color: var(--text-color);">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 12l2 2 4-4"></path>
                            <path d="M3 12a9 9 0 1 0 18 0 9 9 0 0 0-18 0z"></path>
                        </svg>
                    </button>
                    <button onclick="deleteSnippet('${snippet.name}')" style="background: none; border: none; cursor: pointer; color: var(--text-color); margin-left: 5px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    function insertSnippet(name) {
        const snippet = snippets.find(s => s.name === name);
        if (snippet && editor) {
            const cursorPos = editor.selectionStart;
            editor.setRangeText(snippet.content, cursorPos, cursorPos, 'end');
            closeSnippetsModal();
            showStatus('已插入代码片段');
        }
    }
    
    function deleteSnippet(name) {
        if (confirm(`确定要删除"${name}"片段吗？`)) {
            snippets = snippets.filter(s => s.name !== name);
            localStorage.setItem('editorSnippets', JSON.stringify(snippets));
            refreshSnippetsList();
            showStatus('已删除代码片段');
        }
    }
    
    // Markdown预览相关函数
    let previewMode = 'split'; // 'split' 或 'preview'
    
    function showMarkdownPreview() {
        if (!currentFile) {
            showError('请先打开或创建一个文件');
            return;
        }
        
        if (currentFile.format !== 'md') {
            showError('只能预览 Markdown 文件');
            return;
        }
        
        document.getElementById('markdownPreviewModal').style.display = 'flex';
        document.getElementById('mdEditorArea').value = editor.value;
        renderMarkdown();
        
        // 设置编辑器与原文同步
        document.getElementById('mdEditorArea').addEventListener('input', renderMarkdown);
    }
    
    function closeMarkdownPreview() {
        document.getElementById('markdownPreviewModal').style.display = 'none';
        // 将编辑器内容同步回主编辑器
        editor.value = document.getElementById('mdEditorArea').value;
        editor.dispatchEvent(new Event('input')); // 触发input事件以便自动保存
    }
    
    function togglePreviewMode() {
        const container = document.getElementById('markdownContainer');
        const editorArea = document.getElementById('mdEditor');
        const previewArea = document.getElementById('mdPreview');
        const modeBtn = document.getElementById('previewModeBtn');
        
        if (previewMode === 'split') {
            previewMode = 'preview';
            editorArea.style.display = 'none';
            previewArea.style.flex = '1';
            modeBtn.textContent = '编辑模式';
        } else {
            previewMode = 'split';
            editorArea.style.display = 'block';
            modeBtn.textContent = '预览模式';
        }
    }
    
    function renderMarkdown() {
        const markdown = document.getElementById('mdEditorArea').value;
        const preview = document.getElementById('mdPreview');
        
        // 简单的Markdown渲染
        let html = markdown
            // 标题
            .replace(/^# (.*$)/gm, '<h1>$1</h1>')
            .replace(/^## (.*$)/gm, '<h2>$1</h2>')
            .replace(/^### (.*$)/gm, '<h3>$1</h3>')
            // 粗体和斜体
            .replace(/\*\*(.*)\*\*/gm, '<strong>$1</strong>')
            .replace(/\*(.*)\*/gm, '<em>$1</em>')
            // 链接
            .replace(/\[([^\]]+)\]\(([^)]+)\)/gm, '<a href="$2" target="_blank">$1</a>')
            // 图片
            .replace(/!\[([^\]]+)\]\(([^)]+)\)/gm, '<img src="$2" alt="$1" style="max-width:100%;">')
            // 代码块
            .replace(/```([\s\S]*?)```/gm, '<pre><code>$1</code></pre>')
            // 行内代码
            .replace(/`([^`]+)`/gm, '<code>$1</code>')
            // 列表
            .replace(/^\- (.*$)/gm, '<ul><li>$1</li></ul>')
            .replace(/^\d\. (.*$)/gm, '<ol><li>$1</li></ol>')
            // 段落
            .replace(/^(?!<[hou]).+$/gm, '<p>$&</p>')
            // 修复重复的列表标签
            .replace(/<\/ul><ul>/gm, '')
            .replace(/<\/ol><ol>/gm, '');
        
        preview.innerHTML = html;
    }
    
    // 文件统计相关函数
    function showFileStats() {
        if (!currentFile) {
            showError('请先打开或创建一个文件');
            return;
        }
        
        let content = '';
        if (currentFile.format === 'jpg') {
            content = '图像文件';
        } else {
            content = editor.value;
        }
        
        document.getElementById('fileStatsModal').style.display = 'flex';
        
        // 计算统计信息
        let charCount, wordCount, lineCount, fileSize;
        
        if (currentFile.format === 'jpg') {
            charCount = '-';
            wordCount = '-';
            lineCount = '-';
            
            // 估算图像大小
            const base64Length = currentFile.content.length - 'data:image/jpeg;base64,'.length;
            const fileSizeBytes = Math.ceil(base64Length * 0.75);
            fileSize = formatFileSize(fileSizeBytes);
        } else {
            charCount = content.length;
            wordCount = content.split(/\s+/).filter(word => word.length > 0).length;
            lineCount = content.split('\n').length;
            fileSize = formatFileSize(new Blob([content]).size);
        }
        
        document.getElementById('charCount').textContent = charCount;
        document.getElementById('wordCount').textContent = wordCount;
        document.getElementById('lineCount').textContent = lineCount;
        document.getElementById('fileSize').textContent = fileSize;
    }
    
    function closeFileStatsModal() {
        document.getElementById('fileStatsModal').style.display = 'none';
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // 更新卡片信息函数
function updateFileCard() {
    if (!currentFile) {
        document.querySelectorAll('.file-info-card span').forEach(span => span.textContent = '-');
        return;
    }

    // 基础信息
    document.getElementById('cardFileName').textContent = currentFile.name;
    document.getElementById('cardFileType').textContent = currentFile.format.toUpperCase();
    
    // 计算文件大小
    const size = currentFile.format === 'jpg' ? 
        Math.round(currentFile.content.length - 'data:image/jpeg;base64,'.length) * 0.75 : 
        new Blob([currentFile.content]).size;
    document.getElementById('cardFileSize').textContent = formatFileSize(size);
    
    // 最后修改时间
    const lastModified = currentFile.history?.length ? 
        new Date(currentFile.history.slice(-1)[0].timestamp).toLocaleString() : 
        '新文件';
    document.getElementById('cardFileModified').textContent = lastModified;
}

// 显示完整信息窗口
function showFileInfoModal() {
    if (!currentFile) return showError('请先打开文件');
    
    const infoContent = document.getElementById('fileInfoContent');
    infoContent.innerHTML = `
        <div class="info-row">
            <span>文件名称：</span>
            <span>${currentFile.name}</span>
        </div>
        <div class="info-row">
            <span>文件格式：</span>
            <span>${currentFile.format.toUpperCase()}</span>
        </div>
        <div class="info-row">
            <span>文件大小：</span>
            <span>${document.getElementById('cardFileSize').textContent}</span>
        </div>
        <div class="info-row">
            <span>创建时间：</span>
            <span>${new Date(currentFile.history[0].timestamp).toLocaleString()}</span>
        </div>
        <div class="info-row">
            <span>最后修改：</span>
            <span>${document.getElementById('cardFileModified').textContent}</span>
        </div>
        <div class="info-row">
            <span>版本历史：</span>
            <span>${currentFile.history.length} 个版本</span>
        </div>
        ${currentFile.passwordHash ? `
        <div class="info-row">
            <span>安全状态：</span>
            <span>🔒 已加密</span>
        </div>` : ''}
    `;

    document.getElementById('fileInfoModal').style.display = 'flex';
}

// 在以下位置调用更新函数：
// 1. 文件打开时
function openFile(fileId) {
    // ...原有逻辑...
    updateFileCard();
}

// 2. 文件保存时
function saveFile() {
    // ...原有逻辑...
    updateFileCard();
}

// 3. 文件创建时
function createNewFile() {
    // ...原有逻辑...
    updateFileCard();
}
    
    // 增强绘图工具
    function initDrawingTools() {
        // 创建绘图工具栏
        const drawingTools = document.createElement('div');
        drawingTools.id = 'drawingToolbar';
        drawingTools.style = `
            position: absolute;
            left: 10px;
            top: 60px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 10px;
            display: none;
            flex-direction: column;
            gap: 10px;
            z-index: 5;
        `;
        
        drawingTools.innerHTML = `
            <button id="drawPencil" class="tool-btn active" title="铅笔工具">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                </svg>
            </button>
            <button id="drawLine" class="tool-btn" title="直线工具">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </button>
            <button id="drawRect" class="tool-btn" title="矩形工具">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                </svg>
            </button>
            <button id="drawCircle" class="tool-btn" title="圆形工具">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                </svg>
            </button>
            <button id="drawText" class="tool-btn" title="文本工具">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="4 7 4 4 20 4 20 7"></polyline>
                    <line x1="9" y1="20" x2="15" y2="20"></line>
                    <line x1="12" y1="4" x2="12" y2="20"></line>
                </svg>
            </button>
            <button id="drawEraser" class="tool-btn" title="橡皮擦">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 20H7L3 16a2 2 0 0 1 0-2.8L13.8 3.4a2 2 0 0 1 2.8 0l4 4a2 2 0 0 1 0 2.8L8 20"></path>
                </svg>
            </button>
        `;
        
        document.querySelector('.editor-container').appendChild(drawingTools);
        
        // 添加样式
        const style = document.createElement('style');
        style.textContent = `
            .tool-btn {
                background: rgba(255,255,255,0.1);
                border: 1px solid rgba(255,255,255,0.2);
                border-radius: 6px;
                padding: 8px;
                color: white;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .tool-btn:hover {
                background: rgba(255,255,255,0.2);
            }
            
            .tool-btn.active {
                background: rgba(74, 144, 226, 0.6);
                border-color: rgba(74, 144, 226, 0.8);
            }
        `;
        document.head.appendChild(style);
        
        // 绘图变量
        window.drawingMode = 'pencil'; // 默认为铅笔模式
        let startX, startY;
        let isDrawingShape = false;
        let tempCanvas = document.createElement('canvas');
        let tempCtx = tempCanvas.getContext('2d');
        
        // 工具按钮点击事件
        document.getElementById('drawPencil').addEventListener('click', function() {
            setDrawingMode('pencil', this);
        });
        
        document.getElementById('drawLine').addEventListener('click', function() {
            setDrawingMode('line', this);
        });
        
        document.getElementById('drawRect').addEventListener('click', function() {
            setDrawingMode('rect', this);
        });
        
        document.getElementById('drawCircle').addEventListener('click', function() {
            setDrawingMode('circle', this);
        });
        
        document.getElementById('drawText').addEventListener('click', function() {
            setDrawingMode('text', this);
        });
        
        document.getElementById('drawEraser').addEventListener('click', function() {
            setDrawingMode('eraser', this);
        });
        
        function setDrawingMode(mode, button) {
            window.drawingMode = mode;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
        }
        
        // 增强绘图功能
        const originalDrawing = window.drawing;
        const originalStartDrawing = window.startDrawing;
        const originalDraw = window.draw;
        
        // 覆盖原始的startDrawing函数
        window.startDrawing = function(e) {
            drawing = true;
            lastPos = getMousePos(htyCanvas, e);
            
            // 记录形状绘制的起始点
            if (['line', 'rect', 'circle'].includes(drawingMode)) {
                isDrawingShape = true;
                startX = lastPos.x;
                startY = lastPos.y;
                
                // 初始化临时画布
                tempCanvas.width = htyCanvas.width;
                tempCanvas.height = htyCanvas.height;
                tempCtx.drawImage(htyCanvas, 0, 0);
            }
            
            // 文本工具处理
            if (drawingMode === 'text') {
                const pos = getMousePos(htyCanvas, e);
                const text = prompt('请输入文本:');
                if (text) {
                    ctx.font = '16px Arial';
                    ctx.fillStyle = penColor;
                    ctx.fillText(text, pos.x, pos.y);
                    currentFile.content = htyCanvas.toDataURL('image/jpeg', 0.9);
                }
            }
        };
        
        // 覆盖原始的draw函数
        window.draw = function(e) {
            if (!drawing) return;
            
            currentPos = getMousePos(htyCanvas, e);
            
            if (drawingMode === 'pencil') {
                // 铅笔工具
                ctx.beginPath();
                ctx.moveTo(lastPos.x, lastPos.y);
                ctx.lineTo(currentPos.x, currentPos.y);
                ctx.strokeStyle = penColor;
                ctx.lineWidth = penSize;
                ctx.lineCap = 'round';
                ctx.stroke();
                lastPos = currentPos;
            } else if (drawingMode === 'eraser') {
                // 橡皮擦工具
                ctx.beginPath();
                ctx.arc(currentPos.x, currentPos.y, penSize * 2, 0, Math.PI * 2);
                ctx.fillStyle = '#FFFFFF';
                ctx.fill();
                lastPos = currentPos;
            } else if (isDrawingShape) {
                // 形状工具
                ctx.clearRect(0, 0, htyCanvas.width, htyCanvas.height);
                ctx.drawImage(tempCanvas, 0, 0);
                
                ctx.beginPath();
                ctx.strokeStyle = penColor;
                ctx.lineWidth = penSize;
                
                if (drawingMode === 'line') {
                    // 直线
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(currentPos.x, currentPos.y);
                    ctx.stroke();
                } else if (drawingMode === 'rect') {
                    // 矩形
                    const width = currentPos.x - startX;
                    const height = currentPos.y - startY;
                    ctx.rect(startX, startY, width, height);
                    ctx.stroke();
                } else if (drawingMode === 'circle') {
                    // 圆形
                    const radius = Math.sqrt(
                        Math.pow(currentPos.x - startX, 2) +
                        Math.pow(currentPos.y - startY, 2)
                    );
                    ctx.arc(startX, startY, radius, 0, Math.PI * 2);
                    ctx.stroke();
                }
            }
        };
        
        // 覆盖原始的stopDrawing函数
        const originalStopDrawing = window.stopDrawing;
        window.stopDrawing = function() {
            if (isDrawingShape) {
                isDrawingShape = false;
                if (currentFile) {
                    currentFile.content = htyCanvas.toDataURL('image/jpeg', 0.9);
                }
            }
            drawing = false;
        };
        
        // 修改switchToCanvasMode显示工具栏
        const originalSwitchToCanvasMode = window.switchToCanvasMode;
        window.switchToCanvasMode = function() {
            if (typeof originalSwitchToCanvasMode === 'function') {
                originalSwitchToCanvasMode();
            } else {
                editor.style.display = 'none';
                lineNumbers.style.display = 'none';
                htyCanvas.style.display = 'block';
                htyCanvas.style.backgroundColor = 'white';
            }
            
            // 显示绘图工具栏
            document.getElementById('drawingToolbar').style.display = 'flex';
        };
        
        // 修改switchToEditorMode隐藏工具栏
        const originalSwitchToEditorMode = window.switchToEditorMode;
        window.switchToEditorMode = function() {
            if (typeof originalSwitchToEditorMode === 'function') {
                originalSwitchToEditorMode();
            } else {
                editor.style.display = 'block';
                lineNumbers.style.display = lineNumberToggle.checked ? 'block' : 'none';
                htyCanvas.style.display = 'none';
            }
            
            // 隐藏绘图工具栏
            document.getElementById('drawingToolbar').style.display = 'none';
        };
    }
</script>

<!-- 绘图工具样式 -->
<style>
    #drawingToolbar {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        backdrop-filter: blur(10px);
    }
    
    .tool-btn svg {
        display: block;
    }
    
    /* 为代码片段项添加交互效果 */
    .snippet-item {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .snippet-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* Markdown预览样式 */
    #mdPreview {
        line-height: 1.6;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    
    #mdPreview h1, #mdPreview h2, #mdPreview h3 {
        margin: 1em 0 0.5em;
    }
    
    #mdPreview p {
        margin: 0 0 1em;
    }
    
    #mdPreview code {
        background: rgba(0,0,0,0.1);
        padding: 2px 4px;
        border-radius: 3px;
        font-family: monospace;
    }
    
    #mdPreview pre {
        background: rgba(0,0,0,0.1);
        padding: 1em;
        border-radius: 5px;
        overflow-x: auto;
    }
    
    #mdPreview pre code {
        background: transparent;
        padding: 0;
    }
</style>

<script>
    const editor = document.getElementById('editor');
    const status = document.getElementById('status');
    let timeoutId;

    // 新增文件管理功能
    let files = JSON.parse(localStorage.getItem('editorFiles')) || [];
    let currentFile = null;

    // 新增自动保存状态
    let autoSaveEnabled = true;
    const autoSaveToggle = document.getElementById('autoSaveToggle');

    // 新增IDE模式状态
    let ideModeEnabled = false;
    const ideModeToggle = document.getElementById('ideModeToggle');

    // 新增本地文件操作逻辑
    let fileHandle = null;

    // 新增历史记录功能
    let historyTimeout;
    function recordHistory() {
        if (!currentFile) return;

        currentFile.history = currentFile.history || [];
        currentFile.history.push(editor.value);

        // 保留最近50个版本
        if (currentFile.history.length > 50) {
            currentFile.history.shift();
        }

        // 防抖处理，每5秒记录一次
        clearTimeout(historyTimeout);
        historyTimeout = setTimeout(() => {
            localStorage.setItem('editorFiles', JSON.stringify(files));
        }, 5000);
    }

    // 新增文件变更检测
    let lastSavedContent = '';

    function checkFileChange() {
        if (currentFile && editor.value !== lastSavedContent) {
            showStatus('检测到未保存的更改');
            document.title = `* ${currentFile.name} - 现代文本编辑器`;
        }
    }

    // 定时检测（每2秒）
    setInterval(checkFileChange, 2000);

    // 初始化自动保存状态
    window.addEventListener('load', () => {
        const savedState = localStorage.getItem('autoSaveEnabled');
        autoSaveEnabled = savedState !== null ? savedState === 'true' : true;
        autoSaveToggle.checked = autoSaveEnabled;
        if (files.length > 0) {
            currentFile = files[0];
            editor.value = currentFile.content;
        }
        const savedIdeMode = localStorage.getItem('ideModeEnabled');
        ideModeEnabled = savedIdeMode === 'true';
        ideModeToggle.checked = ideModeEnabled;
        initFileList();
    });

    // 监听开关变化
    autoSaveToggle.addEventListener('change', (e) => {
        autoSaveEnabled = e.target.checked;
        localStorage.setItem('autoSaveEnabled', autoSaveEnabled);
        showStatus(`自动保存已${autoSaveEnabled ? '启用' : '禁用'}`);
    });

    // 监听IDE模式开关变化
    ideModeToggle.addEventListener('change', (e) => {
        ideModeEnabled = e.target.checked;
        localStorage.setItem('ideModeEnabled', ideModeEnabled);
        showStatus(`IDE模式已${ideModeEnabled ? '启用' : '禁用'}`);
    });

    // 新增右键菜单逻辑
    let contextMenuFile = null;

    document.addEventListener('click', () => {
        document.getElementById('fileContextMenu').style.display = 'none';
    });

    document.getElementById('fileList').addEventListener('contextmenu', (e) => {
        e.preventDefault();
        const fileItem = e.target.closest('.file-item');
        if (fileItem) {
            contextMenuFile = files.find(f => f.id === fileItem.dataset.id);
            showContextMenu(e.clientX, e.clientY);
        }
    });

    function showContextMenu(x, y) {
        const menu = document.getElementById('fileContextMenu');
        menu.style.display = 'block';
        menu.style.left = `${x}px`;
        menu.style.top = `${y}px`;
    }

    // 新增文件操作功能
    function renameFile() {
        const newName = prompt('请输入新文件名:', contextMenuFile.name);
        if (newName && newName !== contextMenuFile.name) {
            contextMenuFile.name = newName;
            localStorage.setItem('editorFiles', JSON.stringify(files));
            initFileList();
            showStatus('文件名已修改');
        }
    }

    function deleteFile() {
        if (confirm(`确定要删除 ${contextMenuFile.name} 吗？`)) {
            files = files.filter(f => f.id !== contextMenuFile.id);
            if (currentFile?.id === contextMenuFile.id) {
                currentFile = null;
                editor.value = '';
            }
            localStorage.setItem('editorFiles', JSON.stringify(files));
            initFileList();
            showStatus('文件已删除');
            logAction('DELETE', contextMenuFile.name);
        }
    }

    function exportFile() {
        const tempFile = currentFile;
        currentFile = contextMenuFile;
        downloadFile();
        currentFile = tempFile;
    }

    // 初始化文件列表
    function initFileList() {
        const fileList = document.getElementById('fileList');

        // 分离文件夹和文件
        const folders = files.filter(f => f.type === 'folder');
        const normalFiles = files.filter(f => !f.type || f.type === 'file');

        fileList.innerHTML = [
            ...folders.map(folder => `
                    <div class="file-item folder" data-id="${folder.id}">
                        <span>📁 ${folder.name}</span>
                    </div>
                `),
            ...normalFiles.map(file => `
                    <div class="file-item ${file.id === currentFile?.id ? 'active' : ''}"
                         data-id="${file.id}"
                         onclick="openFile('${file.id}')">
                        <span>${file.name}</span>
                        ${file.passwordHash ? '🔒' : ''}
                    </div>
                `)
        ].join('');
    }

    // 修改新建文件按钮调用方式
    function showNewFileModal() {
        document.getElementById('newFileName').value = '';
        document.getElementById('newFileModal').style.display = 'flex';
        // 重置格式选择状态
        document.querySelectorAll('#newFileModal .format-option').forEach(opt => {
            opt.style.background = opt.dataset.format === 'txt' ?
                'rgba(255,255,255,0.1)' : 'transparent';
        });
    }

    function closeNewFileModal() {
        document.getElementById('newFileModal').style.display = 'none';
    }

    // 修改格式选择逻辑
    let selectedFormat = 'txt';
    document.querySelectorAll('#newFileModal .format-option').forEach(option => {
        option.addEventListener('click', function() {
            selectedFormat = this.dataset.format;
            document.getElementById('customFormat').value = ''; // 清空自定义输入
            document.querySelectorAll('#newFileModal .format-option').forEach(opt => {
                opt.style.background = opt === this ? 'rgba(255,255,255,0.1)' : 'transparent';
            });
        });
    });

    // 监听自定义格式输入
    document.getElementById('customFormat').addEventListener('input', function(e) {
        if(e.target.value.trim()) {
            selectedFormat = e.target.value.replace(/[^a-z0-9]/gi, '').toLowerCase();
            document.querySelectorAll('#newFileModal .format-option').forEach(opt => {
                opt.style.background = 'transparent';
            });
        }
    });

    // 更新文件创建逻辑
    function createCustomFile() {
        const fileNameInput = document.getElementById('newFileName').value.trim();
        if (!fileNameInput) {
            showError('文件名不能为空');
            return;
        }

        // 处理自定义格式
        let finalFormat = selectedFormat;
        if(document.getElementById('customFormat').value.trim()) {
            finalFormat = document.getElementById('customFormat').value
                .replace(/[^a-z0-9]/gi, '')
                .toLowerCase();
        }

        // 格式有效性检查
        if(!finalFormat || finalFormat.length > 6) {
            showError('格式无效（1-6位字母数字）');
            return;
        }

        // 自动添加扩展名（如果用户没有输入）
        let finalName = fileNameInput;
        if (!finalName.endsWith(`.${finalFormat}`)) {
            finalName += `.${finalFormat}`;
        }

        // 检查文件名是否已存在
        if (files.some(f => f.name === finalName)) {
            showError('文件名已存在，请使用其他名称');
            return;
        }

        createNewFile(finalFormat, finalName);
        closeNewFileModal();
    }

    // 修改原有createNewFile函数
    async function createNewFile(format, customName = null, password = '') {
        const fileName = customName || `未命名文件_${files.length + 1}.${format}`;
        const newFile = {
            id: Date.now().toString(),
            name: fileName,
            content: format === 'jpg' ? '' : '', // Initialize content for jpg as empty string
            format: format,
            history: [],
            passwordHash: password ? await hashPassword(password) : null
        };
        if (format === 'jpg') {
            newFile.content = ''; // Ensure jpg content is initialized as empty string
        }

        files.push(newFile);
        currentFile = newFile;
        localStorage.setItem('editorFiles', JSON.stringify(files));
        editor.value = '';
        initFileList();
        showStatus('已创建新文件');
        logAction('CREATE', fileName);
    }

    // 密码哈希函数
    async function hashPassword(password) {
        const encoder = new TextEncoder();
        const data = encoder.encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // 打开文件
    async function openFile(fileId) {
        const file = files.find(f => f.id === fileId);

        // 密码验证逻辑
        if (file?.passwordHash) {
            const password = prompt('请输入文件密码:');
            if (!password) {
                showError('必须输入密码');
                return; // 阻止未输入密码的访问
            }

            const inputHash = await hashPassword(password);
            if (inputHash !== file.passwordHash) {
                showError('密码错误');
                return; // 密码错误时终止操作
            }
        }

        // 只有通过验证才会执行打开操作
        if (file) {
            currentFile = file;
            if (file.format === 'jpg') {
                switchToCanvasMode();
                loadCanvasContent(file.content); // Load saved drawing if any
            } else {
                switchToEditorMode();
                editor.value = file.content;
            }
            initFileList();
            logAction('OPEN', file.name); // 记录审计日志
        }
    }

    // 显示状态信息
    function showStatus(message) {
        status.textContent = message;
        status.style.display = 'block';
        setTimeout(() => {
            status.style.display = 'none';
        }, 2000);
    }

    // 修改后的导出功能逻辑
    let exportFormat = 'current';

    function showExportMenu() {
        const defaultName = currentFile?.name.replace(/\.[^/.]+$/, '') || '未命名文件';
        document.getElementById('exportFileName').value = defaultName;
        document.getElementById('exportModal').style.display = 'flex';

        // 设置默认选中当前格式
        document.querySelectorAll('.format-option').forEach(option => {
            option.style.background = option.dataset.format === 'current' ?
                'rgba(255,255,255,0.1)' : 'transparent';
        });
    }

    function closeExportModal() {
        document.getElementById('exportModal').style.display = 'none';
    }

    document.querySelectorAll('#exportModal .format-option').forEach(option => {
        option.addEventListener('click', function() {
            exportFormat = this.dataset.format;
            document.querySelectorAll('#exportModal .format-option').forEach(opt => {
                opt.style.background = opt === this ? 'rgba(255,255,255,0.1)' : 'transparent';
            });
        });
    });

    function handleExport() {
        const fileNameInput = document.getElementById('exportFileName').value.trim();
        if (!fileNameInput) {
            showError('文件名不能为空');
            return;
        }

        let finalFormat = exportFormat === 'current' ? currentFile?.format : exportFormat;
        if (!finalFormat) finalFormat = 'txt';

        let finalName = fileNameInput;
        if (!finalName.endsWith(`.${finalFormat}`)) {
            finalName += `.${finalFormat}`;
        }

        // 格式验证
        if (finalFormat === 'html' && !validateHTML(editor.value)) {
            showError('HTML格式错误，请检查未闭合的标签');
            return;
        }

        // 直接创建Blob进行下载（不再修改currentFile）
        const content = currentFile?.format === 'jpg' ? getCanvasDataURL() : editor.value; // Get canvas data for jpg
        const blob = new Blob([content], {
            type: finalFormat === 'html' ? 'text/html' : (finalFormat === 'jpg' ? 'image/jpeg' : 'text/plain') // Export jpg as jpeg
        });

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = finalName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showStatus(`已导出: ${finalName}`);
        closeExportModal();
    }

    // 恢复原有下载函数逻辑
    function downloadFile() {
        if (!currentFile) return showError('没有可导出的文件');

        const content = currentFile?.format === 'jpg' ? getCanvasDataURL() : editor.value; // Get canvas data for jpg
        const blob = new Blob([content], {
            type: currentFile?.format === 'html' ? 'text/html' : (currentFile?.format === 'jpg' ? 'image/jpeg' : 'text/plain') // Download jpg as jpeg
        });

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = currentFile.name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showStatus('已下载');
    }

    // HTML基础验证
    function validateHTML(content) {
        // 检查未闭合标签
        const tagRegex = /<(\/?[\w\d-]+)(?:\s+[^>]*)?>/g;
        const stack = [];
        let match;

        while ((match = tagRegex.exec(content)) !== null) {
            const tag = match[1].toLowerCase();
            if(tag.startsWith('/')) {
                const expected = stack.pop();
                if(!expected || expected !== tag.slice(1)) {
                    return false;
                }
            } else if(!['br','hr','img','input','meta','link'].includes(tag)) {
                stack.push(tag);
            }
        }

        return stack.length === 0;
    }

    // 显示错误提示
    function showError(message) {
        const toast = document.getElementById('errorToast');
        toast.textContent = message;
        toast.style.display = 'block';
        setTimeout(() => {
            toast.style.display = 'none';
        }, 3000);
    }

    // 修改保存功能
    function saveFile() {
        if(currentFile?.format === 'html' && !validateHTML(editor.value)) {
            showError('无法保存：存在未闭合的HTML标签');
            return;
        }

        // 新增内容同步逻辑
        if (currentFile) {
            currentFile.content = currentFile.format === 'jpg' ? getCanvasDataURL() : editor.value;  // 同步编辑器内容或 canvas data
            const fileIndex = files.findIndex(f => f.id === currentFile.id);
            if (fileIndex > -1) {
                files[fileIndex] = currentFile;  // 更新文件数组中的对应文件
            }
        }

        localStorage.setItem('editorFiles', JSON.stringify(files));
        showStatus('已保存');
        lastSavedContent = editor.value;
        document.title = `${currentFile.name} - 现代文本编辑器`;
    }

    // 新增退出功能
    function logout() {
        if(confirm('确定要退出登录吗？')) {
            // 清除本地存储（如果需要）
            localStorage.removeItem('editorFiles');
            // 跳转到登录页
            window.location.href = 'Login.html';
        }
    }

    // 修改编辑器输入处理
    editor.addEventListener('keydown', (e) => {
        if (ideModeEnabled && e.key === 'Enter') {
            e.preventDefault();
            handleSmartIndent();
        }
    });

    // 智能缩进处理函数
    function handleSmartIndent() {
        const cursorPos = editor.selectionStart;
        const textBefore = editor.value.substring(0, cursorPos);

        // 获取当前行起始位置
        const lineStart = textBefore.lastIndexOf('\n', cursorPos - 1) + 1;
        const currentLine = textBefore.substring(lineStart);

        // 计算缩进量
        const indent = currentLine.match(/^\s*/)[0];
        const newText = '\n' + indent;

        // 插入新内容
        editor.setRangeText(newText, cursorPos, cursorPos, 'end');

        // 触发输入事件以保持自动保存
        const event = new Event('input', { bubbles: true });
        editor.dispatchEvent(event);
    }

    // 新增本地文件操作逻辑
    async function handleFileOpen() {
        try {
            [fileHandle] = await window.showOpenFilePicker({
                types: [{
                    description: '文本文件',
                    accept: {'text/plain': ['.txt','.html','.md']}
                }]
            });

            const file = await fileHandle.getFile();
            const content = await file.text();

            const newFile = {
                id: `local_${Date.now()}`,
                name: file.name,
                content: content,
                format: file.name.split('.').pop(),
                isLocal: true
            };

            files.push(newFile);
            currentFile = newFile;
            editor.value = content;
            initFileList();
            showStatus(`已打开本地文件: ${file.name}`);
        } catch (err) {
            showError('文件操作已取消');
        }
    }

    async function handleFileSave() {
        if (!currentFile?.isLocal) {
            return showError('仅支持保存本地文件');
        }

        try {
            const writable = await fileHandle.createWritable();
            await writable.write(editor.value);
            await writable.close();
            showStatus('文件已保存');
        } catch (err) {
            showError('保存失败，请重试');
        }
    }

    // 新增主题切换逻辑
    function toggleTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('editorTheme', theme);
    }

    // 初始化主题
    const savedTheme = localStorage.getItem('editorTheme') || 'dark';
    toggleTheme(savedTheme);

    // 审计日志逻辑
    let auditLogs = JSON.parse(localStorage.getItem('auditLogs')) || [];

    function logAction(type, fileName) {
        auditLogs.push({
            timestamp: new Date().toISOString(),
            type,
            fileName,
            user: localStorage.getItem('currentUser') || '未登录用户'
        });
        localStorage.setItem('auditLogs', JSON.stringify(auditLogs));
    }

    // 替换原有的showAuditLog函数
    function showAuditLog() {
        // 显示密码输入模态框而不是使用prompt
        document.getElementById('auditPasswordModal').style.display = 'flex';
        document.getElementById('auditPassword').value = '';
        document.getElementById('passwordError').style.display = 'none';
        setTimeout(() => document.getElementById('auditPassword').focus(), 100);
    }
    
    // 新增密码验证函数
    function verifyAuditPassword() {
        const password = document.getElementById('auditPassword').value;
        if (password === 'Admin') {
            closeAuditPasswordModal();
            showAuditLogContent();
        } else {
            document.getElementById('passwordError').style.display = 'block';
            document.getElementById('auditPassword').focus();
        }
    }
    
    // 关闭密码模态框
    function closeAuditPasswordModal() {
        document.getElementById('auditPasswordModal').style.display = 'none';
    }
    
    // 显示密码切换
    document.getElementById('togglePasswordBtn').addEventListener('click', function() {
        const passwordInput = document.getElementById('auditPassword');
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        
        // 切换图标
        this.innerHTML = type === 'password' ? 
            '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>' : 
            '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>';
    });
    
    // 显示审计日志内容
    function showAuditLogContent() {
        // 显示审计日志模态框
        document.getElementById('auditLogModal').style.display = 'flex';
        
        // 更新日志计数
        document.getElementById('logCount').textContent = auditLogs.length;
        
        // 填充日志列表
        refreshLogList();
    }
    
    // 导出审计日志
    function exportAuditLogs() {
        const logsJson = JSON.stringify(auditLogs, null, 2);
        const blob = new Blob([logsJson], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `audit_logs_${new Date().toISOString().slice(0,10)}.log`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showStatus('审计日志已导出');
    }
    
    // 美化后的日志刷新函数
    function refreshLogList() {
        const logList = document.getElementById('auditLogList');
        
        // 获取筛选条件
        const searchText = document.getElementById('logSearchInput')?.value.toLowerCase() || '';
        const typeFilter = document.getElementById('logTypeFilter')?.value || 'all';
        
        // 筛选日志
        const filteredLogs = auditLogs.filter(log => {
            const matchesSearch = (
                log.fileName?.toLowerCase().includes(searchText) || 
                log.user?.toLowerCase().includes(searchText) ||
                log.type?.toLowerCase().includes(searchText)
            );
            
            const matchesType = typeFilter === 'all' || log.type.includes(typeFilter);
            
            return matchesSearch && matchesType;
        });
        
        if (filteredLogs.length === 0) {
            logList.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; color: var(--text-secondary);">
                    <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom: 15px; opacity: 0.5;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M8 12h8"></path>
                        <path d="M12 8v8"></path>
                    </svg>
                    <span>没有找到匹配的日志记录</span>
                </div>
            `;
            return;
        }
        
        logList.innerHTML = filteredLogs.map((log, index) => {
            // 根据操作类型选择颜色和图标
            let typeColor, typeIcon;
            switch(log.type) {
                case 'CREATE':
                    typeColor = 'rgba(76, 175, 80, 0.8)';
                    typeIcon = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"></path></svg>';
                    break;
                case 'DELETE':
                    typeColor = 'rgba(244, 67, 54, 0.8)';
                    typeIcon = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>';
                    break;
                case 'EDIT':
                    typeColor = 'rgba(33, 150, 243, 0.8)';
                    typeIcon = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>';
                    break;
                case 'OPEN':
                    typeColor = 'rgba(121, 85, 72, 0.8)';
                    typeIcon = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>';
                    break;
                case 'IMPORT':
                case 'IMPORT_TO_LIST':
                    typeColor = 'rgba(156, 39, 176, 0.8)';
                    typeIcon = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"></path></svg>';
                    break;
                default:
                    typeColor = 'rgba(158, 158, 158, 0.8)';
                    typeIcon = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>';
            
            case 'STYLE_CHANGE':
            typeColor = 'rgba(255, 193, 7, 0.8)';
            typeIcon = '<svg width="14" height="14" viewBox="0 0 24 24"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>';
            typeDisplay = '样式修改';
            break;

            }
            
            // 格式化操作类型显示
            const typeDisplay = log.type.replace(/_/g, ' ');
            
            return `
                <div class="log-item" style="
                    padding: 15px; 
                    margin-bottom: 10px; 
                    background: var(--secondary-bg); 
                    border-radius: 10px;
                    border-left: 4px solid ${typeColor};
                    transition: transform 0.2s ease, box-shadow 0.2s ease;
                    position: relative;
                    overflow: hidden;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)';"
                   onmouseout="this.style.transform='none'; this.style.boxShadow='none';">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="display: flex; flex-direction: column;">
                            <div style="font-weight: 500; font-size: 16px; margin-bottom: 5px; color: var(--text-color);">
                                ${log.fileName || '系统操作'}
                            </div>
                            <div style="color: var(--text-secondary); font-size: 13px;">
                                操作人: ${log.user || '未登录用户'} · ${new Date(log.timestamp).toLocaleString()}
                            </div>
                        </div>
                        <div style="
                            display: flex; 
                            align-items: center; 
                            background: ${typeColor}; 
                            color: white; 
                            padding: 4px 10px;
                            border-radius: 20px;
                            font-size: 12px;
                            font-weight: 500;
                        ">
                            ${typeIcon}
                            <span style="margin-left: 5px;">${typeDisplay}</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

    // 在日志条目中添加：
    if (log.type === 'STYLE_CHANGE') {
    entry += `<div class="log-detail">属性: ${log.property}</div>
              <div class="log-detail">旧值: ${log.oldValue || '无'}</div>
              <div class="log-detail">新值: ${log.newValue || '重置'}</div>`;
    }
    }
    
    // 为搜索输入框添加事件监听
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('logSearchInput');
        const typeFilter = document.getElementById('logTypeFilter');
        
        if (searchInput) {
            searchInput.addEventListener('input', refreshLogList);
        }
        
        if (typeFilter) {
            typeFilter.addEventListener('change', refreshLogList);
        }
    });

    function closeAuditModal() {
        document.getElementById('auditLogModal').style.display = 'none';
    }

    function updateAvatar() {
        const newPath = document.getElementById('avatarPath').value;
        if(newPath) {
            document.getElementById('userAvatar').src = newPath;
            localStorage.setItem('userAvatarPath', newPath);
            showStatus('头像已更新');
        }
    }

    // 初始化用户设置
    const savedAvatarPath = localStorage.getItem('userAvatarPath');
    if(savedAvatarPath) {
        document.getElementById('userAvatar').src = savedAvatarPath;
    }

    // 修改新建文件夹调用方式
    function createNewFolder() {
        showNewFolderModal();
    }

    // 新增文件夹弹窗控制函数
    function showNewFolderModal() {
        document.getElementById('folderNameInput').value = '新建文件夹';
        document.getElementById('newFolderModal').style.display = 'flex';
    }

    function closeNewFolderModal() {
        document.getElementById('newFolderModal').style.display = 'none';
    }

    // 更新文件夹创建逻辑
    function confirmCreateFolder() {
        const folderName = document.getElementById('folderNameInput').value.trim();
        if (!folderName) {
            showError('文件夹名称不能为空');
            return;
        }

        // 检查名称冲突
        const existingNames = files.filter(f => f.type === 'folder').map(f => f.name);
        let finalName = folderName;
        let counter = 1;
        while (existingNames.includes(finalName)) {
            finalName = `${folderName} (${counter++})`;
        }

        const newFolder = {
            id: `folder_${Date.now()}`,
            name: finalName,
            type: 'folder',
            children: [],
            created: new Date().toISOString()
        };

        files.push(newFolder);
        localStorage.setItem('editorFiles', JSON.stringify(files));
        initFileList();
        closeNewFolderModal();
        showStatus('文件夹已创建');
        logAction('CREATE_FOLDER', finalName);
    }

    // 新增行号显示状态
    let lineNumbersEnabled = false;
    const lineNumberToggle = document.getElementById('lineNumberToggle');
    const lineNumbers = document.getElementById('lineNumbers');

    // 初始化行号状态
    lineNumberToggle.addEventListener('change', function() {
        lineNumbersEnabled = this.checked;
        lineNumbers.style.display = lineNumbersEnabled ? 'block' : 'none';
        updateLineNumbers();
        localStorage.setItem('lineNumbersEnabled', lineNumbersEnabled);
    });

    // 初始化时读取存储状态
    const savedLineNumbers = localStorage.getItem('lineNumbersEnabled') === 'true';
    lineNumberToggle.checked = savedLineNumbers;
    lineNumbers.style.display = savedLineNumbers ? 'block' : 'none';

    // 更新行号逻辑
    function updateLineNumbers() {
        if (!lineNumbersEnabled) return;

        const lines = editor.value.split('\n');
        const cursorPos = editor.selectionStart;
        const textBeforeCursor = editor.value.substr(0, cursorPos);
        const currentLine = textBeforeCursor.split('\n').length;

        lineNumbers.innerHTML = lines
            .map((_, i) => `
                    <div class="${i + 1 === currentLine ? 'active-line' : ''}">
                        ${i + 1}
                    </div>
                `).join('');
    }

    // 添加节流滚动处理
    let isScrolling = false;
    editor.addEventListener('scroll', () => {
        if (!isScrolling) {
            window.requestAnimationFrame(() => {
                lineNumbers.scrollTop = editor.scrollTop;
                isScrolling = false;
            });
            isScrolling = true;
        }
    });

    // 添加窗口大小变化监听
    window.addEventListener('resize', () => {
        lineNumbers.style.height = `${editor.offsetHeight}px`;
        const lineHeight = getComputedStyle(editor).lineHeight;
        lineNumbers.style.lineHeight = lineHeight; // 同步行高
    });

    // 监听编辑器输入
    editor.addEventListener('input', () => {
        updateLineNumbers();
        // ... existing input handling ...
    });

    // 新增搜索相关状态
    let searchMatches = [];
    let currentMatchIndex = -1;
    let caseSensitive = false;

    // 新增搜索面板交互逻辑
    let dragData = {
        isDragging: false,
        startX: 0,
        startY: 0,
        initialX: 0,
        initialY: 0
    };

    function toggleSearchPanel() {
        const isVisible = searchPanel.style.display === 'block';
        searchPanel.style.display = isVisible ? 'none' : 'block';
        searchPanelToggle.checked = !isVisible;

        if (!isVisible) {
            searchInput.focus();
        }
        localStorage.setItem('searchPanelState', !isVisible);
    }

    // 初始化时读取面板状态
    const savedPanelState = localStorage.getItem('searchPanelState') === 'true';
    searchPanelToggle.checked = savedPanelState;
    searchPanel.style.display = savedPanelState ? 'block' : 'none';

    // 修改快捷键处理
    editor.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
            e.preventDefault();
            searchPanelToggle.click(); // 切换开关状态
        }
    });

    // 执行搜索
    function performSearch() {
        const searchText = searchInput.value;
        if (!searchText) {
            clearHighlights();
            return;
        }

        const flags = caseSensitive ? 'g' : 'gi';
        const regex = new RegExp(escapeRegExp(searchText), flags);

        // 获取编辑器内容
        const content = editor.value;
        searchMatches = [];

        // 查找所有匹配项
        let match;
        while ((match = regex.exec(content)) !== null) {
            searchMatches.push({
                start: match.index,
                end: match.index + match[0].length
            });
        }

        updateHighlights();
        updateMatchesDisplay();
    }

    // 更新高亮显示
    function updateHighlights() {
        clearHighlights();

        const content = editor.value;
        let highlightedContent = content;
        let offset = 0;

        searchMatches.forEach((match, index) => {
            const start = match.start + offset;
            const end = match.end + offset;
            const highlightClass = index === currentMatchIndex ?
                'current-highlight' : 'highlight';

            highlightedContent =
                highlightedContent.slice(0, start) +
                `<span class="${highlightClass}">` +
                highlightedContent.slice(start, end) +
                '</span>' +
                highlightedContent.slice(end);

            offset += 27 + highlightClass.length; // 补偿插入的HTML长度
        });

        // 使用临时div保持滚动位置
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = highlightedContent;
        editor.nextSibling.innerHTML = tempDiv.innerHTML;
    }

    // 清除高亮
    function clearHighlights() {
        const spans = editor.nextSibling.querySelectorAll('span');
        spans.forEach(span => {
            const parent = span.parentNode;
            while (span.firstChild) parent.insertBefore(span.firstChild, span);
            parent.removeChild(span);
        });
        currentMatchIndex = -1;
    }

    // 更新匹配计数显示
    function updateMatchesDisplay() {
        const total = searchMatches.length;
        const current = total > 0 ? currentMatchIndex + 1 : 0;
        matchesDisplay.textContent = `${current}/${total}`;
    }

    // 查找下一个
    function findNext() {
        if (searchMatches.length === 0) return;
        currentMatchIndex = (currentMatchIndex + 1) % searchMatches.length;
        scrollToMatch();
        updateHighlights();
    }

    // 查找上一个
    function findPrev() {
        if (searchMatches.length === 0) return;
        currentMatchIndex = (currentMatchIndex - 1 + searchMatches.length) % searchMatches.length;
        scrollToMatch();
        updateHighlights();
    }

    // 滚动到当前匹配项
    function scrollToMatch() {
        if (currentMatchIndex === -1) return;

        const match = searchMatches[currentMatchIndex];
        const line = editor.value.substr(0, match.start).split('\n').length - 1;
        const lineHeight = parseInt(getComputedStyle(editor).lineHeight);
        editor.scrollTop = line * lineHeight - editor.offsetHeight / 2;
    }

    // 工具函数：转义正则特殊字符
    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // 事件监听
    searchInput.addEventListener('input', () => {
        performSearch();
    });

    caseSensitiveToggle.addEventListener('change', function() {
        caseSensitive = this.checked;
        performSearch();
    });

    // 修改拖动处理逻辑
    searchPanel.addEventListener('mousedown', (e) => {
        // 仅允许通过标题栏拖动
        const header = e.target.closest('.search-panel-header');
        if (!header) return;

        dragData = {
            isDragging: true,
            startX: e.clientX,
            startY: e.clientY,
            initialX: searchPanel.offsetLeft,
            initialY: searchPanel.offsetTop
        };

        document.addEventListener('mousemove', handleDrag);
        document.addEventListener('mouseup', stopDrag);
    });

    function handleDrag(e) {
        if (!dragData.isDragging) return;

        const dx = e.clientX - dragData.startX;
        const dy = e.clientY - dragData.startY;

        searchPanel.style.left = `${dragData.initialX + dx}px`;
        searchPanel.style.top = `${dragData.initialY + dy}px`;
    }

    function stopDrag() {
        dragData.isDragging = false;
        document.removeEventListener('mousemove', handleDrag);
        document.removeEventListener('mouseup', stopDrag);
    }

    // 新增字体控制逻辑
    function updateFontSize(size) {
        document.documentElement.style.setProperty('--editor-font-size', `${size}px`);
        localStorage.setItem('editorFontSize', size);
    }

    function updateFontFamily(font) {
        document.documentElement.style.setProperty('--editor-font-family', font);
        localStorage.setItem('editorFontFamily', font);
    }

    // 初始化字体设置
    const savedFontSize = localStorage.getItem('editorFontSize') || '16';
    const savedFontFamily = localStorage.getItem('editorFontFamily') || 'system-ui';
    document.getElementById('fontSizeSelect').value = savedFontSize;
    document.getElementById('fontFamilySelect').value = savedFontFamily;
    updateFontSize(savedFontSize);
    updateFontFamily(savedFontFamily);

    // 新增清除日志处理函数
    function handleClearLogs() {
        const password = prompt('请输入管理员密码:');
        if (password !== 'Admin') {
            showError('密码错误');
            return;
        }

        auditLogs = [];
        localStorage.setItem('auditLogs', JSON.stringify(auditLogs));
        refreshLogList();
        showStatus('日志已清除');
    }

    // 修改后的日志刷新函数
    function refreshLogList() {
        const logList = document.getElementById('auditLogList');
        logList.innerHTML = auditLogs.map(log => `
                <div class="log-item" style="padding: 12px; margin-bottom: 8px; background: var(--secondary-bg); border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary); font-size: 12px;">
                            ${new Date(log.timestamp).toLocaleString()}
                        </span>
                        <span style="color: var(--accent-blue); font-weight: 500;">
                            ${log.type.replace(/_/g, ' ')}
                        </span>
                    </div>
                    <div style="margin-top: 6px;">${log.fileName || '系统操作'}</div>
                    <div style="color: var(--text-secondary); font-size: 12px; margin-top: 4px;">
                        操作人: ${log.user || '未登录用户'}
                    </div>
                </div>
            `).join('');
    }

    // 修改用户名保存逻辑
    function saveUserName() {
        const userName = document.getElementById('userNameInput').value.trim();
        if (!userName) {
            showError('用户名不能为空');
            return;
        }
        localStorage.setItem('currentUser', userName);
        document.getElementById('username').textContent = userName; // 同步更新左上角显示
        showStatus('用户已设置为: ' + userName);
    }

    // 初始化时更新左上角用户名
    const currentUser = localStorage.getItem('currentUser') || '未登录用户';
    document.getElementById('userNameInput').value = currentUser;
    document.getElementById('username').textContent = currentUser;

    // 新增拼写检查开关处理函数
    function toggleSpellCheck() {
        const enabled = document.getElementById('spellCheckToggle').checked;
        editor.spellcheck = enabled;
        localStorage.setItem('spellCheckEnabled', enabled);
        showStatus(`拼写检查已${enabled ? '启用' : '禁用'}`);
    }

    // 初始化拼写检查状态
    const savedSpellCheck = localStorage.getItem('spellCheckEnabled');
    const spellCheckEnabled = savedSpellCheck !== null ? savedSpellCheck === 'true' : true;
    document.getElementById('spellCheckToggle').checked = spellCheckEnabled;
    editor.spellcheck = spellCheckEnabled;

    let sidebarExpanded = false;
    let toolbarExpanded = false;

    function toggleSidebar() {
        const container = document.querySelector('.container');
        const button = document.getElementById('sidebarToggleButton');
        const sidebarToggleBar = document.getElementById('sidebarToggleBar');

        if (sidebarExpanded) {
            container.classList.remove('sidebar-expanded');
            sidebarExpanded = false;
            button.textContent = '展开左侧';
            sidebarToggleBar.style.display = 'block'; // 显示展开条
        } else {
            // 如果右侧已展开，先折叠右侧
            if (toolbarExpanded) {
                toggleToolbar();
            }
            container.classList.add('sidebar-expanded');
            sidebarExpanded = true;
            button.textContent = '折叠左侧';
            sidebarToggleBar.style.display = 'none'; // 隐藏展开条
        }
    }

    function toggleToolbar() {
        const container = document.querySelector('.container');
        const button = document.getElementById('toolbarToggleButton');
        const toolbarToggleBar = document.getElementById('toolbarToggleBar');
        const toolbar = document.querySelector('.toolbar'); // 获取toolbar元素

        if (toolbarExpanded) {
            container.classList.remove('toolbar-expanded');
            toolbarExpanded = false;
            button.textContent = '展开右侧';
            toolbarToggleBar.style.display = 'block'; // 显示展开条
        } else {
            // 如果左侧已展开，先折叠左侧
            if (sidebarExpanded) {
                toggleSidebar();
            }
            container.classList.add('toolbar-expanded');
            toolbarExpanded = true;
            button.textContent = '折叠右侧';
            toolbarToggleBar.style.display = 'none'; // 隐藏展开条
        }
    }

    // 页面加载时检查屏幕宽度
    window.addEventListener('load', () => {
        if (window.innerWidth <= 768) {
            // 默认折叠左右两侧
            const container = document.querySelector('.container');
            container.classList.remove('sidebar-expanded', 'toolbar-expanded');
            sidebarExpanded = false;
            toolbarExpanded = false;

            // 手机模式下显示展开条
            document.getElementById('sidebarToggleBar').style.display = 'block';
            document.getElementById('toolbarToggleBar').style.display = 'block';
        }
    });

    // Canvas drawing variables
    const htyCanvas = document.getElementById('htyCanvas');
    const ctx = htyCanvas.getContext('2d');
    let drawing = false;
    let currentPos = { x: 0, y: 0 };
    let lastPos = { x: 0, y: 0 };
    let penColor = '#000000'; // Default pen color black
    let zoomLevel = 1; // Initialize zoom level to 1 (no zoom)

    function switchToCanvasMode() {
        editor.style.display = 'none';
        lineNumbers.style.display = 'none';
        htyCanvas.style.display = 'block';
        htyCanvas.style.backgroundColor = 'white'; // Set canvas background to white
    }

    function switchToEditorMode() {
        editor.style.display = 'block';
        lineNumbers.style.display = lineNumberToggle.checked ? 'block' : 'none';
        htyCanvas.style.display = 'none';
        document.querySelector('.editor-container').style.backgroundColor = ''; // Revert to default background
    }

    htyCanvas.addEventListener('mousedown', startDrawing);
    htyCanvas.addEventListener('mouseup', stopDrawing);
    htyCanvas.addEventListener('mouseout', stopDrawing);
    htyCanvas.addEventListener('mousemove', draw);
    htyCanvas.addEventListener('wheel', handleWheelZoom); // Add wheel event listener

    function getMousePos(canvas, evt) {
        const rect = canvas.getBoundingClientRect();
        return {
            x: (evt.clientX - rect.left) / zoomLevel, // 除以 zoomLevel
            y: (evt.clientY - rect.top) / zoomLevel  // 除以 zoomLevel
        };
    }

    function startDrawing(e) {
        drawing = true;
        lastPos = getMousePos(htyCanvas, e);
    }

    function stopDrawing() {
        drawing = false;
    }

    function draw(e) {
        if (!drawing) return;

        currentPos = getMousePos(htyCanvas, e);

        ctx.beginPath();
        ctx.moveTo(lastPos.x, lastPos.y);
        ctx.lineTo(currentPos.x, currentPos.y);
        ctx.strokeStyle = penColor; // Use current pen color
        ctx.lineWidth = 2; // Default line width
        ctx.lineCap = 'round';
        ctx.stroke();

        lastPos = currentPos;
    }

    function handleWheelZoom(e) {
        e.preventDefault(); // Prevent page scroll

        const zoomSpeed = 0.1;
        if (e.deltaY < 0) {
            zoomLevel += zoomSpeed; // Zoom in
        } else {
            zoomLevel -= zoomSpeed; // Zoom out
        }
        zoomLevel = Math.max(0.1, zoomLevel); // Prevent zoom level from becoming too small

        const mousePos = getMousePos(htyCanvas, e); // Get mouse position
        const mouseX = mousePos.x;
        const mouseY = mousePos.y;

        ctx.clearRect(0, 0, htyCanvas.width, htyCanvas.height); // Clear canvas

        // Apply zoom and translate to zoom around mouse cursor
        ctx.translate(mouseX, mouseY);       // Translate to mouse position
        ctx.scale(zoomLevel, zoomLevel);     // Scale around mouse position
        ctx.translate(-mouseX, -mouseY);      // Translate back

        loadCanvasContent(currentFile.content); // Redraw the content at new zoom level
    }

    function getCanvasDataURL() {
        return htyCanvas.toDataURL('image/jpeg', 0.9); // Use JPEG format, 90% quality
    }

    function loadCanvasContent(dataURL) {
        if (!dataURL) return;
        const img = new Image();
        img.onload = function() {
            ctx.drawImage(img, 0, 0);
        };
        img.src = dataURL;
    }

    let hexPreviewVisible = false;
let isDraggingHexPanel = false;
let hexPanelPosition = { x: 100, y: 150 };
let dragStartPosition = { x: 0, y: 0 };

function toggleHexPreview() {
    const panel = document.getElementById('hexPreviewPanel');
    if (!panel) {
        createHexPreviewPanel();
        return;
    }
    hexPreviewVisible = !hexPreviewVisible;
    panel.style.display = hexPreviewVisible ? 'block' : 'none';
    if (hexPreviewVisible) updateHexPreview();
}

function createHexPreviewPanel() {
    const panel = document.createElement('div');
    panel.id = 'hexPreviewPanel';
    panel.className = 'hex-preview-panel';
    panel.style.display = 'block';
    panel.style.left = `${hexPanelPosition.x}px`;
    panel.style.top = `${hexPanelPosition.y}px`;
    
    panel.innerHTML = `
        <div class="hex-preview-header">
            <div>进制查看器</div>
            <button onclick="toggleHexPreview()" style="background:none;border:none;color:var(--text-color);cursor:pointer;">×</button>
        </div>
        <div class="hex-view">
            <div class="hex-row">
                <span class="hex-label">HEX:</span>
                <span class="hex-value" id="hexValue"></span>
            </div>
            <div class="hex-row">
                <span class="hex-label">DEC:</span>
                <span class="hex-value" id="decValue"></span>
            </div>
            <div class="hex-row">
                <span class="hex-label">BIN:</span>
                <span class="hex-value" id="binValue"></span>
            </div>
        </div>
    `;

    // 拖拽功能
    panel.addEventListener('mousedown', startDrag);
    document.addEventListener('mousemove', handleDrag);
    document.addEventListener('mouseup', stopDrag);
    
    document.body.appendChild(panel);
    hexPreviewVisible = true;
    updateHexPreview();
}

function startDrag(e) {
    if (e.target.closest('.hex-preview-header')) {
        isDraggingHexPanel = true;
        dragStartPosition.x = e.clientX - hexPanelPosition.x;
        dragStartPosition.y = e.clientY - hexPanelPosition.y;
    }
}

function handleDrag(e) {
    if (!isDraggingHexPanel) return;
    hexPanelPosition.x = e.clientX - dragStartPosition.x;
    hexPanelPosition.y = e.clientY - dragStartPosition.y;
    const panel = document.getElementById('hexPreviewPanel');
    if (panel) {
        panel.style.left = `${hexPanelPosition.x}px`;
        panel.style.top = `${hexPanelPosition.y}px`;
    }
}

function stopDrag() {
    isDraggingHexPanel = false;
}

function updateHexPreview() {
    const selection = window.getSelection().toString();
    const text = selection || editor.value.substring(0, 256); // 显示选中文本或前256字符
    
    // 转换为字节数组
    const encoder = new TextEncoder();
    const bytes = encoder.encode(text);
    
    // HEX显示
    const hex = Array.from(bytes)
        .map(b => b.toString(16).padStart(2, '0'))
        .join(' ');
    
    // DEC显示
    const dec = Array.from(bytes)
        .map(b => b.toString().padStart(3, '0'))
        .join(' ');
    
    // BIN显示
    const bin = Array.from(bytes)
        .map(b => b.toString(2).padStart(8, '0'))
        .join(' ');
    
    document.getElementById('hexValue').textContent = hex;
    document.getElementById('decValue').textContent = dec;
    document.getElementById('binValue').textContent = bin;
}

// 监听编辑器变化
editor.addEventListener('input', () => {
    if (hexPreviewVisible) updateHexPreview();
});

// 监听文本选择变化
document.addEventListener('selectionchange', () => {
    if (hexPreviewVisible) updateHexPreview();
});

    // Pen color change listener
    document.getElementById('penColorPicker').addEventListener('input', (e) => {
        penColor = e.target.value;
    });

    // 获取按钮元素
    const htmlIdeButton = document.getElementById('htmlIdeButton');

    // 添加点击事件监听器
    document.addEventListener("DOMContentLoaded", function() {
    const ideButton = document.getElementById('htmlIdeButton');
    
    if(ideButton) {
        ideButton.addEventListener('click', function() {
            window.location.href = 'HTML IDE.html';
        });
    } else {
        console.error('错误：未找到 HTML IDE 按钮元素');
    }
});

    // 新增导入按钮样式
    document.head.insertAdjacentHTML('beforeend', `
        <style>
            .import-btn {
                background: rgba(74, 144, 226, 0.3);
                border-color: rgba(74, 144, 226, 0.4);
            }
            .import-btn:hover {
                background: rgba(74, 144, 226, 0.4);
            }
        </style>
    `);
    
    // 触发隐藏的文件输入
    function triggerFileInput() {
        document.getElementById('fileInput').click();
    }
    
    // 显示所选文件名
    document.getElementById('fileInput').addEventListener('change', function() {
        const fileName = this.files.length > 0 ? this.files[0].name : '未选择文件';
        document.getElementById('selectedFileName').textContent = fileName;
        
        // 更改拖放区域样式以指示已选择文件
        const dropArea = document.getElementById('dropArea');
        if (this.files.length > 0) {
            dropArea.style.borderColor = 'rgba(74, 144, 226, 0.6)';
            dropArea.style.background = 'rgba(74, 144, 226, 0.1)';
            dropArea.innerHTML = `<div style="font-size: 14px;">已选择: ${fileName}</div>`;
        } else {
            resetDropArea();
        }
    });
    
    // 初始化拖放功能
    function initDropArea() {
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        
        // 阻止默认拖放行为
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        // 高亮拖放区域
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            dropArea.style.borderColor = 'rgba(74, 144, 226, 0.8)';
            dropArea.style.background = 'rgba(74, 144, 226, 0.2)';
        }
        
        function unhighlight() {
            resetDropArea();
        }
        
        // 处理拖放的文件
        dropArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                fileInput.files = files;
                const event = new Event('change');
                fileInput.dispatchEvent(event);
            }
        }
    }
    
    function resetDropArea() {
        const dropArea = document.getElementById('dropArea');
        dropArea.style.borderColor = 'var(--border-color)';
        dropArea.style.background = 'var(--secondary-bg)';
        dropArea.innerHTML = '<div style="font-size: 14px;">或将文件拖放到此处</div>';
    }
    
    // 导入功能相关函数
    function importFile() {
        document.getElementById('importModal').style.display = 'flex';
        document.getElementById('fileInput').value = ''; // 清空之前的选择
        resetDropArea();
        document.getElementById('selectedFileName').textContent = '未选择文件';
        initDropArea(); // 初始化拖放功能
    }
    
    function closeImportModal() {
        document.getElementById('importModal').style.display = 'none';
    }
    
    // 修改导入处理函数，添加导入到列表选项的逻辑
    function processImport() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        
        if (!file) {
            showError('请选择要导入的文件');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            const importMode = document.querySelector('input[name="importMode"]:checked').value;
            
            // 处理导入到列表的情况
            if (importMode === 'toList') {
                // 创建新文件添加到列表
                const newFile = {
                    id: Date.now().toString(),
                    name: file.name,
                    content: content,
                    format: file.name.split('.').pop() || 'txt',
                    history: []
                };
                
                files.push(newFile);
                localStorage.setItem('editorFiles', JSON.stringify(files));
                initFileList();
                showStatus('文件已导入到列表');
                logAction('IMPORT_TO_LIST', file.name);
            } else {
                // 原有的导入逻辑
                if (!currentFile) {
                    // 如果没有打开的文件，创建一个新文件
                    const newFile = {
                        id: Date.now().toString(),
                        name: file.name,
                        content: content,
                        format: file.name.split('.').pop() || 'txt',
                        history: []
                    };
                    
                    files.push(newFile);
                    currentFile = newFile;
                    editor.value = content;
                } else {
                    // 根据选择的模式处理内容
                    if (importMode === 'replace') {
                        editor.value = content;
                    } else if (importMode === 'append') {
                        editor.value += '\n' + content;
                    }
                    
                    // 更新当前文件内容
                    if (currentFile.format === 'jpg') {
                        // 对于绘图文件，需要特殊处理
                        loadImageToCanvas(content);
                    } else {
                        currentFile.content = editor.value;
                    }
                }
                
                lastSavedContent = editor.value;
                showStatus('文件导入成功');
                logAction('IMPORT', file.name);
            }
            
            localStorage.setItem('editorFiles', JSON.stringify(files));
            closeImportModal();
        };
        
        reader.onerror = function() {
            showError('读取文件时出错');
        };
        
        if (file.type.startsWith('image/') || file.name.endsWith('.jpg')) {
            reader.readAsDataURL(file); // 对于图片文件或.jpg文件，以DataURL格式读取
        } else {
            reader.readAsText(file); // 对于文本文件，以文本格式读取
        }
    }
    
    // 处理图片导入到画布
    function loadImageToCanvas(dataURL) {
        if (currentFile && currentFile.format === 'jpg') {
            switchToCanvasMode();
            const img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, htyCanvas.width, htyCanvas.height);
                ctx.drawImage(img, 0, 0);
                currentFile.content = htyCanvas.toDataURL('image/jpeg', 0.9);
            };
            img.src = dataURL;
        }
    }

    // 添加点击事件监听器
    document.addEventListener("DOMContentLoaded", function() {
    const secureboxButton = document.getElementById('secureboxButton');
    
    if(secureboxButton) {
        secureboxButton.addEventListener('click', function() {
            window.location.href = 'ZIP Pro.html';
        });
    } else {
        console.error('错误：未找到 HTML IDE 按钮元素');
    }
});

    // 新增导入按钮样式
    document.head.insertAdjacentHTML('beforeend', `
        <style>
            .import-btn {
                background: rgba(74, 144, 226, 0.3);
                border-color: rgba(74, 144, 226, 0.4);
            }
            .import-btn:hover {
                background: rgba(74, 144, 226, 0.4);
            }
        </style>
    `);
    
    // 触发隐藏的文件输入
    function triggerFileInput() {
        document.getElementById('fileInput').click();
    }
    
    // 显示所选文件名
    document.getElementById('fileInput').addEventListener('change', function() {
        const fileName = this.files.length > 0 ? this.files[0].name : '未选择文件';
        document.getElementById('selectedFileName').textContent = fileName;
        
        // 更改拖放区域样式以指示已选择文件
        const dropArea = document.getElementById('dropArea');
        if (this.files.length > 0) {
            dropArea.style.borderColor = 'rgba(74, 144, 226, 0.6)';
            dropArea.style.background = 'rgba(74, 144, 226, 0.1)';
            dropArea.innerHTML = `<div style="font-size: 14px;">已选择: ${fileName}</div>`;
        } else {
            resetDropArea();
        }
    });
    
    // 初始化拖放功能
    function initDropArea() {
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        
        // 阻止默认拖放行为
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        // 高亮拖放区域
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            dropArea.style.borderColor = 'rgba(74, 144, 226, 0.8)';
            dropArea.style.background = 'rgba(74, 144, 226, 0.2)';
        }
        
        function unhighlight() {
            resetDropArea();
        }
        
        // 处理拖放的文件
        dropArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                fileInput.files = files;
                const event = new Event('change');
                fileInput.dispatchEvent(event);
            }
        }
    }
    
    function resetDropArea() {
        const dropArea = document.getElementById('dropArea');
        dropArea.style.borderColor = 'var(--border-color)';
        dropArea.style.background = 'var(--secondary-bg)';
        dropArea.innerHTML = '<div style="font-size: 14px;">或将文件拖放到此处</div>';
    }
    
    // 导入功能相关函数
    function importFile() {
        document.getElementById('importModal').style.display = 'flex';
        document.getElementById('fileInput').value = ''; // 清空之前的选择
        resetDropArea();
        document.getElementById('selectedFileName').textContent = '未选择文件';
        initDropArea(); // 初始化拖放功能
    }
    
    function closeImportModal() {
        document.getElementById('importModal').style.display = 'none';
    }
    
    // 修改导入处理函数，添加导入到列表选项的逻辑
    function processImport() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        
        if (!file) {
            showError('请选择要导入的文件');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            const importMode = document.querySelector('input[name="importMode"]:checked').value;
            
            // 处理导入到列表的情况
            if (importMode === 'toList') {
                // 创建新文件添加到列表
                const newFile = {
                    id: Date.now().toString(),
                    name: file.name,
                    content: content,
                    format: file.name.split('.').pop() || 'txt',
                    history: []
                };
                
                files.push(newFile);
                localStorage.setItem('editorFiles', JSON.stringify(files));
                initFileList();
                showStatus('文件已导入到列表');
                logAction('IMPORT_TO_LIST', file.name);
            } else {
                // 原有的导入逻辑
                if (!currentFile) {
                    // 如果没有打开的文件，创建一个新文件
                    const newFile = {
                        id: Date.now().toString(),
                        name: file.name,
                        content: content,
                        format: file.name.split('.').pop() || 'txt',
                        history: []
                    };
                    
                    files.push(newFile);
                    currentFile = newFile;
                    editor.value = content;
                } else {
                    // 根据选择的模式处理内容
                    if (importMode === 'replace') {
                        editor.value = content;
                    } else if (importMode === 'append') {
                        editor.value += '\n' + content;
                    }
                    
                    // 更新当前文件内容
                    if (currentFile.format === 'jpg') {
                        // 对于绘图文件，需要特殊处理
                        loadImageToCanvas(content);
                    } else {
                        currentFile.content = editor.value;
                    }
                }
                
                lastSavedContent = editor.value;
                showStatus('文件导入成功');
                logAction('IMPORT', file.name);
            }
            
            localStorage.setItem('editorFiles', JSON.stringify(files));
            closeImportModal();
        };
        
        reader.onerror = function() {
            showError('读取文件时出错');
        };
        
        if (file.type.startsWith('image/') || file.name.endsWith('.jpg')) {
            reader.readAsDataURL(file); // 对于图片文件或.jpg文件，以DataURL格式读取
        } else {
            reader.readAsText(file); // 对于文本文件，以文本格式读取
        }
    }
    
    // 处理图片导入到画布
    function loadImageToCanvas(dataURL) {
        if (currentFile && currentFile.format === 'jpg') {
            switchToCanvasMode();
            const img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, htyCanvas.width, htyCanvas.height);
                ctx.drawImage(img, 0, 0);
                currentFile.content = htyCanvas.toDataURL('image/jpeg', 0.9);
            };
            img.src = dataURL;
        }
    }

    // 添加点击事件监听器
    document.addEventListener("DOMContentLoaded", function() {
    const secureboxButton = document.getElementById('secureboxButton');
    
    if(secureboxButton) {
        secureboxButton.addEventListener('click', function() {
            window.location.href = 'ZIP Pro.html';
        });
    } else {
        console.error('错误：未找到 HTML IDE 按钮元素');
    }
});

    // 新增导入按钮样式
    document.head.insertAdjacentHTML('beforeend', `
        <style>
            .import-btn {
                background: rgba(74, 144, 226, 0.3);
                border-color: rgba(74, 144, 226, 0.4);
            }
            .import-btn:hover {
                background: rgba(74, 144, 226, 0.4);
            }
        </style>
    `);
    
    // 触发隐藏的文件输入
    function triggerFileInput() {
        document.getElementById('fileInput').click();
    }
    
    // 显示所选文件名
    document.getElementById('fileInput').addEventListener('change', function() {
        const fileName = this.files.length > 0 ? this.files[0].name : '未选择文件';
        document.getElementById('selectedFileName').textContent = fileName;
        
        // 更改拖放区域样式以指示已选择文件
        const dropArea = document.getElementById('dropArea');
        if (this.files.length > 0) {
            dropArea.style.borderColor = 'rgba(74, 144, 226, 0.6)';
            dropArea.style.background = 'rgba(74, 144, 226, 0.1)';
            dropArea.innerHTML = `<div style="font-size: 14px;">已选择: ${fileName}</div>`;
        } else {
            resetDropArea();
        }
    });
    
    // 初始化拖放功能
    function initDropArea() {
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        
        // 阻止默认拖放行为
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        // 高亮拖放区域
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            dropArea.style.borderColor = 'rgba(74, 144, 226, 0.8)';
            dropArea.style.background = 'rgba(74, 144, 226, 0.2)';
        }
        
        function unhighlight() {
            resetDropArea();
        }
        
        // 处理拖放的文件
        dropArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                fileInput.files = files;
                const event = new Event('change');
                fileInput.dispatchEvent(event);
            }
        }
    }
    
    function resetDropArea() {
        const dropArea = document.getElementById('dropArea');
        dropArea.style.borderColor = 'var(--border-color)';
        dropArea.style.background = 'var(--secondary-bg)';
        dropArea.innerHTML = '<div style="font-size: 14px;">或将文件拖放到此处</div>';
    }
    
    // 导入功能相关函数
    function importFile() {
        document.getElementById('importModal').style.display = 'flex';
        document.getElementById('fileInput').value = ''; // 清空之前的选择
        resetDropArea();
        document.getElementById('selectedFileName').textContent = '未选择文件';
        initDropArea(); // 初始化拖放功能
    }
    
    function closeImportModal() {
        document.getElementById('importModal').style.display = 'none';
    }
    
    // 修改导入处理函数，添加导入到列表选项的逻辑
    function processImport() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        
        if (!file) {
            showError('请选择要导入的文件');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            const importMode = document.querySelector('input[name="importMode"]:checked').value;
            
            // 处理导入到列表的情况
            if (importMode === 'toList') {
                // 创建新文件添加到列表
                const newFile = {
                    id: Date.now().toString(),
                    name: file.name,
                    content: content,
                    format: file.name.split('.').pop() || 'txt',
                    history: []
                };
                
                files.push(newFile);
                localStorage.setItem('editorFiles', JSON.stringify(files));
                initFileList();
                showStatus('文件已导入到列表');
                logAction('IMPORT_TO_LIST', file.name);
            } else {
                // 原有的导入逻辑
                if (!currentFile) {
                    // 如果没有打开的文件，创建一个新文件
                    const newFile = {
                        id: Date.now().toString(),
                        name: file.name,
                        content: content,
                        format: file.name.split('.').pop() || 'txt',
                        history: []
                    };
                    
                    files.push(newFile);
                    currentFile = newFile;
                    editor.value = content;
                } else {
                    // 根据选择的模式处理内容
                    if (importMode === 'replace') {
                        editor.value = content;
                    } else if (importMode === 'append') {
                        editor.value += '\n' + content;
                    }
                    
                    // 更新当前文件内容
                    if (currentFile.format === 'jpg') {
                        // 对于绘图文件，需要特殊处理
                        loadImageToCanvas(content);
                    } else {
                        currentFile.content = editor.value;
                    }
                }
                
                lastSavedContent = editor.value;
                showStatus('文件导入成功');
                logAction('IMPORT', file.name);
            }
            
            localStorage.setItem('editorFiles', JSON.stringify(files));
            closeImportModal();
        };
        
        reader.onerror = function() {
            showError('读取文件时出错');
        };
        
        if (file.type.startsWith('image/') || file.name.endsWith('.jpg')) {
            reader.readAsDataURL(file); // 对于图片文件或.jpg文件，以DataURL格式读取
        } else {
            reader.readAsText(file); // 对于文本文件，以文本格式读取
        }
    }
    
    // 处理图片导入到画布
    function loadImageToCanvas(dataURL) {
        if (currentFile && currentFile.format === 'jpg') {
            switchToCanvasMode();
            const img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, htyCanvas.width, htyCanvas.height);
                ctx.drawImage(img, 0, 0);
                currentFile.content = htyCanvas.toDataURL('image/jpeg', 0.9);
            };
            img.src = dataURL;
        }
    }

    // 添加点击事件监听器
    document.addEventListener("DOMContentLoaded", function() {
    const secureboxButton = document.getElementById('secureboxButton');
    
    if(secureboxButton) {
        secureboxButton.addEventListener('click', function() {
            window.location.href = 'ZIP Pro.html';
        });
    } else {
        console.error('错误：未找到 HTML IDE 按钮元素');
    }
});

    // 新增导入按钮样式
    document.head.insertAdjacentHTML('beforeend', `
        <style>
            .import-btn {
                background: rgba(74, 144, 226, 0.3);
                border-color: rgba(74, 144, 226, 0.4);
            }
            .import-btn:hover {
                background: rgba(74, 144, 226, 0.4);
            }
        </style>
    `);
    
    // 触发隐藏的文件输入
    function triggerFileInput() {
        document.getElementById('fileInput').click();
    }
    
    // 显示所选文件名
    document.getElementById('fileInput').addEventListener('change', function() {
        const fileName = this.files.length > 0 ? this.files[0].name : '未选择文件';
        document.getElementById('selectedFileName').textContent = fileName;
        
        // 更改拖放区域样式以指示已选择文件
        const dropArea = document.getElementById('dropArea');
        if (this.files.length > 0) {
            dropArea.style.borderColor = 'rgba(74, 144, 226, 0.6)';
            dropArea.style.background = 'rgba(74, 144, 226, 0.1)';
            dropArea.innerHTML = `<div style="font-size: 14px;">已选择: ${fileName}</div>`;
        } else {
            resetDropArea();
        }
    });
    
    // 初始化拖放功能
    function initDropArea() {
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        
        // 阻止默认拖放行为
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        // 高亮拖放区域
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            dropArea.style.borderColor = 'rgba(74, 144, 226, 0.8)';
            dropArea.style.background = 'rgba(74, 144, 226, 0.2)';
        }
        
        function unhighlight() {
            resetDropArea();
        }
        
        // 处理拖放的文件
        dropArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                fileInput.files = files;
                const event = new Event('change');
                fileInput.dispatchEvent(event);
            }
        }
    }
    
    function resetDropArea() {
        const dropArea = document.getElementById('dropArea');
        dropArea.style.borderColor = 'var(--border-color)';
        dropArea.style.background = 'var(--secondary-bg)';
        dropArea.innerHTML = '<div style="font-size: 14px;">或将文件拖放到此处</div>';
    }
    
    // 导入功能相关函数
    function importFile() {
        document.getElementById('importModal').style.display = 'flex';
        document.getElementById('fileInput').value = ''; // 清空之前的选择
        resetDropArea();
        document.getElementById('selectedFileName').textContent = '未选择文件';
        initDropArea(); // 初始化拖放功能
    }
    
    function closeImportModal() {
        document.getElementById('importModal').style.display = 'none';
    }
    
    // 修改导入处理函数，添加导入到列表选项的逻辑
    function processImport() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        
        if (!file) {
            showError('请选择要导入的文件');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            const importMode = document.querySelector('input[name="importMode"]:checked').value;
            
            // 处理导入到列表的情况
            if (importMode === 'toList') {
                // 创建新文件添加到列表
                const newFile = {
                    id: Date.now().toString(),
                    name: file.name,
                    content: content,
                    format: file.name.split('.').pop() || 'txt',
                    history: []
                };
                
                files.push(newFile);
                localStorage.setItem('editorFiles', JSON.stringify(files));
                initFileList();
                showStatus('文件已导入到列表');
                logAction('IMPORT_TO_LIST', file.name);
            } else {
                // 原有的导入逻辑
                if (!currentFile) {
                    // 如果没有打开的文件，创建一个新文件
                    const newFile = {
                        id: Date.now().toString(),
                        name: file.name,
                        content: content,
                        format: file.name.split('.').pop() || 'txt',
                        history: []
                    };
                    
                    files.push(newFile);
                    currentFile = newFile;
                    editor.value = content;
                } else {
                    // 根据选择的模式处理内容
                    if (importMode === 'replace') {
                        editor.value = content;
                    } else if (importMode === 'append') {
                        editor.value += '\n' + content;
                    }
                    
                    // 更新当前文件内容
                    if (currentFile.format === 'jpg') {
                        // 对于绘图文件，需要特殊处理
                        loadImageToCanvas(content);
                    } else {
                        currentFile.content = editor.value;
                    }
                }
                
                lastSavedContent = editor.value;
                showStatus('文件导入成功');
                logAction('IMPORT', file.name);
            }
            
            localStorage.setItem('editorFiles', JSON.stringify(files));
            closeImportModal();
        };
        
        reader.onerror = function() {
            showError('读取文件时出错');
        };
        
        if (file.type.startsWith('image/') || file.name.endsWith('.jpg')) {
            reader.readAsDataURL(file); // 对于图片文件或.jpg文件，以DataURL格式读取
        } else {
            reader.readAsText(file); // 对于文本文件，以文本格式读取
        }
    }
    
    // 处理图片导入到画布
    function loadImageToCanvas(dataURL) {
        if (currentFile && currentFile.format === 'jpg') {
            switchToCanvasMode();
            const img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, htyCanvas.width, htyCanvas.height);
                ctx.drawImage(img, 0, 0);
                currentFile.content = htyCanvas.toDataURL('image/jpeg', 0.9);
            };
            img.src = dataURL;
        }
    }

    // 添加点击事件监听器
    document.addEventListener("DOMContentLoaded", function() {
    const secureboxButton = document.getElementById('secureboxButton');
    
    if(secureboxButton) {
        secureboxButton.addEventListener('click', function() {
            window.location.href = 'ZIP Pro.html';
        });
    } else {
        console.error('错误：未找到 HTML IDE 按钮元素');
    }
});

    // 新增导入按钮样式
    document.head.insertAdjacentHTML('beforeend', `
        <style>
            .import-btn {
                background: rgba(74, 144, 226, 0.3);
                border-color: rgba(74, 144, 226, 0.4);
            }
            .import-btn:hover {
                background: rgba(74, 144, 226, 0.4);
            }
        </style>
    `);
    
    // 触发隐藏的文件输入
    function triggerFileInput() {
        document.getElementById('fileInput').click();
    }
    
    // 显示所选文件名
    document.getElementById('fileInput').addEventListener('change', function() {
        const fileName = this.files.length > 0 ? this.files[0].name : '未选择文件';
        document.getElementById('selectedFileName').textContent = fileName;
        
        // 更改拖放区域样式以指示已选择文件
        const dropArea = document.getElementById('dropArea');
        if (this.files.length > 0) {
            dropArea.style.borderColor = 'rgba(74, 144, 226, 0.6)';
            dropArea.style.background = 'rgba(74, 144, 226, 0.1)';
            dropArea.innerHTML = `<div style="font-size: 14px;">已选择: ${fileName}</div>`;
        } else {
            resetDropArea();
        }
    });
    
    // 初始化拖放功能
    function initDropArea() {
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        
        // 阻止默认拖放行为
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        // 高亮拖放区域
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            dropArea.style.borderColor = 'rgba(74, 144, 226, 0.8)';
            dropArea.style.background = 'rgba(74, 144, 226, 0.2)';
        }
        
        function unhighlight() {
            resetDropArea();
        }
        
        // 处理拖放的文件
        dropArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                fileInput.files = files;
                const event = new Event('change');
                fileInput.dispatchEvent(event);
            }
        }
    }
    
    function resetDropArea() {
        const dropArea = document.getElementById('dropArea');
        dropArea.style.borderColor = 'var(--border-color)';
        dropArea.style.background = 'var(--secondary-bg)';
        dropArea.innerHTML = '<div style="font-size: 14px;">或将文件拖放到此处</div>';
    }
    
    // 导入功能相关函数
    function importFile() {
        document.getElementById('importModal').style.display = 'flex';
        document.getElementById('fileInput').value = ''; // 清空之前的选择
        resetDropArea();
        document.getElementById('selectedFileName').textContent = '未选择文件';
        initDropArea(); // 初始化拖放功能
    }
    
    function closeImportModal() {
        document.getElementById('importModal').style.display = 'none';
    }
    
    // 修改导入处理函数，添加导入到列表选项的逻辑
    function processImport() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        
        if (!file) {
            showError('请选择要导入的文件');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            const importMode = document.querySelector('input[name="importMode"]:checked').value;
            
            // 处理导入到列表的情况
            if (importMode === 'toList') {
                // 创建新文件添加到列表
                const newFile = {
                    id: Date.now().toString(),
                    name: file.name,
                    content: content,
                    format: file.name.split('.').pop() || 'txt',
                    history: []
                };
                
                files.push(newFile);
                localStorage.setItem('editorFiles', JSON.stringify(files));
                initFileList();
                showStatus('文件已导入到列表');
                logAction('IMPORT_TO_LIST', file.name);
            } else {
                // 原有的导入逻辑
                if (!currentFile) {
                    // 如果没有打开的文件，创建一个新文件
                    const newFile = {
                        id: Date.now().toString(),
                        name: file.name,
                        content: content,
                        format: file.name.split('.').pop() || 'txt',
                        history: []
                    };
                    
                    files.push(newFile);
                    currentFile = newFile;
                    editor.value = content;
                } else {
                    // 根据选择的模式处理内容
                    if (importMode === 'replace') {
                        editor.value = content;
                    } else if (importMode === 'append') {
                        editor.value += '\n' + content;
                    }
                    
                    // 更新当前文件内容
                    if (currentFile.format === 'jpg') {
                        // 对于绘图文件，需要特殊处理
                        loadImageToCanvas(content);
                    } else {
                        currentFile.content = editor.value;
                    }
                }
                
                lastSavedContent = editor.value;
                showStatus('文件导入成功');
                logAction('IMPORT', file.name);
            }
            
            localStorage.setItem('editorFiles', JSON.stringify(files));
            closeImportModal();
        };
        
        reader.onerror = function() {
            showError('读取文件时出错');
        };
        
        if (file.type.startsWith('image/') || file.name.endsWith('.jpg')) {
            reader.readAsDataURL(file); // 对于图片文件或.jpg文件，以DataURL格式读取
        } else {
            reader.readAsText(file); // 对于文本文件，以文本格式读取
        }
    }
    
    // 处理图片导入到画布
    function loadImageToCanvas(dataURL) {
        if (currentFile && currentFile.format === 'jpg') {
            switchToCanvasMode();
            const img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, htyCanvas.width, htyCanvas.height);
                ctx.drawImage(img, 0, 0);
                currentFile.content = htyCanvas.toDataURL('image/jpeg', 0.9);
            };
            img.src = dataURL;
        }
    }

    let selectedElement = null;
let inspectMode = false;

// 开发工具验证
function showDevToolsAuth() {
    document.getElementById('devToolsAuthModal').style.display = 'flex';
}

function closeDevToolsAuth() {
    document.getElementById('devToolsAuthModal').style.display = 'none';
}

function verifyDevToolsPassword() {
    const password = document.getElementById('devToolsPassword').value;
    if (password === 'Admin') { // 修改为您的密码
        closeDevToolsAuth();
        toggleDevTools();
        initDevTools();
    } else {
        document.getElementById('devToolsAuthError').textContent = '密码错误';
        document.getElementById('devToolsAuthError').style.display = 'block';
    }
}

// 开发工具核心功能
function toggleDevTools() {
    const panel = document.getElementById('devToolsPanel');
    panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex';
}

function initDevTools() {
    // 初始化元素树
    updateElementTree(document.documentElement);
    
    // 绑定事件监听
    document.addEventListener('click', handleElementInspect, true);
}

function updateElementTree(element, level = 0) {
    const treeContainer = document.getElementById('elementTree');
    treeContainer.innerHTML = '';
    
    function walker(node, depth) {
        const div = document.createElement('div');
        div.className = 'element-node';
        div.style.paddingLeft = `${depth * 15}px`;
        div.textContent = `<${node.tagName.toLowerCase()}>`;
        
        div.addEventListener('click', () => selectElement(node));
        treeContainer.appendChild(div);
        
        if (node === selectedElement) {
            div.style.background = 'rgba(74, 144, 226, 0.3)';
        }
        
        Array.from(node.children).forEach(child => walker(child, depth + 1));
    }
    
    walker(element, 0);
}

function selectElement(element) {
    selectedElement = element;
    updateElementTree(document.documentElement);
    updateCSSProperties();
    highlightElement(element);
}

function highlightElement(element) {
    document.querySelectorAll('.inspect-highlight').forEach(el => {
        el.classList.remove('inspect-highlight');
    });
    if (element) {
        element.classList.add('inspect-highlight');
    }
}

function updateCSSProperties() {
    if (!selectedElement) return;
    
    const properties = getComputedStyle(selectedElement);
    const container = document.getElementById('cssProperties');
    container.innerHTML = '';
    
    // 筛选常用可编辑属性
    const editableProperties = [
        'color', 'background-color', 'font-size', 
        'width', 'height', 'padding', 'margin',
        'border', 'opacity', 'display'
    ];
    
    editableProperties.forEach(prop => {
        const wrapper = document.createElement('div');
        wrapper.className = 'css-property';
        
        const label = document.createElement('span');
        label.textContent = prop;
        
        const input = document.createElement('input');
        input.value = properties.getPropertyValue(prop) || '';
        
        const resetBtn = document.createElement('button');
        resetBtn.textContent = '↺';
        resetBtn.className = 'button';
        resetBtn.onclick = () => resetProperty(prop);
        
        wrapper.appendChild(label);
        wrapper.appendChild(input);
        wrapper.appendChild(resetBtn);
        container.appendChild(wrapper);
        
        input.addEventListener('change', () => {
            const oldValue = selectedElement.style.getPropertyValue(prop);
            selectedElement.style.setProperty(prop, input.value);
            logStyleChange(prop, oldValue, input.value);
            updateCSSProperties();
        });
    });
}

function resetProperty(prop) {
    if (selectedElement) {
        const oldValue = selectedElement.style.getPropertyValue(prop);
        selectedElement.style.removeProperty(prop);
        logStyleChange(prop, oldValue, '');
        updateCSSProperties();
    }
}

function logStyleChange(property, oldValue, newValue) {
    const action = {
        type: 'STYLE_CHANGE',
        element: selectedElement.tagName,
        id: selectedElement.id || '',
        class: selectedElement.className || '',
        property,
        oldValue,
        newValue,
        timestamp: new Date().toISOString()
    };
    
    auditLogs.push(action);
    localStorage.setItem('auditLogs', JSON.stringify(auditLogs));
}

// 检查模式切换
function toggleInspectMode() {
    inspectMode = !inspectMode;
    document.getElementById('inspectModeBtn').textContent = 
        inspectMode ? '退出检查模式' : '检查模式';
}

function handleElementInspect(e) {
    if (!inspectMode) return;
    e.preventDefault();
    e.stopPropagation();
    
    selectElement(e.target);
    updateCSSProperties();
}

// 指令执行功能
function executeDevToolsCommand() {
    const command = document.getElementById('devToolsCommand').value.trim();
    const parts = command.split(' ');
    
    try {
        if (command.startsWith('select ')) {
            const selector = command.slice(7);
            const element = document.querySelector(selector);
            if (element) {
                selectElement(element);
            } else {
                throw new Error('元素未找到');
            }
        }
        // 可以添加更多命令...
        else {
            throw new Error('未知命令');
        }
    } catch (error) {
        showError(`命令执行错误: ${error.message}`);
    }
}

    // 进制转换工具功能
let isConverting = false;

function convertToNumber() {
    if (isConverting) return;
    isConverting = true;
    
    try {
        const editor = document.getElementById('editor');
        const start = editor.selectionStart;
        const end = editor.selectionEnd;
        
        if (start === end) {
            showConversionError('请先选择要转换的文本');
            return;
        }

        const selectedText = editor.value.slice(start, end);
        const type = document.getElementById('conversionType').value;
        
        // 性能警告
        if (selectedText.length > 4096) {
            if (!confirm('转换内容较大（超过4KB），可能需要较长时间，继续吗？')) return;
        }

        // 执行转换
        const converted = textToBytes(selectedText, type);
        
        // 替换选中内容
        replaceEditorContent(start, end, converted);
        
        // 视觉反馈
        showConversionEffect(start, start + converted.length);
        
    } catch (e) {
        showConversionError(`转换失败: ${e.message}`);
    } finally {
        isConverting = false;
    }
}

function parseFromNumber() {
    if (isConverting) return;
    isConverting = true;

    try {
        const editor = document.getElementById('editor');
        const start = editor.selectionStart;
        const end = editor.selectionEnd;
        
        if (start === end) {
            showError('请先选择要解析的内容');
            return;
        }

        const selectedText = editor.value.slice(start, end).trim();
        const type = document.getElementById('conversionType').value;
        
        // 执行解析
        const parsed = bytesToText(selectedText, type);
        
        // 替换内容
        replaceEditorContent(start, end, parsed);
        
        // 视觉反馈
        showConversionEffect(start, start + parsed.length);

    } catch (e) {
        showConversionError(`解析失败: ${e.message}`);
    } finally {
        isConverting = false;
    }
}

// 核心转换函数
function textToBytes(text, type) {
    const encoder = new TextEncoder();
    const buffer = new Uint8Array(text.length * 4);
    const { written } = encoder.encodeInto(text, buffer);
    const bytes = buffer.slice(0, written);

    return bytes.reduce((acc, byte) => {
        switch(type) {
            case 'hex':
                return acc + byte.toString(16).padStart(2, '0') + ' ';
            case 'dec':
                return acc + byte.toString().padStart(3, '0') + ' ';
            case 'oct':
                return acc + byte.toString(8).padStart(3, '0') + ' ';
            case 'bin':
                return acc + byte.toString(2).padStart(8, '0') + ' ';
            default:
                throw new Error('未知的转换类型');
        }
    }, '').trim();
}

// 核心解析函数
function bytesToText(input, type) {
    const byteArrays = [];
    const chunks = input.split(/[\s,]+/).filter(Boolean);

    for (const chunk of chunks) {
        let byte;
        switch(type) {
            case 'hex':
                if (!/^[0-9a-fA-F]{2,4}$/.test(chunk)) {
                    throw new Error(`无效HEX值: ${chunk}`);
                }
                byte = parseInt(chunk, 16);
                break;
            case 'dec':
                const dec = parseInt(chunk, 10);
                if (dec < 0 || dec > 255 || isNaN(dec)) {
                    throw new Error(`无效DEC值: ${chunk} (0-255)`);
                }
                byte = dec;
                break;
            case 'oct':
                if (!/^[0-7]{3}$/.test(chunk)) {
                    throw new Error(`无效OCT值: ${chunk} (需要3位0-7)`);
                }
                byte = parseInt(chunk, 8);
                break;
            case 'bin':
                if (!/^[01]{8}$/.test(chunk)) {
                    throw new Error(`无效BIN值: ${chunk} (需要8位)`);
                }
                byte = parseInt(chunk, 2);
                break;
            default:
                throw new Error('未知的解析类型');
        }
        
        if (byte > 0xFF) {
            const buffer = new ArrayBuffer(2);
            const view = new DataView(buffer);
            view.setUint16(0, byte, false);
            byteArrays.push(view.getUint8(0), view.getUint8(1));
        } else {
            byteArrays.push(byte);
        }
    }
}

    const decoder = new TextDecoder();

    function bytesToText(input, type) {
    const byteArrays = [];
    const chunks = input.split(/[\s,]+/).filter(Boolean);

    for (const chunk of chunks) {
        let byte;
        switch(type) {
            case 'hex':
                if (!/^[0-9a-fA-F]{2,4}$/.test(chunk)) {
                    throw new Error(`无效HEX值: ${chunk}`);
                }
                byte = parseInt(chunk, 16);
                break;
            case 'dec':
                const dec = parseInt(chunk, 10);
                if (dec < 0 || dec > 255 || isNaN(dec)) {
                    throw new Error(`无效DEC值: ${chunk} (0-255)`);
                }
                byte = dec;
                break;
            case 'oct':
                if (!/^[0-7]{3}$/.test(chunk)) {
                    throw new Error(`无效OCT值: ${chunk} (需要3位0-7)`);
                }
                byte = parseInt(chunk, 8);
                break;
            case 'bin':
                if (!/^[01]{8}$/.test(chunk)) {
                    throw new Error(`无效BIN值: ${chunk} (需要8位)`);
                }
                byte = parseInt(chunk, 2);
                break;
            default:
                throw new Error('未知的解析类型');
        }
        
        if (byte > 0xFF) {
            const buffer = new ArrayBuffer(2);
            const view = new DataView(buffer);
            view.setUint16(0, byte, false);
            byteArrays.push(view.getUint8(0), view.getUint8(1));
        } else {
            byteArrays.push(byte);
        }
    } 

    // 使用流式解码处理多字节字符
    const decoder = new TextDecoder();
    const buffer = new Uint8Array(byteArrays);
    let result = '';
    let offset = 0;
    
    while (offset < buffer.length) {
        const chunkSize = Math.min(4096, buffer.length - offset);
        const chunk = buffer.subarray(offset, offset + chunkSize);
        result += decoder.decode(chunk, { stream: true });
        offset += chunkSize;
    }
    result += decoder.decode(); // 刷新缓冲区
    
    return result;
}

// 编辑器内容替换
function replaceEditorContent(start, end, newContent) {
    const editor = document.getElementById('editor');
    const scrollTop = editor.scrollTop;
    
    editor.value = editor.value.slice(0, start) 
                 + newContent 
                 + editor.value.slice(end);
    
    // 恢复滚动位置和选择状态
    editor.scrollTop = scrollTop;
    const newEnd = start + newContent.length;
    editor.setSelectionRange(newEnd, newEnd);
    
    // 触发自动保存
    editor.dispatchEvent(new Event('input'));
}

// 视觉反馈效果
function showConversionEffect(start, end) {
    const editor = document.getElementById('editor');
    const tempSpan = document.createElement('span');
    tempSpan.className = 'conversion-effect';
    tempSpan.textContent = editor.value.slice(start, end);
    
    const range = document.createRange();
    range.setStart(editor, start);
    range.setEnd(editor, end);
    range.deleteContents();
    range.insertNode(tempSpan);
    
    setTimeout(() => {
        tempSpan.classList.add('fade-out');
        setTimeout(() => tempSpan.remove(), 500);
    }, 1000);
}

// 错误提示
function showConversionError(message) {
    const errorDiv = document.getElementById('conversionError');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';

    setTimeout(() => {
        errorDiv.style.opacity = '0';
        setTimeout(() => {
            errorDiv.style.display = 'none';
            errorDiv.style.opacity = '1';
        }, 300);
    }, 3000);
}
//NotePad
// 未来记事本功能
let isNotepadDragging = false;
let notepadPos = { x: 0, y: 0 };
let dragStartPos = { x: 0, y: 0 };

function toggleFutureNotepad() {
    const overlay = document.getElementById('futureNotepadOverlay');
    overlay.style.display = overlay.style.display === 'flex' ? 'none' : 'flex';
    if (overlay.style.display === 'flex') {
        initFutureNotepad();
    }
}

function initFutureNotepad() {
    const editor = document.getElementById('futureEditor');
    const titlebar = document.querySelector('.future-notepad .titlebar');
    
    // 初始化拖拽
    titlebar.addEventListener('mousedown', startNotepadDrag);
    document.addEventListener('mouseup', stopNotepadDrag);
    document.addEventListener('mousemove', handleNotepadDrag);

    // 自动保存
    let autosaveTimer;
    editor.addEventListener('input', () => {
        clearTimeout(autosaveTimer);
        autosaveTimer = setTimeout(() => {
            localStorage.setItem('futureNotepadContent', editor.value);
            showStatus('未来记事本已自动保存');
        }, 5000);
        updateLineStats();
    });

    // 加载内容
    editor.value = localStorage.getItem('futureNotepadContent') || '';
}

function startNotepadDrag(e) {
    isNotepadDragging = true;
    dragStartPos = {
        x: e.clientX - notepadPos.x,
        y: e.clientY - notepadPos.y
    };
}

function stopNotepadDrag() {
    isNotepadDragging = false;
}

function handleNotepadDrag(e) {
    if (!isNotepadDragging) return;
    
    notepadPos = {
        x: e.clientX - dragStartPos.x,
        y: e.clientY - dragStartPos.y
    };
    
    document.querySelector('.future-notepad').style.transform = 
        `translate(${notepadPos.x}px, ${notepadPos.y}px)`;
}

// 更新行号统计
function updateLineStats() {
    const editor = document.getElementById('futureEditor');
    const text = editor.value;
    const lines = text.split('\n');
    const line = text.substr(0, editor.selectionStart).split('\n').length;
    const col = editor.selectionStart - text.lastIndexOf('\n', editor.selectionStart-1);
    
    document.querySelector('.future-notepad .status-bar').innerHTML = `
        <span>字数: ${text.length}</span>
        <span>行数: ${lines.length}</span>
        <span>Ln ${line}, Col ${col}</span>
        <span>UTF-8</span>
    `;
}
//NotePad 

    // 新增背景设置逻辑
    document.getElementById('bgFileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        const bgType = file.type.startsWith('video/') ? 'video' : 'image';
        
        reader.onload = function(e) {
            const bgUrl = e.target.result;
            applyBackground(bgUrl, bgType);
            localStorage.setItem('customBackground', JSON.stringify({
                type: bgType,
                data: bgUrl
            }));
            document.getElementById('bgFileName').textContent = file.name;
        };

        if (bgType === 'video') {
            reader.readAsDataURL(file);
        } else {
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('bgToggle').addEventListener('change', function(e) {
        if (!e.target.checked) {
            clearBackground();
            localStorage.removeItem('customBackground');
        }
    });    

    function applyBackground(url, type) {
        clearBackground();
        
        const container = document.querySelector('.container');
        if (type === 'video') {
            const video = document.createElement('video');
            video.id = 'bgVideo';
            video.src = url;
            video.autoplay = true;
            video.muted = true;
            video.loop = true;
            video.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                min-width: 100%;
                min-height: 100%;
                z-index: -1;
                opacity: 0.5;
            `;
            document.body.appendChild(video);
            video.play();
        } else {
            document.body.style.background = `linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), 
                url(${url}) center/cover fixed`;
        }
    }

    function clearBackground() {
        document.body.style.background = '';
        const video = document.getElementById('bgVideo');
        if (video) video.remove();
    }

    // 初始化时加载保存的背景
    const savedBg = localStorage.getItem('customBackground');
    if (savedBg) {
        try {
            const {type, data} = JSON.parse(savedBg);
            applyBackground(data, type);
            document.getElementById('bgToggle').checked = true;
        } catch(e) {
            console.error('Error loading background:', e);
        }
    }

    // 添加点击事件监听器
    document.addEventListener("DOMContentLoaded", function() {
    const newNotePadButton = document.getElementById('newNotePadButton');
    
    if(newNotePadButton) {
        newNotePadButton.addEventListener('click', function() {
            window.location.href = 'Window NotePad.html';
        });
    } else {
        console.error('错误：未找到 HTML IDE 按钮元素');
    }
});

    // 添加点击事件监听器
    document.addEventListener("DOMContentLoaded", function() {
    const AiChatButton = document.getElementById('AiChatButton');
    
    if(AiChatButton) {
        AiChatButton.addEventListener('click', function() {
            window.location.href = 'Ai Chat.html';
        });
    } else {
        console.error('错误：未找到 HTML IDE 按钮元素');
    }
});
</script>
    <!-- SecureBox按钮 -->
    <button id="AiChatButton" style="bottom: 168px;"class="bottom-left-button">AIChatSuper Beta</button>
        <!-- SecureBox按钮 -->
        <button id="secureboxButton" style="bottom: 119px;"class="bottom-left-button">SecureBox Pro</button>
    <!-- HTML IDE 按钮 -->
    <button id="newNotePadButton" class="bottom-left-button">Window NotePad Beta</button>
    <!-- HTML IDE 按钮 -->
    <button id="htmlIdeButton" class="bottom-left-button_color">HTML IDE Beta</button>
</body>
<style>
/*    左下Button     */
.bottom-left-button {
            position: fixed;
            bottom: 70px;
            left: 20px;
            padding: 10px 17px;
            border-radius: 8px;
            background: rgba(61, 61, 61, 0.411);
            color: var(--text-color);
            border: 1px solid rgba(255, 255, 255, 0.712);
            cursor: pointer;
            z-index: 1000;
            background-size: 200% 100%;
            opacity: 0.9; /* 设置整体透明度为 0.8 (可以调整) */
            backdrop-filter: blur(50px); /*  可以添加轻微的模糊效果，增强半透明感 */
        }
 

.bottom-left-button:hover {
    filter: brightness(1.1);
    opacity: 1; /* 鼠标悬停时恢复不透明 */
}
</style>

<style>
/* 添加OCT的样式高亮 */
.hex-row:nth-child(4n) .hex-value {
    color: #4a90e2; /* 为OCT添加特殊颜色 */
}
</style>
<!-- 重命名模态框 -->
<div class="modal-overlay" id="renameModal">
    <div class="modal-content" style="width: 400px;">
        <h3 style="color: var(--text-color); margin-bottom: 20px;">重命名文件</h3>
        
        <div class="rename-section">
            <div class="input-group">
                <label>文件名:</label>
                <input type="text" id="newFileNameInput" 
                    class="rename-input"
                    placeholder="输入新文件名"
                    autofocus>
            </div>
            
            <div class="input-group">
                <label>扩展名:</label>
                <div class="extension-select">
                    <input type="text" id="newExtensionInput" 
                        class="rename-input"
                        placeholder="扩展名 (如: txt)">
                    <div class="common-extensions">
                        <span onclick="setExtension('txt')">txt</span>
                        <span onclick="setExtension('md')">md</span>
                        <span onclick="setExtension('html')">html</span>
                        <span onclick="setExtension('js')">js</span>
                    </div>
                </div>
            </div>
            
            <div class="input-group">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="signatureCheckbox">
                    添加数字签名
                </label>
                <textarea id="signatureInput" 
                    class="rename-input" 
                    placeholder="签名信息 (可选)"
                    style="display: none; height: 60px; resize: vertical"></textarea>
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="button" onclick="confirmRename()" style="flex:1;">确认</button>
            <button class="button" onclick="closeRenameModal()" style="flex:1;">取消</button>
        </div>
    </div>
</style>
<script>
// 修改后的重命名函数
function renameFile() {
    if (!contextMenuFile) return;
    
    // 分离文件名和扩展名
    const [namePart, extPart] = contextMenuFile.name.split(/(?<=^[^\.]+)\.?/);
    
    // 填充表单
    document.getElementById('newFileNameInput').value = namePart;
    document.getElementById('newExtensionInput').value = extPart || '';
    
    // 显示签名字段（如果存在）
    if(contextMenuFile.signature) {
        document.getElementById('signatureCheckbox').checked = true;
        document.getElementById('signatureInput').value = contextMenuFile.signature;
        document.getElementById('signatureInput').style.display = 'block';
    }
    
    document.getElementById('renameModal').style.display = 'flex';
}

// 确认重命名
function confirmRename() {
    const nameInput = document.getElementById('newFileNameInput').value.trim();
    const extInput = document.getElementById('newExtensionInput').value.trim();
    const addSignature = document.getElementById('signatureCheckbox').checked;
    const signature = document.getElementById('signatureInput').value.trim();

    // 验证输入
    if (!/^[\w\-\s()]+$/.test(nameInput)) {
        showError('文件名只能包含字母、数字、下划线、破折号和空格');
        return;
    }
    
    if (extInput && !/^[a-zA-Z0-9]+$/.test(extInput)) {
        showError('扩展名只能包含字母和数字');
        return;
    }

    // 构建新文件名
    const newName = extInput ? 
        `${nameInput}.${extInput}` : 
        nameInput;

    // 检查重复
    if (files.some(f => f.id !== contextMenuFile.id && f.name === newName)) {
        showError('文件名已存在');
        return;
    }

    // 更新文件属性
    contextMenuFile.name = newName;
    if (addSignature) {
        contextMenuFile.signature = signature;
    } else {
        delete contextMenuFile.signature;
    }

    localStorage.setItem('editorFiles', JSON.stringify(files));
    initFileList();
    showStatus('重命名成功');
    closeRenameModal();
}

// 扩展名快速选择
function setExtension(ext) {
    document.getElementById('newExtensionInput').value = ext;
}

// 关闭模态框
function closeRenameModal() {
    document.getElementById('renameModal').style.display = 'none';
}

// 签名字段显示控制
document.getElementById('signatureCheckbox').addEventListener('change', function(e) {
    document.getElementById('signatureInput').style.display = e.target.checked ? 'block' : 'none';
});
</script>

<style>
/* 重命名模态框样式 */
.rename-section {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.input-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.input-group label {
    color: var(--text-secondary);
    font-size: 14px;
}

.rename-input {
    width: 100%;
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid var(--border-color);
    background: var(--secondary-bg);
    color: var(--text-color);
    font-size: 14px;
}

.extension-select {
    position: relative;
}

.common-extensions {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    gap: 6px;
}

.common-extensions span {
    padding: 2px 6px;
    border-radius: 4px;
    background: rgba(74, 144, 226, 0.1);
    color: #4a90e2;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.common-extensions span:hover {
    background: rgba(74, 144, 226, 0.2);
}
</style>
</html>