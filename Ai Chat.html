<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Chat - DeepSeek</title>
    <style>
        /* 主题变量 - 添加在样式表开头 */
        :root {
            /* 浅色主题变量 (默认) */
            --bg-color: rgba(245, 247, 250, 0.5);
            --text-color: #333;
            --secondary-text: #666;
            --primary-color: #4a90e2;
            --primary-dark: #356bb7;
            --panel-bg: rgba(255, 255, 255, 0.12);
            --card-bg: rgba(255, 255, 255, 0.8);
            --user-message-bg: linear-gradient(135deg, #4a90e2 0%, #356bb7 100%);
            --user-message-color: white;
            --ai-message-bg: rgba(255, 255, 255, 0.8);
            --ai-message-color: #333;
            --ai-thinking-bg: rgba(255, 255, 255, 0.6);
            --ai-thinking-color: #666;
            --input-bg: rgba(255, 255, 255, 0.6);
            --border-color: rgba(255, 255, 255, 0.2);
            --sidebar-bg: rgba(44, 62, 80, 0.8);
            --sidebar-text: #fff;
            --sidebar-active: rgba(74, 144, 226, 0.5);
            --sidebar-hover: rgba(74, 144, 226, 0.3);
            --modal-bg: rgba(255, 255, 255, 0.9);
            --modal-header: #333;
            --settings-border: rgba(0, 0, 0, 0.1);
            --input-border: rgba(0, 0, 0, 0.1);
            --toast-bg: rgba(0, 0, 0, 0.8);
            --toast-color: white;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --context-menu-bg: rgba(255, 255, 255, 0.85);
            --context-menu-color: #333;
            --context-menu-hover: rgba(74, 144, 226, 0.1);
            --danger-color: #e74c3c;
        }

        /* 深色主题变量 */
        [data-theme="dark"] {
            --bg-color: rgba(30, 39, 46, 0.5);
            --text-color: #e2e2e2;
            --secondary-text: #b0b0b0;
            --primary-color: #5f9de6;
            --primary-dark: #4a7dbe;
            --panel-bg: rgba(35, 43, 50, 0.15);
            --card-bg: rgba(35, 43, 50, 0.8);
            --user-message-bg: linear-gradient(135deg, #5f9de6 0%, #4a7dbe 100%);
            --user-message-color: white;
            --ai-message-bg: rgba(45, 53, 60, 0.8);
            --ai-message-color: #e2e2e2;
            --ai-thinking-bg: rgba(45, 53, 60, 0.6);
            --ai-thinking-color: #b0b0b0;
            --input-bg: rgba(45, 52, 58, 0.6);
            --border-color: rgba(80, 80, 80, 0.2);
            --sidebar-bg: rgba(25, 33, 42, 0.85);
            --sidebar-text: #e2e2e2;
            --sidebar-active: rgba(74, 144, 226, 0.45);
            --sidebar-hover: rgba(74, 144, 226, 0.25);
            --modal-bg: rgba(35, 43, 50, 0.9);
            --modal-header: #e2e2e2;
            --settings-border: rgba(80, 80, 80, 0.2);
            --input-border: rgba(80, 80, 80, 0.3);
            --toast-bg: rgba(35, 43, 50, 0.9);
            --toast-color: #e2e2e2;
            --shadow-color: rgba(0, 0, 0, 0.25);
            --context-menu-bg: rgba(35, 43, 50, 0.95);
            --context-menu-color: #e2e2e2;
            --context-menu-hover: rgba(74, 144, 226, 0.2);
            --danger-color: #e9675c;
        }

        /* 使用变量替换颜色值 */
        body {
            color: var(--text-color);
        }

        .chat-container {
            background: var(--panel-bg);
            box-shadow: 0 8px 32px var(--shadow-color);
            border: 1px solid var(--border-color);
        }

        .chat-messages {
            background: var(--bg-color);
        }

        .message-header {
            color: var(--text-color);
        }

        .user-message {
            background: var(--user-message-bg);
            color: var(--user-message-color);
        }

        .ai-message {
            background: var(--ai-message-bg);
            color: var(--ai-message-color);
        }

        .ai-thinking {
            background: var(--ai-thinking-bg);
            color: var(--ai-thinking-color);
            border-left: 3px solid var(--primary-color);
        }

        .thinking-header {
            color: var(--secondary-text);
        }

        .chat-input-container {
            background: var(--panel-bg);
            border-top: 1px solid var(--border-color);
        }

        .toggle-label {
            color: var(--text-color);
        }

        #chatInput {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        #chatInput:focus {
            border-color: var(--primary-color);
            background: var(--input-bg);
        }

        #sendButton {
            background: var(--primary-color);
        }

        #sendButton:hover {
            background: var(--primary-dark);
        }

        /* 温度滑块 */
        .temperature-label {
            color: var(--text-color);
        }

        .temperature-value {
            color: var(--primary-color);
        }

        .temperature-slider {
            background: var(--input-border);
        }

        .temperature-slider::-webkit-slider-thumb {
            background: var(--primary-color);
        }

        /* 模态框样式 */
        .modal-content {
            background: var(--modal-bg);
        }

        .modal-header h2 {
            color: var(--modal-header);
        }

        .settings-section {
            border-bottom: 1px solid var(--settings-border);
        }

        .settings-section h3 {
            color: var(--text-color);
        }

        .settings-item label {
            color: var(--secondary-text);
        }

        .settings-item input,
        .settings-item select {
            border: 1px solid var(--input-border);
            background: var(--input-bg);
            color: var(--text-color);
        }

        .settings-item input:focus,
        .settings-item select:focus {
            border-color: var(--primary-color);
        }

        .api-key-input button {
            border: 1px solid var(--input-border);
            border-left: none;
            background: var(--input-bg);
            color: var(--text-color);
        }

        /* 右键菜单样式 */
        .context-menu {
            background: var(--context-menu-bg);
            border: 1px solid var(--border-color);
        }
        
        .context-menu-item {
            color: var(--context-menu-color);
        }
        
        .context-menu-item:hover {
            background: var(--context-menu-hover);
        }
        
        .context-menu-item.danger {
            color: var(--danger-color);
        }
        
        .context-menu-divider {
            background: var(--settings-border);
        }

        /* 提示消息 */
        .toast {
            background: var(--toast-bg);
            color: var(--toast-color);
        }

        /* 主题切换按钮 */
        .theme-toggle {
            position: fixed;
            top: 20px;           /* 从bottom: 20px改为top: 20px */
            right: 20px;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: var(--card-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 10px var(--shadow-color);
            border: 1px solid var(--border-color);
            z-index: 100;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        .theme-toggle svg {
            width: 24px;
            height: 24px;
            color: var(--primary-color);
        }

        /* 基础样式调整 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: url('https://source.unsplash.com/random/1920x1080/?gradient') no-repeat center center fixed;
            background-size: cover;
            line-height: 1.6;
            min-height: 100vh;
        }

        /* 模糊玻璃效果 */
        .glass {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        /* 聊天相关样式优化 */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 16px;
            margin: 10px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .chat-list {
            width: 280px;
            background: rgba(44, 62, 80, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            color: #fff;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
            padding: 20px 15px;
        }

        .chat-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 5px 15px 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 15px;
        }

        .chat-list-title {
            font-weight: 600;
            font-size: 18px;
        }

        .new-chat-btn {
            padding: 6px 12px;
            background: rgba(74, 144, 226, 0.7);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .new-chat-btn:hover {
            background: rgba(74, 144, 226, 0.9);
            transform: translateY(-2px);
        }

        .chat-item {
            padding: 12px;
            margin: 8px 0;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .chat-icon {
            font-size: 16px;
        }

        .chat-item:hover {
            background: rgba(74, 144, 226, 0.3);
            transform: translateY(-2px);
        }

        .chat-item.active {
            background: rgba(74, 144, 226, 0.5);
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.2);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            background: rgba(245, 247, 250, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .message {
            max-width: 85%;
            padding: 16px 20px;
            border-radius: 18px;
            animation: fadeIn 0.3s ease;
            line-height: 1.5;
            position: relative;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .message-header {
            font-size: 13px;
            margin-bottom: 5px;
            opacity: 0.8;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .user-message {
            align-self: flex-end;
            background: linear-gradient(135deg, #4a90e2 0%, #356bb7 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .ai-message {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            color: #333;
            border-bottom-left-radius: 4px;
        }

        .ai-thinking {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            color: #666;
            border-bottom-left-radius: 4px;
            font-style: italic;
            border-left: 3px solid #4a90e2;
            max-height: 300px;
            overflow-y: auto;
        }

        .thinking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
            color: #666;
        }

        .message-time {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 5px;
            text-align: right;
        }

        .chat-input-container {
            padding: 20px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chat-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 5px;
        }

        .chat-settings {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #chatInput {
            flex: 1;
            padding: 16px;
            border-radius: 24px;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #333;
            font-size: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        #chatInput:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
            background: rgba(255, 255, 255, 0.8);
        }

        #sendButton {
            padding: 14px;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #4a90e2 0%, #356bb7 100%);
            border: none;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
        }

        #sendButton:hover {
            transform: scale(1.05) rotate(5deg);
            box-shadow: 0 6px 20px rgba(74, 144, 226, 0.4);
        }

        #sendButton:disabled {
            background: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* 开关样式 */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-label {
            font-size: 13px;
            color: #333;
            font-weight: 500;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(200, 200, 200, 0.7);
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #4a90e2;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        /* 温度滑块 */
        .temperature-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .temperature-label {
            font-size: 13px;
            color: #333;
            font-weight: 500;
            white-space: nowrap;
        }

        .temperature-value {
            font-size: 13px;
            color: #4a90e2;
            font-weight: 600;
            width: 30px;
            text-align: center;
        }

        .temperature-slider {
            -webkit-appearance: none;
            width: 100px;
            height: 6px;
            border-radius: 5px;
            background: rgba(200, 200, 200, 0.7);
            outline: none;
        }

        .temperature-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4a90e2;
            cursor: pointer;
            transition: all 0.2s;
        }

        .temperature-slider::-webkit-slider-thumb:hover {
            background: #356bb7;
            transform: scale(1.1);
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            margin: 10px 0;
            padding: 10px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #4a90e2;
            border-radius: 50%;
            animation: typingAnimation 1.4s infinite ease-in-out both;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingAnimation {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 调整容器布局 */
        .container {
            display: flex;
            height: 100vh;
            overflow: hidden;
            padding: 15px;
            background: rgba(0, 0, 0, 0.05);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .chat-list {
                width: 220px;
            }
            .message {
                max-width: 90%;
            }
            .chat-controls {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }

        @media (max-width: 576px) {
            .container {
                flex-direction: column;
                padding: 5px;
            }
            .chat-list {
                width: 100%;
                height: 60px;
                display: flex;
                align-items: center;
                padding: 0 10px;
                overflow-x: auto;
            }
            .chat-list-header {
                display: none;
            }
            .chat-item {
                margin: 0 5px;
                padding: 8px 12px;
                white-space: nowrap;
            }
            .chat-settings {
                width: 100%;
                justify-content: space-between;
            }
            .theme-toggle {
                top: 15px;
                right: 15px;
                width: 36px;
                height: 36px;
            }
            
            .theme-toggle svg {
                width: 20px;
                height: 20px;
            }
        }

        /* 右键菜单样式 */
        .context-menu {
            position: fixed;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 8px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 160px;
            z-index: 1000;
            overflow: hidden;
            opacity: 0;
            transform: scale(0.95);
            transform-origin: top left;
            transition: all 0.15s ease-out;
            padding: 6px 0;
        }
        
        .context-menu.show {
            opacity: 1;
            transform: scale(1);
        }
        
        .context-menu-item {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #333;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }
        
        .context-menu-item:hover {
            background: rgba(74, 144, 226, 0.1);
        }
        
        .context-menu-item.danger {
            color: #e74c3c;
        }
        
        .context-menu-item.danger:hover {
            background: rgba(231, 76, 60, 0.1);
        }
        
        .context-menu-divider {
            height: 1px;
            background: rgba(0, 0, 0, 0.1);
            margin: 5px 0;
        }
        
        .context-menu-icon {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 重命名输入框样式 */
        .rename-input {
            padding: 6px 10px;
            width: 100%;
            border: 1px solid #4a90e2;
            border-radius: 4px;
            outline: none;
            font-size: 13px;
            background: rgba(255, 255, 255, 0.9);
        }

        /* 设置按钮样式 */
        .settings-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(74, 144, 226, 0.1);
            color: #4a90e2;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .settings-btn:hover {
            background: rgba(74, 144, 226, 0.2);
            transform: rotate(30deg);
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            width: 500px;
            max-width: 90%;
            max-height: 85vh;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .modal-header h2 {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-btn:hover {
            color: #e74c3c;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 15px 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .settings-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .settings-section h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #444;
        }

        .settings-item {
            margin-bottom: 15px;
        }

        .settings-item label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #666;
        }

        .settings-item input,
        .settings-item select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            transition: all 0.3s;
        }

        .settings-item input:focus,
        .settings-item select:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
        }

        .api-key-input {
            display: flex;
            align-items: center;
        }

        .api-key-input input {
            flex: 1;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .api-key-input button {
            width: 40px;
            height: 41px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-left: none;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-top-right-radius: 8px;
            border-bottom-right-radius: 8px;
            transition: all 0.3s;
        }

        .api-key-input button:hover {
            background: rgba(74, 144, 226, 0.1);
        }

        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }

        .btn.primary {
            background: #4a90e2;
            color: white;
        }

        .btn.primary:hover {
            background: #3a7bc8;
        }

        .btn.secondary {
            background: rgba(0, 0, 0, 0.05);
            color: #666;
        }

        .btn.secondary:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 576px) {
            .modal-content {
                width: 95%;
                max-height: 80vh;
            }
            
            .settings-item {
                margin-bottom: 20px;
            }
        }

        /* 添加Toast样式 */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            padding: 12px 24px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 8px;
            font-size: 14px;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* 为API设置按钮添加样式 */
        .api-key-notice {
            margin-top: 15px;
            display: flex;
            justify-content: center;
        }

        .setup-api-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .setup-api-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
            background: var(--primary-dark);
        }

        .setup-api-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Markdown样式 */
        .message-content {
            width: 100%;
        }

        .message-content h1, 
        .message-content h2, 
        .message-content h3,
        .message-content h4, 
        .message-content h5, 
        .message-content h6 {
            margin-top: 12px;
            margin-bottom: 8px;
            font-weight: 600;
            line-height: 1.3;
        }

        .message-content h1 {
            font-size: 1.6em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 4px;
        }

        .message-content h2 {
            font-size: 1.4em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 4px;
        }

        .message-content h3 {
            font-size: 1.2em;
        }

        .message-content p {
            margin-bottom: 10px;
        }

        .message-content ul, 
        .message-content ol {
            margin-left: 20px;
            margin-bottom: 10px;
        }

        .message-content li {
            margin-bottom: 4px;
        }

        .message-content blockquote {
            padding: 0 12px;
            color: var(--secondary-text);
            border-left: 4px solid var(--primary-color);
            margin: 8px 0;
        }

        .message-content pre {
            background: rgba(0, 0, 0, 0.1);
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .message-content code {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            background: rgba(0, 0, 0, 0.05);
            padding: 3px 5px;
            border-radius: 3px;
            font-size: 0.9em;
        }

        .message-content pre code {
            background: transparent;
            padding: 0;
            border-radius: 0;
            font-size: 0.9em;
            color: inherit;
            display: block;
        }

        .message-content a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .message-content a:hover {
            text-decoration: underline;
        }

        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
        }

        .message-content th, 
        .message-content td {
            border: 1px solid var(--border-color);
            padding: 6px 12px;
            text-align: left;
        }

        .message-content th {
            background: rgba(0, 0, 0, 0.05);
        }

        .message-content img {
            max-width: 100%;
            border-radius: 4px;
        }

        /* 搜索功能样式 */
        .search-container {
            display: flex;
            margin: 0 0 15px 0;
            padding: 0 5px;
        }

        #searchInput {
            flex: 1;
            padding: 8px 12px;
            border-radius: 8px 0 0 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: var(--sidebar-text);
            font-size: 13px;
        }

        #searchInput::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        #searchInput:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
        }

        #searchBtn {
            background: rgba(74, 144, 226, 0.7);
            border: none;
            color: white;
            padding: 8px 10px;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #searchBtn:hover {
            background: rgba(74, 144, 226, 0.9);
        }

        .no-search-results {
            padding: 25px 15px;
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .no-search-results svg {
            opacity: 0.5;
            width: 40px;
            height: 40px;
        }

        .search-result-count {
            padding: 5px 10px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
            margin-bottom: 10px;
        }

        .search-highlight {
            background: rgba(74, 144, 226, 0.3);
            border-radius: 3px;
            padding: 0 2px;
            font-weight: bold;
        }

        /* 代码复制按钮样式 */
        .code-block-wrapper {
            position: relative;
            margin: 10px 0;
        }

        .code-block-wrapper pre {
            margin: 0;
            padding-top: 30px; /* 为复制按钮留出空间 */
        }

        .copy-code-button {
            position: absolute;
            top: 5px;
            right: 5px;
            padding: 4px 8px;
            background: rgba(0, 0, 0, 0.1);
            border: none;
            border-radius: 4px;
            color: var(--secondary-text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .copy-code-button:hover {
            background: rgba(0, 0, 0, 0.2);
            color: var(--primary-text);
        }

        .copy-code-button.copied {
            background: var(--success-color, #4CAF50);
            color: white;
        }

        /* 暗色主题调整 */
        .dark-theme .copy-code-button {
            background: rgba(255, 255, 255, 0.1);
            color: var(--secondary-text);
        }

        .dark-theme .copy-code-button:hover {
            background: rgba(255, 255, 255, 0.2);
            color: var(--primary-text);
        }

        .dark-theme .copy-code-button.copied {
            background: var(--success-color, #4CAF50);
            color: white;
        }

        /* 移动端响应式适配 */
        @media (max-width: 768px) {
            /* 整体布局调整 */
            body {
                overflow: hidden;
            }
            
            .app-container {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr;
            }
            
            /* 侧边栏适配 */
            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                bottom: 0;
                width: 280px;
                z-index: 1000;
                transition: left 0.3s ease;
            }
            
            .sidebar.show-mobile {
                left: 0;
                box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            }
            
            /* 添加遮罩层 */
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            
            .sidebar-overlay.show {
                display: block;
                opacity: 1;
            }
            
            /* 主内容区域适配 */
            .main-content {
                grid-column: 1 / -1;
                padding: 0;
            }
            
            /* 顶部导航栏 */
            .mobile-navbar {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px 15px;
                background: var(--bg-gradient);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                z-index: 900;
            }
            
            .menu-toggle {
                border: none;
                background: transparent;
                color: var(--primary-text);
                padding: 8px;
                cursor: pointer;
                border-radius: 4px;
            }
            
            .menu-toggle:hover {
                background: rgba(255, 255, 255, 0.1);
            }
            
            /* 聊天容器适配 */
            .chat-container {
                height: calc(100vh - 60px);
                border-radius: 0;
                margin: 0;
            }
            
            /* 消息样式适配 */
            .message {
                padding: 12px;
                max-width: 100%;
            }
            
            .message-content {
                font-size: 15px;
            }
            
            /* 输入区域适配 */
            .chat-input-container {
                padding: 10px;
                margin: 0;
                border-radius: 0;
            }
            
            #userInput {
                padding: 12px;
                font-size: 15px;
            }
            
            .send-button {
                padding: 10px;
            }
            
            /* 设置和功能区域适配 */
            .settings-modal {
                width: 90%;
                max-width: 350px;
            }
            
            .toggle-container {
                margin-right: 15px;
            }
            
            /* 主题切换按钮适配 */
            .theme-toggle {
                width: 36px;
                height: 36px;
                top: auto;
                bottom: 20px;
                z-index: 900;
            }
            
            /* 代码块适配 */
            .message-content pre {
                max-width: 100%;
                overflow-x: auto;
            }
            
            /* 上下文菜单适配 */
            .context-menu {
                max-width: 250px;
            }
            
            /* 温度滑块适配 */
            .temperature-slider {
                max-width: 90%;
            }
        }

        /* 确保移动导航栏默认是隐藏的 */
        .mobile-navbar {
            display: none;
        }

        /* 移动端响应式适配 */
        @media (max-width: 768px) {
            /* 显示移动导航栏 */
            .mobile-navbar {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px 15px;
                background: var(--bg-gradient);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                z-index: 900;
            }
            
            /* 其他移动端样式保持不变 */
        }
    </style>
    <!-- 在head标签中添加marked.js库，放在其他script标签之前 -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
</head>
<body>
    <!-- 添加主题切换按钮到body末尾，在脚本前 -->
    <div class="theme-toggle" id="themeToggleBtn">
        <svg id="lightIcon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="2"/>
            <line x1="12" y1="1" x2="12" y2="3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="12" y1="21" x2="12" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="1" y1="12" x2="3" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="21" y1="12" x2="23" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <svg id="darkIcon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: none;">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </div>

    <div class="container">
        <!-- 左侧聊天列表 -->
        <div class="chat-list glass">
            <!-- 在chat-list-header下添加搜索栏 -->
            <div class="chat-list-header">
                <div class="chat-list-title">AI Chat</div>
                <div class="new-chat-btn" onclick="startNewChat()">新对话</div>
            </div>
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="搜索对话历史..." />
                <button id="searchBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
                        <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <div class="chat-item active">
                <span class="chat-icon">💬</span>
                <span class="chat-title">新对话</span>
            </div>
        </div>

        <!-- 主聊天区域 -->
        <div class="main-content">
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="message ai-message">
                        <div class="message-header">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="#4a90e2" stroke-width="2"/>
                                <path d="M12 7V12L15 15" stroke="#4a90e2" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            DeepSeek AI
                        </div>
                        您好！我是DeepSeek AI，有什么可以帮您的？
                        <div class="message-time">今天 10:00</div>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <div class="chat-controls">
                        <div class="chat-settings">
                            <div class="toggle-container">
                                <span class="toggle-label">模型: <span id="modelLabel">R1 (Reasoner)</span></span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="deepThinkToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            
                            <div class="temperature-container">
                                <span class="temperature-label">温度</span>
                                <input type="range" min="0" max="1" step="0.1" value="0.7" class="temperature-slider" id="temperatureSlider">
                                <span class="temperature-value" id="temperatureValue">0.7</span>
                            </div>
                            
                            <!-- 添加设置按钮 -->
                            <div class="settings-btn" id="settingsBtn">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                        </div>
                        
                        <div class="toggle-container">
                            <span class="toggle-label">显示思考过程</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="showThinkingToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="chat-input-wrapper">
                    <input type="text" id="chatInput" placeholder="输入您的问题...">
                        <button id="sendButton" onclick="sendMessage()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 右键菜单 -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" id="menuRename">
            <div class="context-menu-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <span>重命名</span>
        </div>
        <div class="context-menu-item" id="menuDuplicate">
            <div class="context-menu-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="9" y="9" width="13" height="13" rx="2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <span>复制对话</span>
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" id="menuExport">
            <div class="context-menu-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <polyline points="7 10 12 15 17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <line x1="12" y1="15" x2="12" y2="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <span>导出对话</span>
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item danger" id="menuDelete">
            <div class="context-menu-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <polyline points="3 6 5 6 21 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <line x1="10" y1="11" x2="10" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <line x1="14" y1="11" x2="14" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <span>删除对话</span>
        </div>
    </div>

    <!-- 设置模态框 -->
    <div class="modal" id="settingsModal">
        <div class="modal-content glass">
            <div class="modal-header">
                <h2>设置</h2>
                <button class="close-btn" id="closeSettingsBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h3>API 设置</h3>
                    <div class="settings-item">
                        <label for="apiProvider">API 提供商</label>
                        <select id="apiProvider">
                            <option value="deepseek">DeepSeek</option>
                            <option value="openai">OpenAI</option>
                            <option value="gemini">Google Gemini</option>
                        </select>
                    </div>
                    <div class="settings-item">
                        <label for="apiKey">API 密钥</label>
                        <div class="api-key-input">
                            <input type="password" id="apiKey" placeholder="输入您的API密钥">
                            <button id="toggleApiKey" type="button">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section model-section" id="deepseekModels">
                    <h3>DeepSeek 模型</h3>
                    <div class="settings-item">
                        <label for="deepseekModel">模型</label>
                        <select id="deepseekModel">
                            <option value="deepseek-chat">DeepSeek Chat</option>
                            <option value="deepseek-reasoner">DeepSeek Reasoner</option>
                        </select>
                    </div>
                </div>
                
                <div class="settings-section model-section" id="openaiModels" style="display: none;">
                    <h3>OpenAI 模型</h3>
                    <div class="settings-item">
                        <label for="openaiModel">模型</label>
                        <select id="openaiModel">
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            <option value="gpt-4">GPT-4</option>
                            <option value="gpt-4-turbo">GPT-4 Turbo</option>
                        </select>
                    </div>
                    <div class="settings-item">
                        <label for="openaiEndpoint">API 终端</label>
                        <input type="text" id="openaiEndpoint" value="https://api.openai.com/v1/chat/completions" placeholder="OpenAI API 终端">
                    </div>
                </div>
                
                <div class="settings-section model-section" id="geminiModels" style="display: none;">
                    <h3>Google Gemini 模型</h3>
                    <div class="settings-item">
                        <label for="geminiModel">模型</label>
                        <select id="geminiModel">
                            <option value="gemini-pro">Gemini Pro</option>
                            <option value="gemini-ultra">Gemini Ultra</option>
                        </select>
                    </div>
                    <div class="settings-item">
                        <label for="geminiEndpoint">API 终端</label>
                        <input type="text" id="geminiEndpoint" value="https://generativelanguage.googleapis.com/v1beta/models/" placeholder="Gemini API 终端">
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>界面设置</h3>
                    <div class="settings-item">
                        <label for="uiTheme">界面主题</label>
                        <select id="uiTheme">
                            <option value="auto">自动 (跟随系统)</option>
                            <option value="light">浅色</option>
                            <option value="dark">深色</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" id="resetSettingsBtn">重置设置</button>
                <button class="btn primary" id="saveSettingsBtn">保存设置</button>
            </div>
        </div>
    </div>

    <!-- 添加Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // 添加API和模型配置变量
        let apiConfig = {
            provider: 'deepseek',
            key: '', // 已经设置为空
            models: {
                deepseek: {
                    current: 'deepseek-reasoner',
                    endpoint: 'https://api.deepseek.com/v1/chat/completions'
                },
                openai: {
                    current: 'gpt-3.5-turbo',
                    endpoint: 'https://api.openai.com/v1/chat/completions'
                },
                gemini: {
                    current: 'gemini-pro',
                    endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/'
                }
            },
            uiTheme: 'auto'
        };

        // 聊天记录
        let chatHistory = [];
        let currentChatId = 'chat-' + Date.now();
        let isWaitingForResponse = false;

        // 添加右键菜单相关变量
        let activeContextMenuChatId = null;
        const contextMenu = document.getElementById('contextMenu');

        // 初始化页面
        document.addEventListener('DOMContentLoaded', () => {
            loadChatHistory();
            document.getElementById('chatInput').focus();
            
            // 初始化温度滑块
            const temperatureSlider = document.getElementById('temperatureSlider');
            const temperatureValue = document.getElementById('temperatureValue');
            
            temperatureSlider.addEventListener('input', function() {
                temperatureValue.textContent = this.value;
            });
            
            // 添加模型切换事件
            const deepThinkToggle = document.getElementById('deepThinkToggle');
            const modelLabel = document.getElementById('modelLabel');
            
            deepThinkToggle.addEventListener('change', function() {
                if (this.checked) {
                    modelLabel.textContent = 'R1 (Reasoner)';
                } else {
                    modelLabel.textContent = 'V3 (Chat)';
                }
            });

            // 加载保存的设置
            loadSettings();
            
            // 设置按钮事件
            const settingsBtn = document.getElementById('settingsBtn');
            const settingsModal = document.getElementById('settingsModal');
            const closeSettingsBtn = document.getElementById('closeSettingsBtn');
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            const resetSettingsBtn = document.getElementById('resetSettingsBtn');
            const toggleApiKeyBtn = document.getElementById('toggleApiKey');
            const apiKeyInput = document.getElementById('apiKey');
            const apiProviderSelect = document.getElementById('apiProvider');
            
            // 打开设置
            settingsBtn.addEventListener('click', () => {
                openSettingsModal();
            });
            
            // 关闭设置
            closeSettingsBtn.addEventListener('click', () => {
                settingsModal.classList.remove('show');
            });
            
            // 点击外部关闭
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) {
                    settingsModal.classList.remove('show');
                }
            });
            
            // 切换API密钥可见性
            toggleApiKeyBtn.addEventListener('click', () => {
                if (apiKeyInput.type === 'password') {
                    apiKeyInput.type = 'text';
                    toggleApiKeyBtn.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <line x1="2" y1="2" x2="22" y2="22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    `;
                } else {
                    apiKeyInput.type = 'password';
                    toggleApiKeyBtn.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    `;
                }
            });
            
            // 切换API提供商
            apiProviderSelect.addEventListener('change', () => {
                updateModelSections(apiProviderSelect.value);
            });
            
            // 保存设置
            saveSettingsBtn.addEventListener('click', () => {
                saveApiSettings();
                settingsModal.classList.remove('show');
            });
            
            // 重置设置
            resetSettingsBtn.addEventListener('click', () => {
                resetSettings();
            });

            // 应用保存的主题
            setTheme(apiConfig.uiTheme || 'auto');
            
            // 监听系统主题变化（仅在auto模式下）
            if (window.matchMedia) {
                const colorSchemeQuery = window.matchMedia('(prefers-color-scheme: dark)');
                colorSchemeQuery.addEventListener('change', (e) => {
                    if (apiConfig.uiTheme === 'auto') {
                        setTheme('auto');
                    }
                });
            }
            
            // 主题切换按钮事件
            const themeToggleBtn = document.getElementById('themeToggleBtn');
            themeToggleBtn.addEventListener('click', () => {
                // 循环切换主题：auto -> light -> dark -> auto
                const currentTheme = apiConfig.uiTheme || 'auto';
                switch (currentTheme) {
                    case 'auto':
                        setTheme('light');
                        showToast('已切换到浅色主题');
                        break;
                    case 'light':
                        setTheme('dark');
                        showToast('已切换到深色主题');
                        break;
                    case 'dark':
                        setTheme('auto');
                        showToast('已切换到自动主题（跟随系统）');
                        break;
                }
            });

            // 初始化右键菜单事件
            initContextMenuEvents();

            // 搜索聊天记录
            initSearchFunction();
        });

        // 打开设置模态框并填充当前设置
        function openSettingsModal() {
            const settingsModal = document.getElementById('settingsModal');
            const apiKeyInput = document.getElementById('apiKey');
            const apiProviderSelect = document.getElementById('apiProvider');
            const deepseekModelSelect = document.getElementById('deepseekModel');
            const openaiModelSelect = document.getElementById('openaiModel');
            const geminiModelSelect = document.getElementById('geminiModel');
            const openaiEndpointInput = document.getElementById('openaiEndpoint');
            const geminiEndpointInput = document.getElementById('geminiEndpoint');
            const uiThemeSelect = document.getElementById('uiTheme');
            
            // 填充当前设置
            apiKeyInput.value = apiConfig.key;
            apiProviderSelect.value = apiConfig.provider;
            deepseekModelSelect.value = apiConfig.models.deepseek.current;
            openaiModelSelect.value = apiConfig.models.openai.current;
            geminiModelSelect.value = apiConfig.models.gemini.current;
            openaiEndpointInput.value = apiConfig.models.openai.endpoint;
            geminiEndpointInput.value = apiConfig.models.gemini.endpoint;
            uiThemeSelect.value = apiConfig.uiTheme || 'auto';
            
            // 显示对应的模型设置区域
            updateModelSections(apiConfig.provider);
            
            // 显示模态框
            settingsModal.classList.add('show');
        }
        
        // 更新模型区域显示
        function updateModelSections(provider) {
            const deepseekModels = document.getElementById('deepseekModels');
            const openaiModels = document.getElementById('openaiModels');
            const geminiModels = document.getElementById('geminiModels');
            
            // 隐藏所有模型区域
            deepseekModels.style.display = 'none';
            openaiModels.style.display = 'none';
            geminiModels.style.display = 'none';
            
            // 显示选中的提供商的模型区域
            switch (provider) {
                case 'deepseek':
                    deepseekModels.style.display = 'block';
                    break;
                case 'openai':
                    openaiModels.style.display = 'block';
                    break;
                case 'gemini':
                    geminiModels.style.display = 'block';
                    break;
            }
        }
        
        // 保存API设置
        function saveApiSettings() {
            const apiKeyInput = document.getElementById('apiKey');
            const apiProviderSelect = document.getElementById('apiProvider');
            const deepseekModelSelect = document.getElementById('deepseekModel');
            const openaiModelSelect = document.getElementById('openaiModel');
            const geminiModelSelect = document.getElementById('geminiModel');
            const openaiEndpointInput = document.getElementById('openaiEndpoint');
            const geminiEndpointInput = document.getElementById('geminiEndpoint');
            const uiThemeSelect = document.getElementById('uiTheme');
            
            // 更新配置
            apiConfig.key = apiKeyInput.value;
            apiConfig.provider = apiProviderSelect.value;
            apiConfig.models.deepseek.current = deepseekModelSelect.value;
            apiConfig.models.openai.current = openaiModelSelect.value;
            apiConfig.models.gemini.current = geminiModelSelect.value;
            apiConfig.models.openai.endpoint = openaiEndpointInput.value;
            apiConfig.models.gemini.endpoint = geminiEndpointInput.value;
            apiConfig.uiTheme = uiThemeSelect.value;
            
            // 保存到localStorage
            localStorage.setItem('apiConfig', JSON.stringify(apiConfig));
            
            // 更新UI
            updateUIForProvider();
            
            // 应用主题设置
            setTheme(apiConfig.uiTheme);
            
            // 显示保存成功消息
            showToast('设置保存成功');
        }
        
        // 重置设置
        function resetSettings() {
            // 默认设置
            apiConfig = {
                provider: 'deepseek',
                key: 'sk-446c8fb1e0db45d89c0d6c9fd4f959e8',
                models: {
                    deepseek: {
                        current: 'deepseek-reasoner',
                        endpoint: 'https://api.deepseek.com/v1/chat/completions'
                    },
                    openai: {
                        current: 'gpt-3.5-turbo',
                        endpoint: 'https://api.openai.com/v1/chat/completions'
                    },
                    gemini: {
                        current: 'gemini-pro',
                        endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/'
                    }
                },
                uiTheme: 'auto'
            };
            
            // 更新设置UI
            openSettingsModal();
            
            // 保存到localStorage
            localStorage.setItem('apiConfig', JSON.stringify(apiConfig));
            
            // 显示重置成功消息
            showToast('设置已重置为默认值');
        }
        
        // 加载保存的设置
        function loadSettings() {
            const savedConfig = localStorage.getItem('apiConfig');
            if (savedConfig) {
                try {
                    const parsedConfig = JSON.parse(savedConfig);
                    apiConfig = { ...apiConfig, ...parsedConfig };
                    
                    // 确保所有必要的字段都存在
                    if (!apiConfig.models) {
                        apiConfig.models = {
                            deepseek: {
                                current: 'deepseek-reasoner',
                                endpoint: 'https://api.deepseek.com/v1/chat/completions'
                            },
                            openai: {
                                current: 'gpt-3.5-turbo',
                                endpoint: 'https://api.openai.com/v1/chat/completions'
                            },
                            gemini: {
                                current: 'gemini-pro',
                                endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/'
                            }
                        };
                    }
                    
                    // 更新UI
                    updateUIForProvider();
                } catch (e) {
                    console.error('加载设置出错:', e);
                }
            }
        }
        
        // 根据API提供商更新UI
        function updateUIForProvider() {
            const modelLabel = document.getElementById('modelLabel');
            const deepThinkToggle = document.getElementById('deepThinkToggle');
            
            // 根据当前提供商和模型更新UI
            switch (apiConfig.provider) {
                case 'deepseek':
                    // 更新设置标签
                    if (apiConfig.models.deepseek.current === 'deepseek-reasoner') {
                        modelLabel.textContent = 'R1 (Reasoner)';
                        deepThinkToggle.checked = true;
                    } else {
                        modelLabel.textContent = 'V3 (Chat)';
                        deepThinkToggle.checked = false;
                    }
                    break;
                case 'openai':
                    modelLabel.textContent = apiConfig.models.openai.current;
                    // 禁用Reasoner特定功能
                    document.getElementById('showThinkingToggle').disabled = true;
                    break;
                case 'gemini':
                    modelLabel.textContent = apiConfig.models.gemini.current;
                    // 禁用Reasoner特定功能
                    document.getElementById('showThinkingToggle').disabled = true;
                    break;
            }
        }
        
        // 显示提示消息
        function showToast(message, duration = 3000) {
            // 检查是否已存在toast元素
            let toast = document.getElementById('toast');
            if (!toast) {
                // 创建新的toast元素
                toast = document.createElement('div');
                toast.id = 'toast';
                toast.className = 'toast';
                document.body.appendChild(toast);
            }
            
            // 设置消息并显示
            toast.textContent = message;
            toast.classList.add('show');
            
            // 设置自动消失
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        // 发送消息函数修改
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendButton');
            const message = input.value.trim();
            
            if (!message || isWaitingForResponse) return;

            // 检查是否有API密钥
            if (!apiConfig.key) {
                showToast('请先设置API密钥');
                addApiKeyButton(); // 确保按钮可见
                openSettingsModal(); // 直接打开设置页面
                return;
            }

            // 获取当前设置
            const deepThinking = document.getElementById('deepThinkToggle').checked;
            const showThinking = document.getElementById('showThinkingToggle').checked;
            const temperature = parseFloat(document.getElementById('temperatureSlider').value);

            // 添加用户消息
            const timestamp = new Date();
            addMessage(message, 'user', timestamp);
            input.value = '';
            
            // 更新聊天历史
            chatHistory.push({
                role: 'user',
                content: message,
                timestamp: timestamp.toISOString()
            });

            // 显示loading状态
            isWaitingForResponse = true;
            sendBtn.disabled = true;
            showTypingIndicator();

            try {
                let apiEndpoint, modelName, requestBody, headers;
                
                // 根据当前提供商设置API参数
                switch (apiConfig.provider) {
                    case 'deepseek':
                        apiEndpoint = apiConfig.models.deepseek.endpoint;
                        modelName = deepThinking ? 'deepseek-reasoner' : 'deepseek-chat';
                        requestBody = {
                            model: modelName,
                            messages: formatMessagesForAPI(),
                            temperature: temperature
                        };
                        
                        // 流式响应设置
                        if (showThinking) {
                            requestBody.stream = true;
                        }
                        
                        headers = {
                        'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiConfig.key}`
                        };
                        break;
                        
                    case 'openai':
                        apiEndpoint = apiConfig.models.openai.endpoint;
                        modelName = apiConfig.models.openai.current;
                        requestBody = {
                            model: modelName,
                            messages: formatMessagesForAPI(),
                            temperature: temperature
                        };
                        
                        // 流式响应设置
                        if (showThinking) {
                            requestBody.stream = true;
                        }
                        
                        headers = {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiConfig.key}`
                        };
                        break;
                        
                    case 'gemini':
                        modelName = apiConfig.models.gemini.current;
                        apiEndpoint = `${apiConfig.models.gemini.endpoint}${modelName}:generateContent`;
                        
                        // Gemini API使用不同的请求格式
                        requestBody = {
                            contents: formatMessagesForAPI().map(msg => ({
                                role: msg.role === 'user' ? 'user' : 'model',
                                parts: [{ text: msg.content }]
                            })),
                            generationConfig: {
                                temperature: temperature
                            }
                        };
                        
                        headers = {
                            'Content-Type': 'application/json',
                            'x-goog-api-key': apiConfig.key
                        };
                        break;
                        
                    default:
                        throw new Error('不支持的API提供商');
                }
                
                console.log(`使用${apiConfig.provider}的${modelName}模型发送请求`);
                console.log("请求体:", requestBody);
                
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestBody)
                });

                hideTypingIndicator();

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error("API错误详情:", errorData);
                    throw new Error(`API请求失败: ${response.status} - ${errorData.error?.message || '未知错误'}`);
                }

                let aiResponse = '';

                // 处理流式响应
                if (showThinking && response.body) {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder("utf-8");
                    
                    // 创建思考过程元素 - 使用模拟思考过程
                    const thinkingTimestamp = new Date();
                    const thinkingId = 'thinking-' + Date.now();
                    
                    // 仅当使用 Reasoner 模型时显示思考过程
                    if (deepThinking) {
                        addThinkingElement(thinkingId, thinkingTimestamp);
                        updateThinkingElement(thinkingId, deepThinking ? 
                            "R1 模型思考中...\n分析问题..." : 
                            "V3 模型生成回复...");
                    }
                    
                    let buffer = '';
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        
                        if (done) {
                            break;
                        }
                        
                        // 解析响应块
                        const chunk = decoder.decode(value, { stream: true });
                        buffer += chunk;
                        
                        // 尝试解析完整的JSON对象
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || ''; // 最后一行可能不完整
                        
                        for (const line of lines) {
                            if (line.trim() === '') continue;
                            
                            if (line.startsWith('data:')) {
                                const data = line.slice(5).trim();
                                
                                try {
                                    if (data === '[DONE]') {
                                        continue;
                                    }
                                    
                                    const parsedData = JSON.parse(data);
                                    
                                    // 检查是否有思考过程 (针对 reasoner 模型)
                                    if (parsedData.thinking && deepThinking) {
                                        updateThinkingElement(thinkingId, parsedData.thinking);
                                    }
                                    
                                    // 流式响应处理
                                    if (parsedData.choices && parsedData.choices[0].delta) {
                                        const content = parsedData.choices[0].delta.content || '';
                                        aiResponse += content;
                                        
                                        // 如果是 Reasoner 模型，更新思考过程
                                        if (deepThinking && aiResponse.length % 20 === 0) {
                                            updateThinkingElement(thinkingId, 
                                                "分析问题中...\n正在思考...\n\n生成回答: " + aiResponse);
                                        }
                                    }
                                } catch (e) {
                                    console.error('解析响应时出错:', e, data);
                                }
                            }
                        }
                    }
                    
                    // 等待一小段时间后移除思考元素，显示完整回复
                    if (deepThinking) {
                        setTimeout(() => {
                            if (document.getElementById(thinkingId)) {
                                document.getElementById(thinkingId).remove();
                            }
                
                // 添加AI回复
                            addCompletedResponse(aiResponse);
                        }, 1500);
                    } else {
                        // 对于V3模型，直接显示回复
                        addCompletedResponse(aiResponse);
                    }
                    
                } else {
                    // 处理常规响应
                const data = await response.json();
                    aiResponse = data.choices[0].message.content;
                
                // 添加AI回复
                    addCompletedResponse(aiResponse);
                }

            } catch (error) {
                hideTypingIndicator();
                addMessage(`很抱歉，发生了一个错误: ${error.message}`, 'ai', new Date());
                console.error('API错误:', error);
            } finally {
                isWaitingForResponse = false;
                sendBtn.disabled = false;
            }
        }

        // 修改添加消息的函数，支持Markdown
        function addMessage(content, type, timestamp) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            // 添加发送者信息
            const headerDiv = document.createElement('div');
            headerDiv.className = 'message-header';
            
            if (type === 'user') {
                headerDiv.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2"/>
                        <path d="M8 14.5C8 14.5 9.5 16.5 12 16.5C14.5 16.5 16 14.5 16 14.5" stroke="white" stroke-width="2" stroke-linecap="round"/>
                        <circle cx="9" cy="10" r="1.5" fill="white"/>
                        <circle cx="15" cy="10" r="1.5" fill="white"/>
                    </svg>
                    我
                `;
            } else {
                headerDiv.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" stroke="#4a90e2" stroke-width="2"/>
                        <path d="M12 7V12L15 15" stroke="#4a90e2" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    DeepSeek AI
                `;
            }
            
            messageDiv.appendChild(headerDiv);
            
            // 添加消息内容 - 支持Markdown
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (type === 'ai') {
                // 为AI消息应用Markdown解析
                const processedContent = processMarkdownContent(content);
                contentDiv.innerHTML = processedContent;
            } else {
                // 用户消息仅支持基础文本格式
                contentDiv.style.whiteSpace = 'pre-wrap';
                contentDiv.textContent = content;
            }
            
            messageDiv.appendChild(contentDiv);
            
            // 添加时间戳
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = formatTime(timestamp);
            messageDiv.appendChild(timeDiv);
            
            messagesDiv.appendChild(messageDiv);
            scrollToBottom();
        }

        // 修改processMarkdownContent函数，为代码块添加复制按钮
        function processMarkdownContent(content) {
            // 配置marked选项
            marked.setOptions({
                breaks: true,
                gfm: true,
                headerIds: false,
                mangle: false,
                sanitize: false,
                smartLists: true,
                smartypants: true,
                highlight: function(code, lang) {
                    return code;
                }
            });
            
            // 解析为Markdown
            let htmlContent = marked.parse(content);
            
            // 为所有代码块添加复制按钮
            // 使用DOM操作而不是直接字符串替换，以便更准确地处理代码块
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            
            // 查找所有pre>code元素
            const codeBlocks = tempDiv.querySelectorAll('pre > code');
            codeBlocks.forEach((codeBlock, index) => {
                // 获取代码内容
                const code = codeBlock.textContent;
                
                // 创建包装容器使按钮定位更容易
                const wrapper = document.createElement('div');
                wrapper.className = 'code-block-wrapper';
                
                // 创建复制按钮
                const copyButton = document.createElement('button');
                copyButton.className = 'copy-code-button';
                copyButton.setAttribute('data-code-index', index);
                copyButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path>
                    </svg>
                `;
                
                // 获取代码块父元素(pre)
                const preElement = codeBlock.parentNode;
                
                // 创建包装容器并添加复制按钮和原pre元素
                wrapper.appendChild(copyButton);
                
                // 将pre元素替换为包装容器
                preElement.parentNode.insertBefore(wrapper, preElement);
                wrapper.appendChild(preElement);
            });
            
            // 返回修改后的HTML
            return tempDiv.innerHTML;
        }

        // 添加复制代码功能
        document.addEventListener('click', function(e) {
            // 检查是否点击了复制按钮
            if (e.target.closest('.copy-code-button')) {
                const button = e.target.closest('.copy-code-button');
                // 获取对应的代码块
                const codeBlock = button.closest('.code-block-wrapper').querySelector('pre > code');
                const codeText = codeBlock.textContent;
                
                // 复制到剪贴板
                navigator.clipboard.writeText(codeText).then(() => {
                    // 显示成功反馈
                    button.classList.add('copied');
                    button.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    `;
                    
                    // 2秒后恢复原始图标
                    setTimeout(() => {
                        button.classList.remove('copied');
                        button.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path>
                            </svg>
                        `;
                    }, 2000);
                }).catch(err => {
                    console.error('无法复制文本: ', err);
                    // 显示错误反馈
                    showToast('复制失败，请手动复制');
                });
            }
        });

        // 在addCompletedResponse函数中添加markdown支持
        function addCompletedResponse(response) {
            const aiTimestamp = new Date();
            addMessage(response, 'ai', aiTimestamp);
            
            // 保存到历史记录
            chatHistory.push({
                role: 'assistant',
                content: response,
                timestamp: aiTimestamp.toISOString()
            });
            
            saveChatHistory();
            updateChatList();
        }

        function addThinkingElement(id, timestamp) {
            const messagesDiv = document.getElementById('chatMessages');
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'message ai-thinking';
            thinkingDiv.id = id;
            
            // 添加头部信息
            const thinkingHeader = document.createElement('div');
            thinkingHeader.className = 'thinking-header';
            thinkingHeader.innerHTML = `
                <div>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2" stroke="#4a90e2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    思考过程
                </div>
                <div>${formatTime(timestamp)}</div>
            `;
            thinkingDiv.appendChild(thinkingHeader);
            
            // 添加思考内容容器
            const contentDiv = document.createElement('div');
            contentDiv.style.whiteSpace = 'pre-wrap';
            contentDiv.textContent = '思考中...';
            thinkingDiv.appendChild(contentDiv);
            
            messagesDiv.appendChild(thinkingDiv);
            scrollToBottom();
        }
        
        function updateThinkingElement(id, content) {
            const thinkingDiv = document.getElementById(id);
            if (thinkingDiv) {
                const contentDiv = thinkingDiv.querySelector('div:nth-child(2)');
                if (contentDiv) {
                    contentDiv.textContent = content;
                    scrollToBottom();
                }
            }
        }

        function formatTime(date) {
            const now = new Date();
            const isToday = now.toDateString() === date.toDateString();
            
            if (isToday) {
                return '今天 ' + date.toLocaleTimeString('zh-CN', {hour: '2-digit', minute:'2-digit'});
            } else {
                return date.toLocaleDateString('zh-CN') + ' ' + 
                       date.toLocaleTimeString('zh-CN', {hour: '2-digit', minute:'2-digit'});
            }
        }

        function formatMessagesForAPI() {
            // 获取最近的对话
            let messages = chatHistory.slice(-20);
            const deepThinking = document.getElementById('deepThinkToggle').checked;
            
            // 如果使用 Reasoner 模型，需要确保交替的消息序列
            if (deepThinking) {
                // 确保第一条消息是用户消息
                while (messages.length > 0 && messages[0].role !== 'user') {
                    messages.shift();
                }
                
                // 如果没有用户消息，返回空数组
                if (messages.length === 0) {
                    return [];
                }
                
                // 处理连续的相同角色消息，确保交替出现
                const cleanedMessages = [];
                let lastRole = null;
                
                for (const msg of messages) {
                    // 如果当前消息角色与上一个不同，或者是第一条消息，则添加
                    if (msg.role !== lastRole) {
                        cleanedMessages.push(msg);
                        lastRole = msg.role;
                    } else {
                        // 如果连续相同角色，替换上一条消息
                        cleanedMessages[cleanedMessages.length - 1] = msg;
                    }
                }
                
                // 确保整个对话历史是交替的 user -> assistant -> user -> assistant...
                const finalMessages = [];
                let expectedRole = 'user'; // 期望的第一个角色
                
                for (const msg of cleanedMessages) {
                    if (msg.role === expectedRole) {
                        finalMessages.push(msg);
                        // 切换下一个期望角色
                        expectedRole = expectedRole === 'user' ? 'assistant' : 'user';
                    } else {
                        // 角色不符合预期，发生了连续相同角色的情况
                        // 跳过到下一个期望角色
                        if (finalMessages.length > 0) {
                            finalMessages.push(msg);
                            expectedRole = 'user'; // 重置期望
                        }
                    }
                }
                
                console.log("原始消息:", messages.map(m => m.role).join(', '));
                console.log("处理后消息:", finalMessages.map(m => m.role).join(', '));
                
                // 转换为API格式
                return finalMessages.map(msg => ({
                    role: msg.role,
                    content: msg.content
                }));
            } else {
                // 对于 Chat 模型，不需要严格交替，直接返回所有消息
                return messages.map(msg => ({
                    role: msg.role,
                    content: msg.content
                }));
            }
        }

        function showTypingIndicator() {
            const messagesDiv = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai-message typing-indicator';
            typingDiv.id = 'typingIndicator';
            
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('div');
                dot.className = 'typing-dot';
                typingDiv.appendChild(dot);
            }
            
            messagesDiv.appendChild(typingDiv);
            scrollToBottom();
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function scrollToBottom() {
            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function saveChatHistory() {
            // 将当前对话保存到localStorage
            const chatData = {
                id: currentChatId,
                title: getChatTitle(),
                messages: chatHistory,
                lastUpdated: new Date().toISOString()
            };
            
            // 获取所有对话
            let allChats = JSON.parse(localStorage.getItem('allChats') || '[]');
            
            // 更新或添加当前对话
            const existingChatIndex = allChats.findIndex(chat => chat.id === currentChatId);
            if (existingChatIndex >= 0) {
                allChats[existingChatIndex] = chatData;
            } else {
                allChats.push(chatData);
            }
            
            // 保存回localStorage
            localStorage.setItem('allChats', JSON.stringify(allChats));
            localStorage.setItem('currentChatId', currentChatId);
        }

        function getChatTitle() {
            // 使用第一条用户消息作为标题
            const firstUserMessage = chatHistory.find(msg => msg.role === 'user');
            if (firstUserMessage) {
                // 截取前20个字符作为标题
                let title = firstUserMessage.content.substring(0, 20);
                if (firstUserMessage.content.length > 20) {
                    title += '...';
                }
                return title;
            }
            return '新对话';
        }

        function loadChatHistory() {
            // 从localStorage加载对话历史
            const allChats = JSON.parse(localStorage.getItem('allChats') || '[]');
            currentChatId = localStorage.getItem('currentChatId');
            
            // 如果没有当前对话或当前对话不存在，创建新对话
            if (!currentChatId || !allChats.find(chat => chat.id === currentChatId)) {
                startNewChat();
                return;
            }
            
            // 加载当前对话
            const currentChat = allChats.find(chat => chat.id === currentChatId);
            chatHistory = currentChat.messages || [];
            
            // 渲染消息
            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.innerHTML = ''; // 清空现有消息
            
            // 如果历史为空，显示欢迎消息
            if (chatHistory.length === 0) {
                displayWelcomeMessage();
            } else {
                // 显示历史消息
                chatHistory.forEach(msg => {
                    const type = msg.role === 'user' ? 'user' : 'ai';
                    addMessage(msg.content, type, new Date(msg.timestamp));
                });
            }
            
            // 更新聊天列表
            updateChatList();
        }

        function updateChatList() {
            // 更新侧边栏的聊天列表
            const allChats = JSON.parse(localStorage.getItem('allChats') || '[]');
            const chatListDiv = document.querySelector('.chat-list');
            
            // 保留头部
            const headerDiv = chatListDiv.querySelector('.chat-list-header');
            chatListDiv.innerHTML = '';
            chatListDiv.appendChild(headerDiv);
            
            // 按最后更新时间排序（最新的在前面）
            allChats.sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated));
            
            // 添加所有对话
            allChats.forEach(chat => {
                const chatItemDiv = document.createElement('div');
                chatItemDiv.className = `chat-item ${chat.id === currentChatId ? 'active' : ''}`;
                chatItemDiv.dataset.chatId = chat.id;
                chatItemDiv.innerHTML = `
                    <span class="chat-icon">💬</span>
                    <span class="chat-title">${chat.title}</span>
                `;
                
                // 添加点击事件
                chatItemDiv.addEventListener('click', () => loadChat(chat.id));
                
                // 添加右键菜单事件
                chatItemDiv.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    showContextMenu(e, chat.id);
                });
                
                chatListDiv.appendChild(chatItemDiv);
            });
        }

        function loadChat(chatId) {
            // 加载特定对话
            currentChatId = chatId;
            localStorage.setItem('currentChatId', chatId);
            loadChatHistory();
        }

        function startNewChat() {
            // 创建新对话
            currentChatId = 'chat-' + Date.now();
            chatHistory = [];
            
            // 显示欢迎消息，但不加入到历史记录
            displayWelcomeMessage();
            
            // 保存新的空对话
            saveChatHistory();
            updateChatList();
            
            // 聚焦输入框
            document.getElementById('chatInput').focus();
        }

        // 回车发送消息
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // 辅助函数：添加完整的AI响应
        function addCompletedResponse(response) {
            const aiTimestamp = new Date();
            addMessage(response, 'ai', aiTimestamp);
            
            // 保存到历史记录
            chatHistory.push({
                role: 'assistant',
                content: response,
                timestamp: aiTimestamp.toISOString()
            });
            
            saveChatHistory();
            updateChatList();
        }

        // 在UI显示欢迎消息，但不记录到聊天历史
        function displayWelcomeMessage() {
            const welcomeTimestamp = new Date();
            const messagesDiv = document.getElementById('chatMessages');
            
            // 清空消息区域
            messagesDiv.innerHTML = '';
            
            // 添加欢迎消息到UI
            const messageText = apiConfig.key ? 
                '您好！我是DeepSeek人工智能助手，有什么可以帮您的？' : 
                '您好！在开始使用DeepSeek人工智能助手前，请先设置API密钥。';
            
            addMessage(messageText, 'ai', welcomeTimestamp);
            
            // 如果没有API密钥，显示设置按钮
            if (!apiConfig.key) {
                addApiKeyButton();
            }
        }

        // 主题相关函数
        function setTheme(theme) {
            const darkIcon = document.getElementById('darkIcon');
            const lightIcon = document.getElementById('lightIcon');
            
            if (theme === 'auto') {
                // 检测系统主题偏好
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    darkIcon.style.display = 'none';
                    lightIcon.style.display = 'block';
                } else {
                    document.documentElement.setAttribute('data-theme', 'light');
                    darkIcon.style.display = 'block';
                    lightIcon.style.display = 'none';
                }
            } else {
                document.documentElement.setAttribute('data-theme', theme);
                if (theme === 'dark') {
                    darkIcon.style.display = 'none';
                    lightIcon.style.display = 'block';
                } else {
                    darkIcon.style.display = 'block';
                    lightIcon.style.display = 'none';
                }
            }
            
            // 保存主题设置
            apiConfig.uiTheme = theme;
            localStorage.setItem('apiConfig', JSON.stringify(apiConfig));
        }

        // 显示右键菜单
        function showContextMenu(event, chatId) {
            event.preventDefault();
            
            // 保存当前被操作的聊天ID
            activeContextMenuChatId = chatId;
            
            // 定位菜单到鼠标位置
            const menu = document.getElementById('contextMenu');
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
            
            // 显示菜单
            menu.classList.add('show');
            
            // 添加点击其他区域关闭菜单的事件
            setTimeout(() => {
                document.addEventListener('click', closeContextMenu);
            }, 100);
        }

        // 关闭右键菜单
        function closeContextMenu() {
            const menu = document.getElementById('contextMenu');
            menu.classList.remove('show');
            document.removeEventListener('click', closeContextMenu);
        }

        // 初始化右键菜单项点击事件
        function initContextMenuEvents() {
            // 重命名对话
            document.getElementById('menuRename').addEventListener('click', function() {
                const allChats = JSON.parse(localStorage.getItem('allChats') || '[]');
                const chat = allChats.find(c => c.id === activeContextMenuChatId);
                
                if (chat) {
                    const chatItem = document.querySelector(`.chat-item[data-chat-id="${activeContextMenuChatId}"]`);
                    const titleSpan = chatItem.querySelector('.chat-title');
                    const oldTitle = titleSpan.textContent;
                    
                    // 创建输入框来重命名
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'rename-input';
                    input.value = oldTitle;
                    
                    titleSpan.replaceWith(input);
                    input.focus();
                    input.select();
                    
                    // 处理输入完成
                    function completeRename() {
                        const newTitle = input.value.trim() || oldTitle;
                        const newTitleSpan = document.createElement('span');
                        newTitleSpan.className = 'chat-title';
                        newTitleSpan.textContent = newTitle;
                        input.replaceWith(newTitleSpan);
                        
                        // 更新存储
                        chat.title = newTitle;
                        localStorage.setItem('allChats', JSON.stringify(allChats));
                    }
                    
                    input.addEventListener('blur', completeRename);
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            completeRename();
                        }
                    });
                }
            });
            
            // 复制对话
            document.getElementById('menuDuplicate').addEventListener('click', function() {
                const allChats = JSON.parse(localStorage.getItem('allChats') || '[]');
                const chat = allChats.find(c => c.id === activeContextMenuChatId);
                
                if (chat) {
                    // 创建新的对话副本
                    const newChat = {
                        ...chat,
                        id: 'chat-' + Date.now(),
                        title: chat.title + ' (副本)',
                        lastUpdated: new Date().toISOString()
                    };
                    
                    allChats.push(newChat);
                    localStorage.setItem('allChats', JSON.stringify(allChats));
                    updateChatList();
                    showToast('对话已复制');
                }
            });
            
            // 导出对话
            document.getElementById('menuExport').addEventListener('click', function() {
                const allChats = JSON.parse(localStorage.getItem('allChats') || '[]');
                const chat = allChats.find(c => c.id === activeContextMenuChatId);
                
                if (chat) {
                    // 创建要导出的数据对象
                    const exportData = {
                        title: chat.title,
                        messages: chat.messages,
                        exportDate: new Date().toISOString()
                    };
                    
                    // 转换为JSON字符串
                    const jsonStr = JSON.stringify(exportData, null, 2);
                    const blob = new Blob([jsonStr], { type: 'application/json' });
                    
                    // 创建下载链接
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${chat.title.replace(/[^\w\s]/gi, '_')}_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    
                    // 清理
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                    
                    showToast('对话已导出');
                }
            });
            
            // 删除对话
            document.getElementById('menuDelete').addEventListener('click', function() {
                if (confirm('确定要删除这个对话吗？此操作不可撤销。')) {
                    let allChats = JSON.parse(localStorage.getItem('allChats') || '[]');
                    allChats = allChats.filter(c => c.id !== activeContextMenuChatId);
                    
                    localStorage.setItem('allChats', JSON.stringify(allChats));
                    
                    // 如果删除的是当前对话，创建新对话
                    if (currentChatId === activeContextMenuChatId) {
                        startNewChat();
                    } else {
                        updateChatList();
                    }
                    
                    showToast('对话已删除');
                }
            });
        }

        // 添加API设置按钮
        function addApiKeyButton() {
            const messagesDiv = document.getElementById('chatMessages');
            const lastMessage = messagesDiv.lastChild;
            
            if (lastMessage) {
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'api-key-notice';
                buttonContainer.innerHTML = `
                    <button class="setup-api-btn" onclick="openSettingsModal()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M21 10h-4.58l-2.56-2.56a1.94 1.94 0 0 0-1.37-.44H7a1.93 1.93 0 0 0-1.8 1.18L3 14v6a2 2 0 0 0 2 2h13a5 5 0 0 0 5-5v-5a2 2 0 0 0-2-2zM7 10a1 1 0 1 1 0-2 1 1 0 0 1 0 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        设置API密钥
                    </button>
                `;
                lastMessage.appendChild(buttonContainer);
            }
        }

        // 搜索聊天记录
        function initSearchFunction() {
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');
            
            // 搜索按钮点击事件
            searchBtn.addEventListener('click', performSearch);
            
            // 搜索框输入事件
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
                // 如果搜索框为空，恢复所有聊天显示
                if (this.value.trim() === '') {
                    updateChatList();
                }
            });
            
            // 搜索功能实现
            function performSearch() {
                const searchTerm = searchInput.value.trim().toLowerCase();
                if (!searchTerm) {
                    // 如果搜索词为空，显示所有聊天
                    updateChatList();
                    return;
                }
                
                // 获取所有聊天
                const allChats = JSON.parse(localStorage.getItem('allChats') || '[]');
                
                // 按关键词过滤
                const filteredChats = allChats.filter(chat => {
                    // 搜索标题
                    if (chat.title.toLowerCase().includes(searchTerm)) return true;
                    
                    // 搜索消息内容
                    return chat.messages.some(msg => 
                        msg.content.toLowerCase().includes(searchTerm)
                    );
                });
                
                // 更新聊天列表UI
                displayFilteredChats(filteredChats, searchTerm);
            }
            
            // 显示过滤后的聊天项
            function displayFilteredChats(chats, searchTerm) {
                const chatListDiv = document.querySelector('.chat-list');
                
                // 保留头部和搜索栏
                const headerDiv = chatListDiv.querySelector('.chat-list-header');
                const searchContainer = chatListDiv.querySelector('.search-container');
                
                // 清空当前聊天列表，但保留头部和搜索栏
                chatListDiv.innerHTML = '';
                chatListDiv.appendChild(headerDiv);
                chatListDiv.appendChild(searchContainer);
                
                // 搜索结果为空显示提示
                if (chats.length === 0) {
                    const noResults = document.createElement('div');
                    noResults.className = 'no-search-results';
                    noResults.innerHTML = `
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="8" y1="12" x2="16" y2="12"></line>
                        </svg>
                        <p>未找到包含"${searchTerm}"的对话</p>
                    `;
                    chatListDiv.appendChild(noResults);
                    return;
                }
                
                // 显示搜索结果数量
                const resultCount = document.createElement('div');
                resultCount.className = 'search-result-count';
                resultCount.textContent = `找到 ${chats.length} 条相关对话`;
                chatListDiv.appendChild(resultCount);
                
                // 添加过滤后的聊天项
                chats.forEach(chat => {
                    const chatItemDiv = document.createElement('div');
                    chatItemDiv.className = `chat-item ${chat.id === currentChatId ? 'active' : ''}`;
                    chatItemDiv.dataset.chatId = chat.id;
                    
                    // 高亮显示匹配的标题
                    let title = chat.title;
                    if (title.toLowerCase().includes(searchTerm)) {
                        const index = title.toLowerCase().indexOf(searchTerm);
                        title = title.substring(0, index) + 
                                `<span class="search-highlight">${title.substring(index, index + searchTerm.length)}</span>` + 
                                title.substring(index + searchTerm.length);
                    }
                    
                    chatItemDiv.innerHTML = `
                        <span class="chat-icon">💬</span>
                        <span class="chat-title">${title}</span>
                    `;
                    
                    // 添加点击事件
                    chatItemDiv.addEventListener('click', () => loadChat(chat.id));
                    
                    // 添加右键菜单事件
                    chatItemDiv.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        showContextMenu(e, chat.id);
                    });
                    
                    chatListDiv.appendChild(chatItemDiv);
                });
            }
        }

        // 在页面加载时初始化搜索功能
        document.addEventListener('DOMContentLoaded', () => {
            // ... 现有代码 ...
            
            // 初始化搜索功能
            initSearchFunction();
        });

        // 修改updateChatList函数，使其保留搜索栏
        function updateChatList() {
            // 更新侧边栏的聊天列表
            const allChats = JSON.parse(localStorage.getItem('allChats') || '[]');
            const chatListDiv = document.querySelector('.chat-list');
            
            // 保留头部
            const headerDiv = chatListDiv.querySelector('.chat-list-header');
            // 保留搜索栏
            const searchContainer = chatListDiv.querySelector('.search-container') || document.createElement('div');
            if (!searchContainer.classList.contains('search-container')) {
                searchContainer.className = 'search-container';
                searchContainer.innerHTML = `
                    <input type="text" id="searchInput" placeholder="搜索对话历史..." />
                    <button id="searchBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
                            <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                `;
                // 初始化搜索功能
                setTimeout(initSearchFunction, 0);
            }
            
            chatListDiv.innerHTML = '';
            chatListDiv.appendChild(headerDiv);
            chatListDiv.appendChild(searchContainer);
            
            // 按最后更新时间排序（最新的在前面）
            allChats.sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated));
            
            // 添加所有对话
            allChats.forEach(chat => {
                const chatItemDiv = document.createElement('div');
                chatItemDiv.className = `chat-item ${chat.id === currentChatId ? 'active' : ''}`;
                chatItemDiv.dataset.chatId = chat.id;
                chatItemDiv.innerHTML = `
                    <span class="chat-icon">💬</span>
                    <span class="chat-title">${chat.title}</span>
                `;
                
                // 添加点击事件
                chatItemDiv.addEventListener('click', () => loadChat(chat.id));
                
                // 添加右键菜单事件
                chatItemDiv.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    showContextMenu(e, chat.id);
                });
                
                chatListDiv.appendChild(chatItemDiv);
            });
        }

        // 在body标签开始后添加移动导航栏
        document.addEventListener('DOMContentLoaded', function() {
            // 只在小屏幕设备上添加移动导航栏
            if (window.innerWidth <= 768) {
                const mainContent = document.querySelector('.main-content');
                if (mainContent) {
                    const mobileNavbar = document.createElement('div');
                    mobileNavbar.className = 'mobile-navbar';
                    mobileNavbar.innerHTML = `
                        <button class="menu-toggle" id="mobileMenuToggle">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="3" y1="12" x2="21" y2="12"></line>
                                <line x1="3" y1="6" x2="21" y2="6"></line>
                                <line x1="3" y1="18" x2="21" y2="18"></line>
                            </svg>
                        </button>
                        <span>DeepSeek AI</span>
                        <div style="width: 24px;"></div>
                    `;
                    mainContent.insertBefore(mobileNavbar, mainContent.firstChild);
                }
                
                // 只在小屏幕设备上创建侧边栏遮罩层
                const overlay = document.createElement('div');
                overlay.className = 'sidebar-overlay';
                document.body.appendChild(overlay);
                
                // 添加侧边栏切换功能
                initMobileNavigation();
            }
            
            // 监听窗口大小变化，动态添加或移除移动导航栏
            window.addEventListener('resize', function() {
                const existingNavbar = document.querySelector('.mobile-navbar');
                const existingOverlay = document.querySelector('.sidebar-overlay');
                
                if (window.innerWidth <= 768) {
                    // 小屏幕设备，添加移动导航栏（如果不存在）
                    if (!existingNavbar) {
                        const mainContent = document.querySelector('.main-content');
                        if (mainContent) {
                            const mobileNavbar = document.createElement('div');
                            mobileNavbar.className = 'mobile-navbar';
                            mobileNavbar.innerHTML = `
                                <button class="menu-toggle" id="mobileMenuToggle">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="3" y1="12" x2="21" y2="12"></line>
                                        <line x1="3" y1="6" x2="21" y2="6"></line>
                                        <line x1="3" y1="18" x2="21" y2="18"></line>
                                    </svg>
                                </button>
                                <span>DeepSeek AI</span>
                                <div style="width: 24px;"></div>
                            `;
                            mainContent.insertBefore(mobileNavbar, mainContent.firstChild);
                        }
                        
                        // 添加遮罩层（如果不存在）
                        if (!existingOverlay) {
                            const overlay = document.createElement('div');
                            overlay.className = 'sidebar-overlay';
                            document.body.appendChild(overlay);
                        }
                        
                        // 初始化移动导航功能
                        initMobileNavigation();
                    }
                } else {
                    // 大屏幕设备，移除移动导航栏和遮罩层
                    if (existingNavbar) {
                        existingNavbar.remove();
                    }
                    if (existingOverlay) {
                        existingOverlay.remove();
                    }
                    
                    // 确保侧边栏可见且样式正确
                    const sidebar = document.querySelector('.sidebar');
                    if (sidebar) {
                        sidebar.classList.remove('show-mobile');
                        sidebar.style.left = '';
                    }
                    
                    // 重置body样式
                    document.body.style.overflow = '';
                }
            });
        });

        // 初始化移动导航功能
        function initMobileNavigation() {
            const menuToggle = document.getElementById('mobileMenuToggle');
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            if (!menuToggle || !sidebar || !overlay) return;
            
            // 点击菜单按钮显示侧边栏
            menuToggle.addEventListener('click', function() {
                sidebar.classList.toggle('show-mobile');
                overlay.classList.toggle('show');
                document.body.style.overflow = sidebar.classList.contains('show-mobile') ? 'hidden' : '';
            });
            
            // 点击遮罩层关闭侧边栏
            overlay.addEventListener('click', function() {
                sidebar.classList.remove('show-mobile');
                overlay.classList.remove('show');
                document.body.style.overflow = '';
            });
            
            // 点击侧边栏中的聊天项后关闭侧边栏
            const chatItems = document.querySelectorAll('.chat-item');
            chatItems.forEach(item => {
                item.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('show-mobile');
                        overlay.classList.remove('show');
                        document.body.style.overflow = '';
                    }
                });
            });
            
            // 监听窗口大小变化，在大屏幕下重置样式
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    sidebar.classList.remove('show-mobile');
                    overlay.classList.remove('show');
                    document.body.style.overflow = '';
                }
            });
        }

        // 修改现有的updateChatList函数，确保为新添加的聊天项添加事件监听器
        const originalUpdateChatList = updateChatList;
        updateChatList = function() {
            originalUpdateChatList.apply(this, arguments);
            
            // 为新添加的聊天项添加点击事件监听器
            if (window.innerWidth <= 768) {
                const chatItems = document.querySelectorAll('.chat-item');
                const sidebar = document.querySelector('.sidebar');
                const overlay = document.querySelector('.sidebar-overlay');
                
                chatItems.forEach(item => {
                    item.addEventListener('click', function() {
                        sidebar.classList.remove('show-mobile');
                        overlay.classList.remove('show');
                        document.body.style.overflow = '';
                    });
                });
            }
        };
    </script>
</body>
</html>